<!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/xhtml" lang="en" xml:lang="en"><head>

<meta charset="utf-8">
<meta name="generator" content="quarto-1.4.552">

<meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=yes">


<title>Telling Stories with Data - 15&nbsp; Causality from observational data</title>
<style>
code{white-space: pre-wrap;}
span.smallcaps{font-variant: small-caps;}
div.columns{display: flex; gap: min(4vw, 1.5em);}
div.column{flex: auto; overflow-x: auto;}
div.hanging-indent{margin-left: 1.5em; text-indent: -1.5em;}
ul.task-list{list-style: none;}
ul.task-list li input[type="checkbox"] {
  width: 0.8em;
  margin: 0 0.8em 0.2em -1em; /* quarto-specific, see https://github.com/quarto-dev/quarto-cli/issues/4556 */ 
  vertical-align: middle;
}
/* CSS for syntax highlighting */
pre > code.sourceCode { white-space: pre; position: relative; }
pre > code.sourceCode > span { line-height: 1.25; }
pre > code.sourceCode > span:empty { height: 1.2em; }
.sourceCode { overflow: visible; }
code.sourceCode > span { color: inherit; text-decoration: inherit; }
div.sourceCode { margin: 1em 0; }
pre.sourceCode { margin: 0; }
@media screen {
div.sourceCode { overflow: auto; }
}
@media print {
pre > code.sourceCode { white-space: pre-wrap; }
pre > code.sourceCode > span { text-indent: -5em; padding-left: 5em; }
}
pre.numberSource code
  { counter-reset: source-line 0; }
pre.numberSource code > span
  { position: relative; left: -4em; counter-increment: source-line; }
pre.numberSource code > span > a:first-child::before
  { content: counter(source-line);
    position: relative; left: -1em; text-align: right; vertical-align: baseline;
    border: none; display: inline-block;
    -webkit-touch-callout: none; -webkit-user-select: none;
    -khtml-user-select: none; -moz-user-select: none;
    -ms-user-select: none; user-select: none;
    padding: 0 4px; width: 4em;
  }
pre.numberSource { margin-left: 3em;  padding-left: 4px; }
div.sourceCode
  {   }
@media screen {
pre > code.sourceCode > span > a:first-child::before { text-decoration: underline; }
}
/* CSS for citations */
div.csl-bib-body { }
div.csl-entry {
  clear: both;
  margin-bottom: 0em;
}
.hanging-indent div.csl-entry {
  margin-left:2em;
  text-indent:-2em;
}
div.csl-left-margin {
  min-width:2em;
  float:left;
}
div.csl-right-inline {
  margin-left:2em;
  padding-left:1em;
}
div.csl-indent {
  margin-left: 2em;
}</style>


<script src="site_libs/quarto-nav/quarto-nav.js"></script>
<script src="site_libs/clipboard/clipboard.min.js"></script>
<script src="site_libs/quarto-search/autocomplete.umd.js"></script>
<script src="site_libs/quarto-search/fuse.min.js"></script>
<script src="site_libs/quarto-search/quarto-search.js"></script>
<meta name="quarto:offset" content="./">
<link href="./15-mrp.html" rel="next">
<link href="./13-prediction.html" rel="prev">
<script src="site_libs/quarto-html/quarto.js"></script>
<script src="site_libs/quarto-html/popper.min.js"></script>
<script src="site_libs/quarto-html/tippy.umd.min.js"></script>
<script src="site_libs/quarto-html/anchor.min.js"></script>
<link href="site_libs/quarto-html/tippy.css" rel="stylesheet">
<link href="site_libs/quarto-html/quarto-syntax-highlighting.css" rel="stylesheet" id="quarto-text-highlighting-styles">
<script src="site_libs/bootstrap/bootstrap.min.js"></script>
<link href="site_libs/bootstrap/bootstrap-icons.css" rel="stylesheet">
<link href="site_libs/bootstrap/bootstrap.min.css" rel="stylesheet" id="quarto-bootstrap" data-mode="light">
<script id="quarto-search-options" type="application/json">{
  "location": "sidebar",
  "copy-button": false,
  "collapse-after": 3,
  "panel-placement": "start",
  "type": "textbox",
  "limit": 50,
  "keyboard-shortcut": [
    "f",
    "/",
    "s"
  ],
  "show-item-context": false,
  "language": {
    "search-no-results-text": "No results",
    "search-matching-documents-text": "matching documents",
    "search-copy-link-title": "Copy link to search",
    "search-hide-matches-text": "Hide additional matches",
    "search-more-match-text": "more match in this document",
    "search-more-matches-text": "more matches in this document",
    "search-clear-button-title": "Clear",
    "search-text-placeholder": "",
    "search-detached-cancel-button-title": "Cancel",
    "search-submit-button-title": "Submit",
    "search-label": "Search"
  }
}</script>

  <script src="https://polyfill.io/v3/polyfill.min.js?features=es6"></script>
  <script src="https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-chtml-full.js" type="text/javascript"></script>

<script type="text/javascript">
const typesetMath = (el) => {
  if (window.MathJax) {
    // MathJax Typeset
    window.MathJax.typeset([el]);
  } else if (window.katex) {
    // KaTeX Render
    var mathElements = el.getElementsByClassName("math");
    var macros = [];
    for (var i = 0; i < mathElements.length; i++) {
      var texText = mathElements[i].firstChild;
      if (mathElements[i].tagName == "SPAN") {
        window.katex.render(texText.data, mathElements[i], {
          displayMode: mathElements[i].classList.contains('display'),
          throwOnError: false,
          macros: macros,
          fleqn: false
        });
      }
    }
  }
}
window.Quarto = {
  typesetMath
};
</script>

</head>

<body class="nav-sidebar floating">

<div id="quarto-search-results"></div>
  <header id="quarto-header" class="headroom fixed-top">
  <nav class="quarto-secondary-nav">
    <div class="container-fluid d-flex">
      <button type="button" class="quarto-btn-toggle btn" data-bs-toggle="collapse" data-bs-target=".quarto-sidebar-collapse-item" aria-controls="quarto-sidebar" aria-expanded="false" aria-label="Toggle sidebar navigation" onclick="if (window.quartoToggleHeadroom) { window.quartoToggleHeadroom(); }">
        <i class="bi bi-layout-text-sidebar-reverse"></i>
      </button>
        <nav class="quarto-page-breadcrumbs" aria-label="breadcrumb"><ol class="breadcrumb"><li class="breadcrumb-item"><a href="./14-causality_from_obs.html">Applications</a></li><li class="breadcrumb-item"><a href="./14-causality_from_obs.html"><span class="chapter-number">15</span>&nbsp; <span class="chapter-title">Causality from observational data</span></a></li></ol></nav>
        <a class="flex-grow-1" role="button" data-bs-toggle="collapse" data-bs-target=".quarto-sidebar-collapse-item" aria-controls="quarto-sidebar" aria-expanded="false" aria-label="Toggle sidebar navigation" onclick="if (window.quartoToggleHeadroom) { window.quartoToggleHeadroom(); }">      
        </a>
      <button type="button" class="btn quarto-search-button" aria-label="" onclick="window.quartoOpenSearch();">
        <i class="bi bi-search"></i>
      </button>
    </div>
  </nav>
</header>
<!-- content -->
<div id="quarto-content" class="quarto-container page-columns page-rows-contents page-layout-article">
<!-- sidebar -->
  <nav id="quarto-sidebar" class="sidebar collapse collapse-horizontal quarto-sidebar-collapse-item sidebar-navigation floating overflow-auto">
    <div class="pt-lg-2 mt-2 text-left sidebar-header">
    <div class="sidebar-title mb-0 py-0">
      <a href="./">Telling Stories with Data</a> 
        <div class="sidebar-tools-main">
    <a href="https://github.com/RohanAlexander/telling_stories/" title="Source Code" class="quarto-navigation-tool px-1" aria-label="Source Code"><i class="bi bi-github"></i></a>
</div>
    </div>
      </div>
        <div class="mt-2 flex-shrink-0 align-items-center">
        <div class="sidebar-search">
        <div id="quarto-search" class="" title="Search"></div>
        </div>
        </div>
    <div class="sidebar-menu-container"> 
    <ul class="list-unstyled mt-1">
        <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./index.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">Preface</span></a>
  </div>
</li>
        <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./errata.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">Errors and updates</span></a>
  </div>
</li>
        <li class="sidebar-item sidebar-item-section">
      <div class="sidebar-item-container"> 
            <a class="sidebar-item-text sidebar-link text-start" data-bs-toggle="collapse" data-bs-target="#quarto-sidebar-section-1" aria-expanded="true">
 <span class="menu-text">Foundations</span></a>
          <a class="sidebar-item-toggle text-start" data-bs-toggle="collapse" data-bs-target="#quarto-sidebar-section-1" aria-expanded="true" aria-label="Toggle section">
            <i class="bi bi-chevron-right ms-2"></i>
          </a> 
      </div>
      <ul id="quarto-sidebar-section-1" class="collapse list-unstyled sidebar-section depth1 show">  
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./01-introduction.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">1</span>&nbsp; <span class="chapter-title">Telling stories with data</span></span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./02-drinking_from_a_fire_hose.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">2</span>&nbsp; <span class="chapter-title">Drinking from a fire hose</span></span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./03-workflow.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">3</span>&nbsp; <span class="chapter-title">Reproducible workflows</span></span></a>
  </div>
</li>
      </ul>
  </li>
        <li class="sidebar-item sidebar-item-section">
      <div class="sidebar-item-container"> 
            <a class="sidebar-item-text sidebar-link text-start" data-bs-toggle="collapse" data-bs-target="#quarto-sidebar-section-2" aria-expanded="true">
 <span class="menu-text">Communication</span></a>
          <a class="sidebar-item-toggle text-start" data-bs-toggle="collapse" data-bs-target="#quarto-sidebar-section-2" aria-expanded="true" aria-label="Toggle section">
            <i class="bi bi-chevron-right ms-2"></i>
          </a> 
      </div>
      <ul id="quarto-sidebar-section-2" class="collapse list-unstyled sidebar-section depth1 show">  
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./04-writing_research.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">4</span>&nbsp; <span class="chapter-title">Writing research</span></span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./05-static_communication.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">5</span>&nbsp; <span class="chapter-title">Static communication</span></span></a>
  </div>
</li>
      </ul>
  </li>
        <li class="sidebar-item sidebar-item-section">
      <div class="sidebar-item-container"> 
            <a class="sidebar-item-text sidebar-link text-start" data-bs-toggle="collapse" data-bs-target="#quarto-sidebar-section-3" aria-expanded="true">
 <span class="menu-text">Acquisition</span></a>
          <a class="sidebar-item-toggle text-start" data-bs-toggle="collapse" data-bs-target="#quarto-sidebar-section-3" aria-expanded="true" aria-label="Toggle section">
            <i class="bi bi-chevron-right ms-2"></i>
          </a> 
      </div>
      <ul id="quarto-sidebar-section-3" class="collapse list-unstyled sidebar-section depth1 show">  
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./06-farm.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">6</span>&nbsp; <span class="chapter-title">Farm data</span></span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./07-gather.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">7</span>&nbsp; <span class="chapter-title">Gather data</span></span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./08-hunt.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">8</span>&nbsp; <span class="chapter-title">Hunt data</span></span></a>
  </div>
</li>
      </ul>
  </li>
        <li class="sidebar-item sidebar-item-section">
      <div class="sidebar-item-container"> 
            <a class="sidebar-item-text sidebar-link text-start" data-bs-toggle="collapse" data-bs-target="#quarto-sidebar-section-4" aria-expanded="true">
 <span class="menu-text">Preparation</span></a>
          <a class="sidebar-item-toggle text-start" data-bs-toggle="collapse" data-bs-target="#quarto-sidebar-section-4" aria-expanded="true" aria-label="Toggle section">
            <i class="bi bi-chevron-right ms-2"></i>
          </a> 
      </div>
      <ul id="quarto-sidebar-section-4" class="collapse list-unstyled sidebar-section depth1 show">  
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./09-clean_and_prepare.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">9</span>&nbsp; <span class="chapter-title">Clean and prepare</span></span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./10-store_and_share.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">10</span>&nbsp; <span class="chapter-title">Store and share</span></span></a>
  </div>
</li>
      </ul>
  </li>
        <li class="sidebar-item sidebar-item-section">
      <div class="sidebar-item-container"> 
            <a class="sidebar-item-text sidebar-link text-start" data-bs-toggle="collapse" data-bs-target="#quarto-sidebar-section-5" aria-expanded="true">
 <span class="menu-text">Modeling</span></a>
          <a class="sidebar-item-toggle text-start" data-bs-toggle="collapse" data-bs-target="#quarto-sidebar-section-5" aria-expanded="true" aria-label="Toggle section">
            <i class="bi bi-chevron-right ms-2"></i>
          </a> 
      </div>
      <ul id="quarto-sidebar-section-5" class="collapse list-unstyled sidebar-section depth1 show">  
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./11-eda.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">11</span>&nbsp; <span class="chapter-title">Exploratory data analysis</span></span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./12-ijalm.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">12</span>&nbsp; <span class="chapter-title">Linear models</span></span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./13-ijaglm.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">13</span>&nbsp; <span class="chapter-title">Generalized linear models</span></span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./13-prediction.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">14</span>&nbsp; <span class="chapter-title">Prediction</span></span></a>
  </div>
</li>
      </ul>
  </li>
        <li class="sidebar-item sidebar-item-section">
      <div class="sidebar-item-container"> 
            <a class="sidebar-item-text sidebar-link text-start" data-bs-toggle="collapse" data-bs-target="#quarto-sidebar-section-6" aria-expanded="true">
 <span class="menu-text">Applications</span></a>
          <a class="sidebar-item-toggle text-start" data-bs-toggle="collapse" data-bs-target="#quarto-sidebar-section-6" aria-expanded="true" aria-label="Toggle section">
            <i class="bi bi-chevron-right ms-2"></i>
          </a> 
      </div>
      <ul id="quarto-sidebar-section-6" class="collapse list-unstyled sidebar-section depth1 show">  
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./14-causality_from_obs.html" class="sidebar-item-text sidebar-link active">
 <span class="menu-text"><span class="chapter-number">15</span>&nbsp; <span class="chapter-title">Causality from observational data</span></span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./15-mrp.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">16</span>&nbsp; <span class="chapter-title">Multilevel regression with post-stratification</span></span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./16-text.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">17</span>&nbsp; <span class="chapter-title">Text as data</span></span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./17-concluding.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">18</span>&nbsp; <span class="chapter-title">Concluding remarks</span></span></a>
  </div>
</li>
      </ul>
  </li>
        <li class="sidebar-item sidebar-item-section">
      <div class="sidebar-item-container"> 
            <a class="sidebar-item-text sidebar-link text-start" data-bs-toggle="collapse" data-bs-target="#quarto-sidebar-section-7" aria-expanded="true">
 <span class="menu-text">Appendices</span></a>
          <a class="sidebar-item-toggle text-start" data-bs-toggle="collapse" data-bs-target="#quarto-sidebar-section-7" aria-expanded="true" aria-label="Toggle section">
            <i class="bi bi-chevron-right ms-2"></i>
          </a> 
      </div>
      <ul id="quarto-sidebar-section-7" class="collapse list-unstyled sidebar-section depth1 show">  
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./20-r_essentials.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">A</span>&nbsp; <span class="chapter-title">R essentials</span></span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./20-python_essentials.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">B</span>&nbsp; <span class="chapter-title">Python essentials</span></span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./21-datasets.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">C</span>&nbsp; <span class="chapter-title">Datasets</span></span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./22-rmarkdown.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">D</span>&nbsp; <span class="chapter-title">R Markdown</span></span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./23-assessment.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">E</span>&nbsp; <span class="chapter-title">Papers</span></span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./24-interaction.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">F</span>&nbsp; <span class="chapter-title">Interaction</span></span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./25-datasheet.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">G</span>&nbsp; <span class="chapter-title">Datasheets</span></span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./26-sql.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">H</span>&nbsp; <span class="chapter-title">SQL essentials</span></span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./28-deploy.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">I</span>&nbsp; <span class="chapter-title">Production</span></span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./29-activities.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">J</span>&nbsp; <span class="chapter-title">Class activities</span></span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./98-cocktails.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">K</span>&nbsp; <span class="chapter-title">Cocktails</span></span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./99-references.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">References</span></a>
  </div>
</li>
      </ul>
  </li>
    </ul>
    </div>
</nav>
<div id="quarto-sidebar-glass" class="quarto-sidebar-collapse-item" data-bs-toggle="collapse" data-bs-target=".quarto-sidebar-collapse-item"></div>
<!-- margin-sidebar -->
    <div id="quarto-margin-sidebar" class="sidebar margin-sidebar">
        <nav id="TOC" role="doc-toc" class="toc-active">
    <h2 id="toc-title">Table of contents</h2>
   
  <ul>
  <li><a href="#introduction" id="toc-introduction" class="nav-link active" data-scroll-target="#introduction"><span class="header-section-number">15.1</span> Introduction</a></li>
  <li><a href="#two-common-paradoxes" id="toc-two-common-paradoxes" class="nav-link" data-scroll-target="#two-common-paradoxes"><span class="header-section-number">15.2</span> Two common paradoxes</a>
  <ul class="collapse">
  <li><a href="#simpsons-paradox" id="toc-simpsons-paradox" class="nav-link" data-scroll-target="#simpsons-paradox"><span class="header-section-number">15.2.1</span> Simpson’s paradox</a></li>
  <li><a href="#berksons-paradox" id="toc-berksons-paradox" class="nav-link" data-scroll-target="#berksons-paradox"><span class="header-section-number">15.2.2</span> Berkson’s paradox</a></li>
  </ul></li>
  <li><a href="#difference-in-differences" id="toc-difference-in-differences" class="nav-link" data-scroll-target="#difference-in-differences"><span class="header-section-number">15.3</span> Difference-in-differences</a>
  <ul class="collapse">
  <li><a href="#simulated-example-tennis-serve-speed" id="toc-simulated-example-tennis-serve-speed" class="nav-link" data-scroll-target="#simulated-example-tennis-serve-speed"><span class="header-section-number">15.3.1</span> Simulated example: tennis serve speed</a></li>
  <li><a href="#assumptions" id="toc-assumptions" class="nav-link" data-scroll-target="#assumptions"><span class="header-section-number">15.3.2</span> Assumptions</a></li>
  <li><a href="#french-newspaper-prices-between-1960-and-1974" id="toc-french-newspaper-prices-between-1960-and-1974" class="nav-link" data-scroll-target="#french-newspaper-prices-between-1960-and-1974"><span class="header-section-number">15.3.3</span> French newspaper prices between 1960 and 1974</a></li>
  </ul></li>
  <li><a href="#propensity-score-matching" id="toc-propensity-score-matching" class="nav-link" data-scroll-target="#propensity-score-matching"><span class="header-section-number">15.4</span> Propensity score matching</a>
  <ul class="collapse">
  <li><a href="#simulated-example-free-shipping" id="toc-simulated-example-free-shipping" class="nav-link" data-scroll-target="#simulated-example-free-shipping"><span class="header-section-number">15.4.1</span> Simulated example: free shipping</a></li>
  </ul></li>
  <li><a href="#regression-discontinuity-design" id="toc-regression-discontinuity-design" class="nav-link" data-scroll-target="#regression-discontinuity-design"><span class="header-section-number">15.5</span> Regression discontinuity design</a>
  <ul class="collapse">
  <li><a href="#simulated-example-income-and-grades" id="toc-simulated-example-income-and-grades" class="nav-link" data-scroll-target="#simulated-example-income-and-grades"><span class="header-section-number">15.5.1</span> Simulated example: income and grades</a></li>
  <li><a href="#assumptions-1" id="toc-assumptions-1" class="nav-link" data-scroll-target="#assumptions-1"><span class="header-section-number">15.5.2</span> Assumptions</a></li>
  <li><a href="#alcohol-and-crime-in-california" id="toc-alcohol-and-crime-in-california" class="nav-link" data-scroll-target="#alcohol-and-crime-in-california"><span class="header-section-number">15.5.3</span> Alcohol and crime in California</a></li>
  </ul></li>
  <li><a href="#instrumental-variables" id="toc-instrumental-variables" class="nav-link" data-scroll-target="#instrumental-variables"><span class="header-section-number">15.6</span> Instrumental variables</a>
  <ul class="collapse">
  <li><a href="#simulated-example-health-status-smoking-and-tax-rates" id="toc-simulated-example-health-status-smoking-and-tax-rates" class="nav-link" data-scroll-target="#simulated-example-health-status-smoking-and-tax-rates"><span class="header-section-number">15.6.1</span> Simulated example: health status, smoking, and tax rates</a></li>
  <li><a href="#assumptions-2" id="toc-assumptions-2" class="nav-link" data-scroll-target="#assumptions-2"><span class="header-section-number">15.6.2</span> Assumptions</a></li>
  </ul></li>
  <li><a href="#exercises" id="toc-exercises" class="nav-link" data-scroll-target="#exercises"><span class="header-section-number">15.7</span> Exercises</a>
  <ul class="collapse">
  <li><a href="#scales" id="toc-scales" class="nav-link" data-scroll-target="#scales">Scales</a></li>
  <li><a href="#questions" id="toc-questions" class="nav-link" data-scroll-target="#questions">Questions</a></li>
  <li><a href="#tutorial" id="toc-tutorial" class="nav-link" data-scroll-target="#tutorial">Tutorial</a></li>
  </ul></li>
  </ul>
<div class="toc-actions"><ul><li><a href="https://github.com/RohanAlexander/telling_stories/edit/main/14-causality_from_obs.qmd" class="toc-action"><i class="bi bi-github"></i>Edit this page</a></li></ul></div></nav>
    </div>
<!-- main -->
<main class="content" id="quarto-document-content">

<header id="title-block-header" class="quarto-title-block default"><nav class="quarto-page-breadcrumbs quarto-title-breadcrumbs d-none d-lg-block" aria-label="breadcrumb"><ol class="breadcrumb"><li class="breadcrumb-item"><a href="./14-causality_from_obs.html">Applications</a></li><li class="breadcrumb-item"><a href="./14-causality_from_obs.html"><span class="chapter-number">15</span>&nbsp; <span class="chapter-title">Causality from observational data</span></a></li></ol></nav>
<div class="quarto-title">
<h1 class="title"><span id="sec-causality-from-observational-data" class="quarto-section-identifier"><span class="chapter-number">15</span>&nbsp; <span class="chapter-title">Causality from observational data</span></span></h1>
</div>



<div class="quarto-title-meta">

    
  
    
  </div>
  


</header>


<p><strong>Prerequisites</strong></p>
<ul>
<li>Read <em>Causal design patterns for data analysts</em>, <span class="citation" data-cites="riedererdesignpatterns">(<a href="99-references.html#ref-riedererdesignpatterns" role="doc-biblioref">Riederer 2021</a>)</span>
<ul>
<li>This blog post provides an overview of different approaches for making causal claims from observational data.</li>
</ul></li>
<li>Read <em>BNT162b2 mRNA Covid-19 Vaccine in a Nationwide Mass Vaccination Setting</em>, <span class="citation" data-cites="dagan2021bnt162b2">(<a href="99-references.html#ref-dagan2021bnt162b2" role="doc-biblioref">Dagan et al. 2021</a>)</span>
<ul>
<li>This paper compares causal conclusions drawn from observational data with those of a randomized trial.</li>
</ul></li>
<li>Read <em>The Effect: An Introduction to Research Design and Causality</em>, <span class="citation" data-cites="theeffect">(<a href="99-references.html#ref-theeffect" role="doc-biblioref">Huntington-Klein 2021</a>)</span>
<ul>
<li>Focus on Chapters 18 “Difference-in-Differences”, 19 “Instrumental Variables”, and 20 “Regression Discontinuity”, which provide an overview of three key approaches for making causal claims from observational data.</li>
</ul></li>
<li>Read <em>Understanding regression discontinuity designs as observational studies</em>, <span class="citation" data-cites="sekhon2017understanding">(<a href="99-references.html#ref-sekhon2017understanding" role="doc-biblioref">Sekhon and Titiunik 2017</a>)</span>
<ul>
<li>Discusses some concerns with the use of regression discontinuity.</li>
</ul></li>
</ul>
<p><strong>Key concepts and skills</strong></p>
<ul>
<li>Running an experiment is not always possible, but we can use various approaches to nonetheless be able to speak to causality to some extent.</li>
<li>We need to be careful of common paradoxes including Simpson’s paradox and Berkson’s paradox, and be aware of both the potential and pitfalls of matching.</li>
<li>We can use difference-in-differences when we have data on both treated and untreated units at both time periods. Regression discontinuity is useful when a group is either treated or not, but the two groups are very similar apart from the treatment. And instrumental variables is an approach used to estimate causality indirectly through another variable.</li>
<li>In general, these approaches need to be used with humility and concern for weaknesses and assumptions, both those that we can test and those that we cannot.</li>
</ul>
<p><strong>Software and packages</strong></p>
<ul>
<li>Base R <span class="citation" data-cites="citeR">(<a href="99-references.html#ref-citeR" role="doc-biblioref">R Core Team 2023</a>)</span></li>
<li><code>broom</code> <span class="citation" data-cites="broom">(<a href="99-references.html#ref-broom" role="doc-biblioref">Robinson, Hayes, and Couch 2022</a>)</span></li>
<li><code>broom.mixed</code> <span class="citation" data-cites="mixedbroom">(<a href="99-references.html#ref-mixedbroom" role="doc-biblioref">Bolker and Robinson 2022</a>)</span></li>
<li><code>estimatr</code> <span class="citation" data-cites="estimatr">(<a href="99-references.html#ref-estimatr" role="doc-biblioref">Blair et al. 2021</a>)</span></li>
<li><code>haven</code> <span class="citation" data-cites="citehaven">(<a href="99-references.html#ref-citehaven" role="doc-biblioref">Wickham, Miller, and Smith 2023</a>)</span></li>
<li><code>knitr</code> <span class="citation" data-cites="citeknitr">(<a href="99-references.html#ref-citeknitr" role="doc-biblioref">Xie 2023</a>)</span></li>
<li><code>MatchIt</code> <span class="citation" data-cites="MatchIt">(<a href="99-references.html#ref-MatchIt" role="doc-biblioref">Ho et al. 2011</a>)</span></li>
<li><code>modelsummary</code> <span class="citation" data-cites="citemodelsummary">(<a href="99-references.html#ref-citemodelsummary" role="doc-biblioref">Arel-Bundock 2022</a>)</span></li>
<li><code>palmerpenguins</code> <span class="citation" data-cites="palmerpenguins">(<a href="99-references.html#ref-palmerpenguins" role="doc-biblioref">Horst, Presmanes Hill, and Gorman 2020</a>)</span></li>
<li><code>rdrobust</code> <span class="citation" data-cites="rdrobust">(<a href="99-references.html#ref-rdrobust" role="doc-biblioref">Calonico et al. 2021</a>)</span></li>
<li><code>rstanarm</code> <span class="citation" data-cites="citerstanarm">(<a href="99-references.html#ref-citerstanarm" role="doc-biblioref">Goodrich et al. 2023</a>)</span></li>
<li><code>scales</code> <span class="citation" data-cites="scales">(<a href="99-references.html#ref-scales" role="doc-biblioref">Wickham and Seidel 2022</a>)</span></li>
<li><code>tidyverse</code> <span class="citation" data-cites="tidyverse">(<a href="99-references.html#ref-tidyverse" role="doc-biblioref">Wickham et al. 2019</a>)</span></li>
</ul>
<div class="cell">
<div class="sourceCode cell-code" id="cb1"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb1-1"><a href="#cb1-1" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(broom)</span>
<span id="cb1-2"><a href="#cb1-2" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(broom.mixed)</span>
<span id="cb1-3"><a href="#cb1-3" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(estimatr)</span>
<span id="cb1-4"><a href="#cb1-4" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(haven)</span>
<span id="cb1-5"><a href="#cb1-5" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(knitr)</span>
<span id="cb1-6"><a href="#cb1-6" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(MatchIt)</span>
<span id="cb1-7"><a href="#cb1-7" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(modelsummary)</span>
<span id="cb1-8"><a href="#cb1-8" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(palmerpenguins)</span>
<span id="cb1-9"><a href="#cb1-9" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(rdrobust)</span>
<span id="cb1-10"><a href="#cb1-10" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(rstanarm)</span>
<span id="cb1-11"><a href="#cb1-11" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(scales)</span>
<span id="cb1-12"><a href="#cb1-12" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(tidyverse)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<section id="introduction" class="level2" data-number="15.1">
<h2 data-number="15.1" class="anchored" data-anchor-id="introduction"><span class="header-section-number">15.1</span> Introduction</h2>
<p>Life is grand when we can conduct experiments to be able to speak to causality. But there are circumstances in which we cannot run an experiment, yet nonetheless want to be able to make causal claims. And data from outside experiments have value that experiments do not have. In this chapter we discuss the circumstances and methods that allow us to speak to causality using observational data. We use relatively simple methods, in sophisticated ways, drawing from statistics, but also a variety of social sciences, including economics and political science, as well as epidemiology.</p>
<p>For instance, <span class="citation" data-cites="dagan2021bnt162b2">Dagan et al. (<a href="99-references.html#ref-dagan2021bnt162b2" role="doc-biblioref">2021</a>)</span> use observational data to confirm the effectiveness of the Pfizer-BioNTech vaccine. They discuss how one concern with using observational data in this way is confounding, which is where we are concerned that there is some variable that affects both the predictor and outcome variables and can lead to spurious relationships. <span class="citation" data-cites="dagan2021bnt162b2">Dagan et al. (<a href="99-references.html#ref-dagan2021bnt162b2" role="doc-biblioref">2021</a>)</span> adjust for this by first making a list of potential confounders, such as age, sex, geographic location, and healthcare usage and then adjusting for each of them, by matching one-to-one between people that were vaccinated and those that were not. The experimental data guided the use of observational data, and the larger size of the latter enabled a focus on specific age-groups and extent of disease.</p>
<p>This chapter is about using observational data in sophisticated ways. How we can nonetheless be comfortable making causal statements, even when we cannot run A/B tests or RCTs. Indeed, in what circumstances may we prefer to not run those or to run observational-based approaches in addition to them. We cover three of the major methods: difference-in-differences, regression discontinuity, and instrumental variables.</p>
</section>
<section id="two-common-paradoxes" class="level2" data-number="15.2">
<h2 data-number="15.2" class="anchored" data-anchor-id="two-common-paradoxes"><span class="header-section-number">15.2</span> Two common paradoxes</h2>
<p>There are two situations where data can trick us that are so common that we will explicitly go through them. These are:</p>
<ol type="1">
<li>Simpson’s paradox, and</li>
<li>Berkson’s paradox.</li>
</ol>
<section id="simpsons-paradox" class="level3" data-number="15.2.1">
<h3 data-number="15.2.1" class="anchored" data-anchor-id="simpsons-paradox"><span class="header-section-number">15.2.1</span> Simpson’s paradox</h3>
<p>Simpson’s paradox occurs when we estimate some relationship for subsets of our data, but a different relationship when we consider the entire dataset <span class="citation" data-cites="simpson1951interpretation">(<a href="99-references.html#ref-simpson1951interpretation" role="doc-biblioref">Simpson 1951</a>)</span>. It is a particular case of the ecological fallacy, which is when we try to make claims about individuals, based on their group. For instance, it may be that there is a positive relationship between undergraduate grades and performance in graduate school in two departments when considering each department individually. But if undergraduate grades tended to be higher in one department than another while graduate school performance tended to be opposite, we may find a negative relationship between undergraduate grades and performance in graduate school. We can simulate some data to show this more clearly (<a href="#fig-simpsonsparadox" class="quarto-xref">Figure&nbsp;<span>15.1</span></a>).</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb2"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb2-1"><a href="#cb2-1" aria-hidden="true" tabindex="-1"></a><span class="fu">set.seed</span>(<span class="dv">853</span>)</span>
<span id="cb2-2"><a href="#cb2-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb2-3"><a href="#cb2-3" aria-hidden="true" tabindex="-1"></a>number_in_each <span class="ot">&lt;-</span> <span class="dv">1000</span></span>
<span id="cb2-4"><a href="#cb2-4" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb2-5"><a href="#cb2-5" aria-hidden="true" tabindex="-1"></a>department_one <span class="ot">&lt;-</span></span>
<span id="cb2-6"><a href="#cb2-6" aria-hidden="true" tabindex="-1"></a>  <span class="fu">tibble</span>(</span>
<span id="cb2-7"><a href="#cb2-7" aria-hidden="true" tabindex="-1"></a>    <span class="at">undergrad =</span> <span class="fu">runif</span>(<span class="at">n =</span> number_in_each, <span class="at">min =</span> <span class="fl">0.7</span>, <span class="at">max =</span> <span class="fl">0.9</span>),</span>
<span id="cb2-8"><a href="#cb2-8" aria-hidden="true" tabindex="-1"></a>    <span class="at">noise =</span> <span class="fu">rnorm</span>(<span class="at">n =</span> number_in_each, <span class="dv">0</span>, <span class="at">sd =</span> <span class="fl">0.1</span>),</span>
<span id="cb2-9"><a href="#cb2-9" aria-hidden="true" tabindex="-1"></a>    <span class="at">grad =</span> undergrad <span class="sc">+</span> noise,</span>
<span id="cb2-10"><a href="#cb2-10" aria-hidden="true" tabindex="-1"></a>    <span class="at">type =</span> <span class="st">"Department 1"</span></span>
<span id="cb2-11"><a href="#cb2-11" aria-hidden="true" tabindex="-1"></a>  )</span>
<span id="cb2-12"><a href="#cb2-12" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb2-13"><a href="#cb2-13" aria-hidden="true" tabindex="-1"></a>department_two <span class="ot">&lt;-</span></span>
<span id="cb2-14"><a href="#cb2-14" aria-hidden="true" tabindex="-1"></a>  <span class="fu">tibble</span>(</span>
<span id="cb2-15"><a href="#cb2-15" aria-hidden="true" tabindex="-1"></a>    <span class="at">undergrad =</span> <span class="fu">runif</span>(<span class="at">n =</span> number_in_each, <span class="at">min =</span> <span class="fl">0.6</span>, <span class="at">max =</span> <span class="fl">0.8</span>),</span>
<span id="cb2-16"><a href="#cb2-16" aria-hidden="true" tabindex="-1"></a>    <span class="at">noise =</span> <span class="fu">rnorm</span>(<span class="at">n =</span> number_in_each, <span class="dv">0</span>, <span class="at">sd =</span> <span class="fl">0.1</span>),</span>
<span id="cb2-17"><a href="#cb2-17" aria-hidden="true" tabindex="-1"></a>    <span class="at">grad =</span> undergrad <span class="sc">+</span> noise <span class="sc">+</span> <span class="fl">0.3</span>,</span>
<span id="cb2-18"><a href="#cb2-18" aria-hidden="true" tabindex="-1"></a>    <span class="at">type =</span> <span class="st">"Department 2"</span></span>
<span id="cb2-19"><a href="#cb2-19" aria-hidden="true" tabindex="-1"></a>  )</span>
<span id="cb2-20"><a href="#cb2-20" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb2-21"><a href="#cb2-21" aria-hidden="true" tabindex="-1"></a>both_departments <span class="ot">&lt;-</span> <span class="fu">rbind</span>(department_one, department_two)</span>
<span id="cb2-22"><a href="#cb2-22" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb2-23"><a href="#cb2-23" aria-hidden="true" tabindex="-1"></a>both_departments</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code># A tibble: 2,000 × 4
   undergrad   noise  grad type        
       &lt;dbl&gt;   &lt;dbl&gt; &lt;dbl&gt; &lt;chr&gt;       
 1     0.772 -0.0566 0.715 Department 1
 2     0.724 -0.0312 0.693 Department 1
 3     0.797  0.0770 0.874 Department 1
 4     0.763 -0.0664 0.697 Department 1
 5     0.707  0.0717 0.779 Department 1
 6     0.781 -0.0165 0.764 Department 1
 7     0.726 -0.104  0.623 Department 1
 8     0.749  0.0527 0.801 Department 1
 9     0.732 -0.0471 0.684 Department 1
10     0.738  0.0552 0.793 Department 1
# ℹ 1,990 more rows</code></pre>
</div>
</div>
<div class="cell">
<div class="sourceCode cell-code" id="cb4"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb4-1"><a href="#cb4-1" aria-hidden="true" tabindex="-1"></a>both_departments <span class="sc">|&gt;</span></span>
<span id="cb4-2"><a href="#cb4-2" aria-hidden="true" tabindex="-1"></a>  <span class="fu">ggplot</span>(<span class="fu">aes</span>(<span class="at">x =</span> undergrad, <span class="at">y =</span> grad)) <span class="sc">+</span></span>
<span id="cb4-3"><a href="#cb4-3" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_point</span>(<span class="fu">aes</span>(<span class="at">color =</span> type), <span class="at">alpha =</span> <span class="fl">0.1</span>) <span class="sc">+</span></span>
<span id="cb4-4"><a href="#cb4-4" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_smooth</span>(<span class="fu">aes</span>(<span class="at">color =</span> type), <span class="at">method =</span> <span class="st">"lm"</span>, <span class="at">formula =</span> <span class="st">"y ~ x"</span>) <span class="sc">+</span></span>
<span id="cb4-5"><a href="#cb4-5" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_smooth</span>(<span class="at">method =</span> <span class="st">"lm"</span>, <span class="at">formula =</span> <span class="st">"y ~ x"</span>, <span class="at">color =</span> <span class="st">"black"</span>) <span class="sc">+</span></span>
<span id="cb4-6"><a href="#cb4-6" aria-hidden="true" tabindex="-1"></a>  <span class="fu">labs</span>(</span>
<span id="cb4-7"><a href="#cb4-7" aria-hidden="true" tabindex="-1"></a>    <span class="at">x =</span> <span class="st">"Undergraduate results"</span>,</span>
<span id="cb4-8"><a href="#cb4-8" aria-hidden="true" tabindex="-1"></a>    <span class="at">y =</span> <span class="st">"Graduate results"</span>,</span>
<span id="cb4-9"><a href="#cb4-9" aria-hidden="true" tabindex="-1"></a>    <span class="at">color =</span> <span class="st">"Department"</span></span>
<span id="cb4-10"><a href="#cb4-10" aria-hidden="true" tabindex="-1"></a>  ) <span class="sc">+</span></span>
<span id="cb4-11"><a href="#cb4-11" aria-hidden="true" tabindex="-1"></a>  <span class="fu">theme_minimal</span>() <span class="sc">+</span></span>
<span id="cb4-12"><a href="#cb4-12" aria-hidden="true" tabindex="-1"></a>  <span class="fu">scale_color_brewer</span>(<span class="at">palette =</span> <span class="st">"Set1"</span>) <span class="sc">+</span></span>
<span id="cb4-13"><a href="#cb4-13" aria-hidden="true" tabindex="-1"></a>  <span class="fu">theme</span>(<span class="at">legend.position =</span> <span class="st">"bottom"</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">
<div id="fig-simpsonsparadox" class="quarto-figure quarto-figure-center quarto-float anchored">
<figure class="quarto-float quarto-float-fig figure">
<div aria-describedby="fig-simpsonsparadox-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
<img src="14-causality_from_obs_files/figure-html/fig-simpsonsparadox-1.png" class="img-fluid figure-img" width="672">
</div>
<figcaption class="quarto-float-caption-bottom quarto-float-caption quarto-float-fig" id="fig-simpsonsparadox-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
Figure&nbsp;15.1: Illustration of simulated data that shows Simpson’s paradox
</figcaption>
</figure>
</div>
</div>
</div>
<p>Simpson’s paradox is often illustrated using real-world data from University of California, Berkeley, on graduate admissions <span class="citation" data-cites="bickel1975sex">(<a href="99-references.html#ref-bickel1975sex" role="doc-biblioref">Bickel, Hammel, and O’Connell 1975</a>)</span>. This paper was mentioned in <a href="04-writing_research.html" class="quarto-xref"><span>Chapter 4</span></a> as having one of the greatest sub-titles ever published. <span class="citation" data-cites="Hernn2011">Hernán, Clayton, and Keiding (<a href="99-references.html#ref-Hernn2011" role="doc-biblioref">2011</a>)</span> create DAGs that further illuminate the relationship and the cause of the paradox.</p>
<p>More recently, as mentioned in its documentation, the “penguins” dataset from <code>palmerpenguins</code> provides an example of Simpson’s paradox, using real-world data on the relationship between body mass and bill depth in different species of penguins (<a href="#fig-simpsonsparadoxinpenguins" class="quarto-xref">Figure&nbsp;<span>15.2</span></a>). The overall negative trend occurs because Gentoo penguins tend to be heavier but with shorter bills compared to Adelie and Chinstrap penguins.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb5"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb5-1"><a href="#cb5-1" aria-hidden="true" tabindex="-1"></a>penguins <span class="sc">|&gt;</span></span>
<span id="cb5-2"><a href="#cb5-2" aria-hidden="true" tabindex="-1"></a>  <span class="fu">ggplot</span>(<span class="fu">aes</span>(<span class="at">x =</span> body_mass_g, <span class="at">y =</span> bill_depth_mm)) <span class="sc">+</span></span>
<span id="cb5-3"><a href="#cb5-3" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_point</span>(<span class="fu">aes</span>(<span class="at">color =</span> species), <span class="at">alpha =</span> <span class="fl">0.1</span>) <span class="sc">+</span></span>
<span id="cb5-4"><a href="#cb5-4" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_smooth</span>(<span class="fu">aes</span>(<span class="at">color =</span> species), <span class="at">method =</span> <span class="st">"lm"</span>, <span class="at">formula =</span> <span class="st">"y ~ x"</span>) <span class="sc">+</span></span>
<span id="cb5-5"><a href="#cb5-5" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_smooth</span>(</span>
<span id="cb5-6"><a href="#cb5-6" aria-hidden="true" tabindex="-1"></a>    <span class="at">method =</span> <span class="st">"lm"</span>,</span>
<span id="cb5-7"><a href="#cb5-7" aria-hidden="true" tabindex="-1"></a>    <span class="at">formula =</span> <span class="st">"y ~ x"</span>,</span>
<span id="cb5-8"><a href="#cb5-8" aria-hidden="true" tabindex="-1"></a>    <span class="at">color =</span> <span class="st">"black"</span></span>
<span id="cb5-9"><a href="#cb5-9" aria-hidden="true" tabindex="-1"></a>  ) <span class="sc">+</span></span>
<span id="cb5-10"><a href="#cb5-10" aria-hidden="true" tabindex="-1"></a>  <span class="fu">labs</span>(</span>
<span id="cb5-11"><a href="#cb5-11" aria-hidden="true" tabindex="-1"></a>    <span class="at">x =</span> <span class="st">"Body mass (grams)"</span>,</span>
<span id="cb5-12"><a href="#cb5-12" aria-hidden="true" tabindex="-1"></a>    <span class="at">y =</span> <span class="st">"Bill depth (millimeters)"</span>,</span>
<span id="cb5-13"><a href="#cb5-13" aria-hidden="true" tabindex="-1"></a>    <span class="at">color =</span> <span class="st">"Species"</span></span>
<span id="cb5-14"><a href="#cb5-14" aria-hidden="true" tabindex="-1"></a>  ) <span class="sc">+</span></span>
<span id="cb5-15"><a href="#cb5-15" aria-hidden="true" tabindex="-1"></a>  <span class="fu">theme_minimal</span>() <span class="sc">+</span></span>
<span id="cb5-16"><a href="#cb5-16" aria-hidden="true" tabindex="-1"></a>  <span class="fu">scale_color_brewer</span>(<span class="at">palette =</span> <span class="st">"Set1"</span>) <span class="sc">+</span></span>
<span id="cb5-17"><a href="#cb5-17" aria-hidden="true" tabindex="-1"></a>  <span class="fu">theme</span>(<span class="at">legend.position =</span> <span class="st">"bottom"</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">
<div id="fig-simpsonsparadoxinpenguins" class="quarto-figure quarto-figure-center quarto-float anchored">
<figure class="quarto-float quarto-float-fig figure">
<div aria-describedby="fig-simpsonsparadoxinpenguins-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
<img src="14-causality_from_obs_files/figure-html/fig-simpsonsparadoxinpenguins-1.png" class="img-fluid figure-img" width="672">
</div>
<figcaption class="quarto-float-caption-bottom quarto-float-caption quarto-float-fig" id="fig-simpsonsparadoxinpenguins-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
Figure&nbsp;15.2: Illustration of Simpson’s paradox in a dataset of penguin bill depth compared with their body mass
</figcaption>
</figure>
</div>
</div>
</div>
</section>
<section id="berksons-paradox" class="level3" data-number="15.2.2">
<h3 data-number="15.2.2" class="anchored" data-anchor-id="berksons-paradox"><span class="header-section-number">15.2.2</span> Berkson’s paradox</h3>
<p>Berkson’s paradox occurs when we estimate some relationship based on the dataset that we have, but because the dataset is so selected, the relationship is different in a more general dataset <span class="citation" data-cites="citeberkson">(<a href="99-references.html#ref-citeberkson" role="doc-biblioref">Berkson 1946</a>)</span>. For instance, if we have a dataset of professional cyclists then we might find there is no relationship between their VO2 max and their chance of winning a bike race <span class="citation" data-cites="vomaxpaper anothernicevomaxpaper">(<a href="99-references.html#ref-vomaxpaper" role="doc-biblioref">Coyle et al. 1988</a>; <a href="99-references.html#ref-anothernicevomaxpaper" role="doc-biblioref">Podlogar, Leo, and Spragg 2022</a>)</span>. But if we had a dataset of the general population then we might find a relationship between these two variables. The professional dataset has just been so selected that the relationship disappears; one cannot become a professional cyclist unless one has a good enough VO2 max, but among professional cyclists everyone has a good enough VO2 max. Again, we can simulate some data to show this more clearly (<a href="#fig-berksonsparadox" class="quarto-xref">Figure&nbsp;<span>15.3</span></a>).</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb6"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb6-1"><a href="#cb6-1" aria-hidden="true" tabindex="-1"></a><span class="fu">set.seed</span>(<span class="dv">853</span>)</span>
<span id="cb6-2"><a href="#cb6-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb6-3"><a href="#cb6-3" aria-hidden="true" tabindex="-1"></a>num_pros <span class="ot">&lt;-</span> <span class="dv">100</span></span>
<span id="cb6-4"><a href="#cb6-4" aria-hidden="true" tabindex="-1"></a>num_public <span class="ot">&lt;-</span> <span class="dv">1000</span></span>
<span id="cb6-5"><a href="#cb6-5" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb6-6"><a href="#cb6-6" aria-hidden="true" tabindex="-1"></a>professionals <span class="ot">&lt;-</span> <span class="fu">tibble</span>(</span>
<span id="cb6-7"><a href="#cb6-7" aria-hidden="true" tabindex="-1"></a>  <span class="at">VO2 =</span> <span class="fu">runif</span>(num_pros, <span class="fl">0.7</span>, <span class="fl">0.9</span>),</span>
<span id="cb6-8"><a href="#cb6-8" aria-hidden="true" tabindex="-1"></a>  <span class="at">chance_of_winning =</span> <span class="fu">runif</span>(num_pros, <span class="fl">0.7</span>, <span class="fl">0.9</span>),</span>
<span id="cb6-9"><a href="#cb6-9" aria-hidden="true" tabindex="-1"></a>  <span class="at">type =</span> <span class="st">"Professionals"</span></span>
<span id="cb6-10"><a href="#cb6-10" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb6-11"><a href="#cb6-11" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb6-12"><a href="#cb6-12" aria-hidden="true" tabindex="-1"></a>general_public <span class="ot">&lt;-</span> <span class="fu">tibble</span>(</span>
<span id="cb6-13"><a href="#cb6-13" aria-hidden="true" tabindex="-1"></a>  <span class="at">VO2 =</span> <span class="fu">runif</span>(num_public, <span class="fl">0.6</span>, <span class="fl">0.8</span>),</span>
<span id="cb6-14"><a href="#cb6-14" aria-hidden="true" tabindex="-1"></a>  <span class="at">chance_of_winning =</span> VO2 <span class="sc">+</span> <span class="fu">rnorm</span>(num_public, <span class="dv">0</span>, <span class="fl">0.03</span>) <span class="sc">+</span> <span class="fl">0.1</span>,</span>
<span id="cb6-15"><a href="#cb6-15" aria-hidden="true" tabindex="-1"></a>  <span class="at">type =</span> <span class="st">"Public"</span></span>
<span id="cb6-16"><a href="#cb6-16" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb6-17"><a href="#cb6-17" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb6-18"><a href="#cb6-18" aria-hidden="true" tabindex="-1"></a>professionals_and_public <span class="ot">&lt;-</span> <span class="fu">bind_rows</span>(professionals, general_public)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div class="cell">
<div class="sourceCode cell-code" id="cb7"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb7-1"><a href="#cb7-1" aria-hidden="true" tabindex="-1"></a>professionals_and_public <span class="sc">|&gt;</span></span>
<span id="cb7-2"><a href="#cb7-2" aria-hidden="true" tabindex="-1"></a>  <span class="fu">ggplot</span>(<span class="fu">aes</span>(<span class="at">x =</span> VO2, <span class="at">y =</span> chance_of_winning)) <span class="sc">+</span></span>
<span id="cb7-3"><a href="#cb7-3" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_point</span>(<span class="fu">aes</span>(<span class="at">color =</span> type), <span class="at">alpha =</span> <span class="fl">0.1</span>) <span class="sc">+</span></span>
<span id="cb7-4"><a href="#cb7-4" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_smooth</span>(<span class="fu">aes</span>(<span class="at">color =</span> type), <span class="at">method =</span> <span class="st">"lm"</span>, <span class="at">formula =</span> <span class="st">"y ~ x"</span>) <span class="sc">+</span></span>
<span id="cb7-5"><a href="#cb7-5" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_smooth</span>(<span class="at">method =</span> <span class="st">"lm"</span>, <span class="at">formula =</span> <span class="st">"y ~ x"</span>, <span class="at">color =</span> <span class="st">"black"</span>) <span class="sc">+</span></span>
<span id="cb7-6"><a href="#cb7-6" aria-hidden="true" tabindex="-1"></a>  <span class="fu">labs</span>(</span>
<span id="cb7-7"><a href="#cb7-7" aria-hidden="true" tabindex="-1"></a>    <span class="at">x =</span> <span class="st">"VO2 max"</span>,</span>
<span id="cb7-8"><a href="#cb7-8" aria-hidden="true" tabindex="-1"></a>    <span class="at">y =</span> <span class="st">"Chance of winning a bike race"</span>,</span>
<span id="cb7-9"><a href="#cb7-9" aria-hidden="true" tabindex="-1"></a>    <span class="at">color =</span> <span class="st">"Type"</span></span>
<span id="cb7-10"><a href="#cb7-10" aria-hidden="true" tabindex="-1"></a>  ) <span class="sc">+</span></span>
<span id="cb7-11"><a href="#cb7-11" aria-hidden="true" tabindex="-1"></a>  <span class="fu">theme_minimal</span>() <span class="sc">+</span></span>
<span id="cb7-12"><a href="#cb7-12" aria-hidden="true" tabindex="-1"></a>  <span class="fu">scale_color_brewer</span>(<span class="at">palette =</span> <span class="st">"Set1"</span>) <span class="sc">+</span></span>
<span id="cb7-13"><a href="#cb7-13" aria-hidden="true" tabindex="-1"></a>  <span class="fu">theme</span>(<span class="at">legend.position =</span> <span class="st">"bottom"</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">
<div id="fig-berksonsparadox" class="quarto-figure quarto-figure-center quarto-float anchored">
<figure class="quarto-float quarto-float-fig figure">
<div aria-describedby="fig-berksonsparadox-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
<img src="14-causality_from_obs_files/figure-html/fig-berksonsparadox-1.png" class="img-fluid figure-img" width="672">
</div>
<figcaption class="quarto-float-caption-bottom quarto-float-caption quarto-float-fig" id="fig-berksonsparadox-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
Figure&nbsp;15.3: Illustration of simulated data that shows Berkson’s paradox
</figcaption>
</figure>
</div>
</div>
</div>
</section>
</section>
<section id="difference-in-differences" class="level2" data-number="15.3">
<h2 data-number="15.3" class="anchored" data-anchor-id="difference-in-differences"><span class="header-section-number">15.3</span> Difference-in-differences</h2>
<p>The ideal situation of being able to conduct an experiment is rarely possible. Can we reasonably expect that Netflix would allow us to change prices? And even if they did once, would they let us do it again, and again, and again? Further, rarely can we explicitly create treatment and control groups. Finally, experiments can be expensive or unethical. Instead, we need to make do with what we have. Rather than our counterfactual coming to us through randomization, and hence us knowing that the two are the same but for the treatment, we try to identify groups that were similar but for the treatment, and hence any differences can be attributed to the treatment.</p>
<p>With observational data, sometimes there are differences between our two groups before we treat. Provided those pre-treatment differences satisfy assumptions that essentially amount to the differences being both consistent, and that we expect that consistency to continue in the absence of the treatment—the “parallel trends” assumption—then we can look to any difference in the differences as the effect of the treatment. One of the aspects of difference-in-differences analysis is that we can do it using relatively straight forward methods, for instance <span class="citation" data-cites="Tang2015">Tang (<a href="99-references.html#ref-Tang2015" role="doc-biblioref">2015</a>)</span>. Linear regression with a binary variable is enough to get started and do a convincing job.</p>
<p>Consider wanting to know the effect of a new tennis racket on serve speed. One way to test this would be to measure the difference between, say, Roger Federer’s serve speed without the tennis racket and the serve speed of an enthusiastic amateur, let us call them Ville, with the tennis racket. Yes, we would find a difference, but would we know how much to attribute to the tennis racket? Another way would be to consider the difference between Ville’s serve speed without the new tennis racket and Ville’s serve speed with the new tennis racket. But what if serves were just getting faster naturally over time? Instead, we combine the two approaches to look at the difference in the differences.</p>
<p>We begin by measuring Federer’s serve speed and compare it to Ville’s serve speed, both without the new racket. We then measure Federer’s serve speed again, and measure Ville’s serve speed with the new racket. That difference in the differences would then be the estimate of the effect of the new racket. There are a few key questions we must ask to see if this analysis is appropriate:</p>
<ol type="1">
<li>Is there something else that may have affected only Ville, and not Federer that could affect Ville’s serve speed?</li>
<li>Is it likely that Federer and Ville have the same trajectory of serve speed improvement? This is the “parallel trends” assumption, and it dominates many discussions of difference-in-differences analysis.</li>
<li>Finally, is it likely that the variance of our serve speeds of Federer and Ville are the same?</li>
</ol>
<p>Despite these requirements, difference-in-differences is a powerful approach because we do not need the treatment and control group to be the same before the treatment. We just need to have a good idea of how they differed.</p>
<section id="simulated-example-tennis-serve-speed" class="level3" data-number="15.3.1">
<h3 data-number="15.3.1" class="anchored" data-anchor-id="simulated-example-tennis-serve-speed"><span class="header-section-number">15.3.1</span> Simulated example: tennis serve speed</h3>
<p>To be more specific about the situation, we simulate data. We will simulate a situation in which there is initially a difference of one between the serve speeds of the different people, and then after a new tennis racket, there is a difference of six. We can use a graph to illustrate the situation (<a href="#fig-diffindifftennisracket" class="quarto-xref">Figure&nbsp;<span>15.4</span></a>).</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb8"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb8-1"><a href="#cb8-1" aria-hidden="true" tabindex="-1"></a><span class="fu">set.seed</span>(<span class="dv">853</span>)</span>
<span id="cb8-2"><a href="#cb8-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb8-3"><a href="#cb8-3" aria-hidden="true" tabindex="-1"></a>simulated_diff_in_diff <span class="ot">&lt;-</span></span>
<span id="cb8-4"><a href="#cb8-4" aria-hidden="true" tabindex="-1"></a>  <span class="fu">tibble</span>(</span>
<span id="cb8-5"><a href="#cb8-5" aria-hidden="true" tabindex="-1"></a>    <span class="at">person =</span> <span class="fu">rep</span>(<span class="fu">c</span>(<span class="dv">1</span><span class="sc">:</span><span class="dv">1000</span>), <span class="at">times =</span> <span class="dv">2</span>),</span>
<span id="cb8-6"><a href="#cb8-6" aria-hidden="true" tabindex="-1"></a>    <span class="at">time =</span> <span class="fu">c</span>(<span class="fu">rep</span>(<span class="dv">0</span>, <span class="at">times =</span> <span class="dv">1000</span>), <span class="fu">rep</span>(<span class="dv">1</span>, <span class="at">times =</span> <span class="dv">1000</span>)),</span>
<span id="cb8-7"><a href="#cb8-7" aria-hidden="true" tabindex="-1"></a>    <span class="at">treat_group =</span> <span class="fu">rep</span>(<span class="fu">sample</span>(<span class="at">x =</span> <span class="dv">0</span><span class="sc">:</span><span class="dv">1</span>, <span class="at">size =</span> <span class="dv">1000</span>, <span class="at">replace =</span> <span class="cn">TRUE</span> ), <span class="at">times =</span> <span class="dv">2</span>)</span>
<span id="cb8-8"><a href="#cb8-8" aria-hidden="true" tabindex="-1"></a>    ) <span class="sc">|&gt;</span></span>
<span id="cb8-9"><a href="#cb8-9" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(</span>
<span id="cb8-10"><a href="#cb8-10" aria-hidden="true" tabindex="-1"></a>    <span class="at">treat_group =</span> <span class="fu">as.factor</span>(treat_group),</span>
<span id="cb8-11"><a href="#cb8-11" aria-hidden="true" tabindex="-1"></a>    <span class="at">time =</span> <span class="fu">as.factor</span>(time)</span>
<span id="cb8-12"><a href="#cb8-12" aria-hidden="true" tabindex="-1"></a>  )</span>
<span id="cb8-13"><a href="#cb8-13" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb8-14"><a href="#cb8-14" aria-hidden="true" tabindex="-1"></a>simulated_diff_in_diff <span class="ot">&lt;-</span></span>
<span id="cb8-15"><a href="#cb8-15" aria-hidden="true" tabindex="-1"></a>  simulated_diff_in_diff <span class="sc">|&gt;</span></span>
<span id="cb8-16"><a href="#cb8-16" aria-hidden="true" tabindex="-1"></a>  <span class="fu">rowwise</span>() <span class="sc">|&gt;</span></span>
<span id="cb8-17"><a href="#cb8-17" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(</span>
<span id="cb8-18"><a href="#cb8-18" aria-hidden="true" tabindex="-1"></a>    <span class="at">serve_speed =</span> <span class="fu">case_when</span>(</span>
<span id="cb8-19"><a href="#cb8-19" aria-hidden="true" tabindex="-1"></a>      time <span class="sc">==</span> <span class="dv">0</span> <span class="sc">&amp;</span> treat_group <span class="sc">==</span> <span class="dv">0</span> <span class="sc">~</span> <span class="fu">rnorm</span>(<span class="at">n =</span> <span class="dv">1</span>, <span class="at">mean =</span> <span class="dv">5</span>, <span class="at">sd =</span> <span class="dv">1</span>),</span>
<span id="cb8-20"><a href="#cb8-20" aria-hidden="true" tabindex="-1"></a>      time <span class="sc">==</span> <span class="dv">1</span> <span class="sc">&amp;</span> treat_group <span class="sc">==</span> <span class="dv">0</span> <span class="sc">~</span> <span class="fu">rnorm</span>(<span class="at">n =</span> <span class="dv">1</span>, <span class="at">mean =</span> <span class="dv">6</span>, <span class="at">sd =</span> <span class="dv">1</span>),</span>
<span id="cb8-21"><a href="#cb8-21" aria-hidden="true" tabindex="-1"></a>      time <span class="sc">==</span> <span class="dv">0</span> <span class="sc">&amp;</span> treat_group <span class="sc">==</span> <span class="dv">1</span> <span class="sc">~</span> <span class="fu">rnorm</span>(<span class="at">n =</span> <span class="dv">1</span>, <span class="at">mean =</span> <span class="dv">8</span>, <span class="at">sd =</span> <span class="dv">1</span>),</span>
<span id="cb8-22"><a href="#cb8-22" aria-hidden="true" tabindex="-1"></a>      time <span class="sc">==</span> <span class="dv">1</span> <span class="sc">&amp;</span> treat_group <span class="sc">==</span> <span class="dv">1</span> <span class="sc">~</span> <span class="fu">rnorm</span>(<span class="at">n =</span> <span class="dv">1</span>, <span class="at">mean =</span> <span class="dv">14</span>, <span class="at">sd =</span> <span class="dv">1</span>)</span>
<span id="cb8-23"><a href="#cb8-23" aria-hidden="true" tabindex="-1"></a>    )</span>
<span id="cb8-24"><a href="#cb8-24" aria-hidden="true" tabindex="-1"></a>  )</span>
<span id="cb8-25"><a href="#cb8-25" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb8-26"><a href="#cb8-26" aria-hidden="true" tabindex="-1"></a>simulated_diff_in_diff</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code># A tibble: 2,000 × 4
# Rowwise: 
   person time  treat_group serve_speed
    &lt;int&gt; &lt;fct&gt; &lt;fct&gt;             &lt;dbl&gt;
 1      1 0     0                  4.43
 2      2 0     1                  6.96
 3      3 0     1                  7.77
 4      4 0     0                  5.31
 5      5 0     0                  4.09
 6      6 0     0                  4.85
 7      7 0     0                  6.43
 8      8 0     0                  5.77
 9      9 0     1                  6.13
10     10 0     1                  7.32
# ℹ 1,990 more rows</code></pre>
</div>
</div>
<div class="cell">
<div class="sourceCode cell-code" id="cb10"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb10-1"><a href="#cb10-1" aria-hidden="true" tabindex="-1"></a>simulated_diff_in_diff <span class="sc">|&gt;</span></span>
<span id="cb10-2"><a href="#cb10-2" aria-hidden="true" tabindex="-1"></a>  <span class="fu">ggplot</span>(<span class="fu">aes</span>(<span class="at">x =</span> time, <span class="at">y =</span> serve_speed, <span class="at">color =</span> treat_group)) <span class="sc">+</span></span>
<span id="cb10-3"><a href="#cb10-3" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_point</span>(<span class="at">alpha =</span> <span class="fl">0.2</span>) <span class="sc">+</span></span>
<span id="cb10-4"><a href="#cb10-4" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_line</span>(<span class="fu">aes</span>(<span class="at">group =</span> person), <span class="at">alpha =</span> <span class="fl">0.1</span>) <span class="sc">+</span></span>
<span id="cb10-5"><a href="#cb10-5" aria-hidden="true" tabindex="-1"></a>  <span class="fu">theme_minimal</span>() <span class="sc">+</span></span>
<span id="cb10-6"><a href="#cb10-6" aria-hidden="true" tabindex="-1"></a>  <span class="fu">labs</span>(<span class="at">x =</span> <span class="st">"Time period"</span>, <span class="at">y =</span> <span class="st">"Serve speed"</span>, <span class="at">color =</span> <span class="st">"Person got a new racket"</span>) <span class="sc">+</span></span>
<span id="cb10-7"><a href="#cb10-7" aria-hidden="true" tabindex="-1"></a>  <span class="fu">scale_color_brewer</span>(<span class="at">palette =</span> <span class="st">"Set1"</span>) <span class="sc">+</span></span>
<span id="cb10-8"><a href="#cb10-8" aria-hidden="true" tabindex="-1"></a>  <span class="fu">theme</span>(<span class="at">legend.position =</span> <span class="st">"bottom"</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">
<div id="fig-diffindifftennisracket" class="quarto-figure quarto-figure-center quarto-float anchored">
<figure class="quarto-float quarto-float-fig figure">
<div aria-describedby="fig-diffindifftennisracket-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
<img src="14-causality_from_obs_files/figure-html/fig-diffindifftennisracket-1.png" class="img-fluid figure-img" width="672">
</div>
<figcaption class="quarto-float-caption-bottom quarto-float-caption quarto-float-fig" id="fig-diffindifftennisracket-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
Figure&nbsp;15.4: Illustration of simulated data that shows a difference before and after getting a new tennis racket
</figcaption>
</figure>
</div>
</div>
</div>
<p>We can obtain our estimate manually, by looking at the average difference of the differences. When we do that, we find that we estimate the effect of the new tennis racket to be 5.06, which is similar to what we simulated.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb11"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb11-1"><a href="#cb11-1" aria-hidden="true" tabindex="-1"></a>ave_diff <span class="ot">&lt;-</span></span>
<span id="cb11-2"><a href="#cb11-2" aria-hidden="true" tabindex="-1"></a>  simulated_diff_in_diff <span class="sc">|&gt;</span></span>
<span id="cb11-3"><a href="#cb11-3" aria-hidden="true" tabindex="-1"></a>  <span class="fu">pivot_wider</span>(</span>
<span id="cb11-4"><a href="#cb11-4" aria-hidden="true" tabindex="-1"></a>    <span class="at">names_from =</span> time,</span>
<span id="cb11-5"><a href="#cb11-5" aria-hidden="true" tabindex="-1"></a>    <span class="at">values_from =</span> serve_speed,</span>
<span id="cb11-6"><a href="#cb11-6" aria-hidden="true" tabindex="-1"></a>    <span class="at">names_prefix =</span> <span class="st">"time_"</span></span>
<span id="cb11-7"><a href="#cb11-7" aria-hidden="true" tabindex="-1"></a>  ) <span class="sc">|&gt;</span></span>
<span id="cb11-8"><a href="#cb11-8" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(<span class="at">difference =</span> time_1 <span class="sc">-</span> time_0) <span class="sc">|&gt;</span></span>
<span id="cb11-9"><a href="#cb11-9" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Average difference between old and new racket serve speed within groups</span></span>
<span id="cb11-10"><a href="#cb11-10" aria-hidden="true" tabindex="-1"></a>  <span class="fu">summarise</span>(<span class="at">average_difference =</span> <span class="fu">mean</span>(difference),</span>
<span id="cb11-11"><a href="#cb11-11" aria-hidden="true" tabindex="-1"></a>            <span class="at">.by =</span> treat_group)</span>
<span id="cb11-12"><a href="#cb11-12" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb11-13"><a href="#cb11-13" aria-hidden="true" tabindex="-1"></a><span class="co"># Difference between the average differences of each group</span></span>
<span id="cb11-14"><a href="#cb11-14" aria-hidden="true" tabindex="-1"></a>ave_diff<span class="sc">$</span>average_difference[<span class="dv">2</span>] <span class="sc">-</span> ave_diff<span class="sc">$</span>average_difference[<span class="dv">1</span>]</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>[1] 5.058414</code></pre>
</div>
</div>
<p>And we can use linear regression to get the same result. The model we are interested in is:</p>
<p><span class="math display">\[Y_{i,t} = \beta_0 + \beta_1\times\mbox{Treatment}_i + \beta_2\times\mbox{Time}_t + \beta_3\times(\mbox{Treatment} \times\mbox{Time})_{i,t} + \epsilon_{i,t}\]</span></p>
<p>While we should include the separate aspects as well, it is the estimate of the interaction that we are interested in. In this case it is <span class="math inline">\(\beta_3\)</span>. And we find that our estimated effect is 5.06 (<a href="#tbl-diffindifftennisracket" class="quarto-xref">Table&nbsp;<span>15.1</span></a>).</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb13"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb13-1"><a href="#cb13-1" aria-hidden="true" tabindex="-1"></a>diff_in_diff_example_regression <span class="ot">&lt;-</span></span>
<span id="cb13-2"><a href="#cb13-2" aria-hidden="true" tabindex="-1"></a>  <span class="fu">stan_glm</span>(</span>
<span id="cb13-3"><a href="#cb13-3" aria-hidden="true" tabindex="-1"></a>    <span class="at">formula =</span> serve_speed <span class="sc">~</span> treat_group <span class="sc">*</span> time,</span>
<span id="cb13-4"><a href="#cb13-4" aria-hidden="true" tabindex="-1"></a>    <span class="at">data =</span> simulated_diff_in_diff,</span>
<span id="cb13-5"><a href="#cb13-5" aria-hidden="true" tabindex="-1"></a>    <span class="at">family =</span> <span class="fu">gaussian</span>(),</span>
<span id="cb13-6"><a href="#cb13-6" aria-hidden="true" tabindex="-1"></a>    <span class="at">prior =</span> <span class="fu">normal</span>(<span class="at">location =</span> <span class="dv">0</span>, <span class="at">scale =</span> <span class="fl">2.5</span>, <span class="at">autoscale =</span> <span class="cn">TRUE</span>),</span>
<span id="cb13-7"><a href="#cb13-7" aria-hidden="true" tabindex="-1"></a>    <span class="at">prior_intercept =</span> <span class="fu">normal</span>(<span class="dv">0</span>, <span class="fl">2.5</span>, <span class="at">autoscale =</span> <span class="cn">TRUE</span>),</span>
<span id="cb13-8"><a href="#cb13-8" aria-hidden="true" tabindex="-1"></a>    <span class="at">prior_aux =</span> <span class="fu">exponential</span>(<span class="at">rate =</span> <span class="dv">1</span>, <span class="at">autoscale =</span> <span class="cn">TRUE</span>),</span>
<span id="cb13-9"><a href="#cb13-9" aria-hidden="true" tabindex="-1"></a>    <span class="at">seed =</span> <span class="dv">853</span></span>
<span id="cb13-10"><a href="#cb13-10" aria-hidden="true" tabindex="-1"></a>  )</span>
<span id="cb13-11"><a href="#cb13-11" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb13-12"><a href="#cb13-12" aria-hidden="true" tabindex="-1"></a><span class="fu">saveRDS</span>(</span>
<span id="cb13-13"><a href="#cb13-13" aria-hidden="true" tabindex="-1"></a>  diff_in_diff_example_regression,</span>
<span id="cb13-14"><a href="#cb13-14" aria-hidden="true" tabindex="-1"></a>  <span class="at">file =</span> <span class="st">"diff_in_diff_example_regression.rds"</span></span>
<span id="cb13-15"><a href="#cb13-15" aria-hidden="true" tabindex="-1"></a>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div class="cell">
<div class="sourceCode cell-code" id="cb14"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb14-1"><a href="#cb14-1" aria-hidden="true" tabindex="-1"></a>diff_in_diff_example_regression <span class="ot">&lt;-</span></span>
<span id="cb14-2"><a href="#cb14-2" aria-hidden="true" tabindex="-1"></a>  <span class="fu">readRDS</span>(<span class="at">file =</span> <span class="st">"diff_in_diff_example_regression.rds"</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div class="cell">
<div class="sourceCode cell-code" id="cb15"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb15-1"><a href="#cb15-1" aria-hidden="true" tabindex="-1"></a><span class="fu">modelsummary</span>(</span>
<span id="cb15-2"><a href="#cb15-2" aria-hidden="true" tabindex="-1"></a>  diff_in_diff_example_regression</span>
<span id="cb15-3"><a href="#cb15-3" aria-hidden="true" tabindex="-1"></a>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div id="tbl-diffindifftennisracket" class="cell quarto-float anchored">
<figure class="quarto-float quarto-float-tbl figure">
<figcaption class="quarto-float-caption-top quarto-float-caption quarto-float-tbl" id="tbl-diffindifftennisracket-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
Table&nbsp;15.1: Illustration of simulated data that shows a difference before and after getting a new tennis racket
</figcaption>
<div aria-describedby="tbl-diffindifftennisracket-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
<div class="cell-output-display">
<!-- preamble start -->

    <script>
      function styleCell_wikheynuh4fnfkdllb44(i, j, css_id) {
        var table = document.getElementById("tinytable_wikheynuh4fnfkdllb44");
        table.rows[i].cells[j].classList.add(css_id);
      }
      function insertSpanRow(i, colspan, content) {
        var table = document.getElementById('tinytable_wikheynuh4fnfkdllb44');
        var newRow = table.insertRow(i);
        var newCell = newRow.insertCell(0);
        newCell.setAttribute("colspan", colspan);
        // newCell.innerText = content;
        // this may be unsafe, but innerText does not interpret <br>
        newCell.innerHTML = content;
      }
      function spanCell_wikheynuh4fnfkdllb44(i, j, rowspan, colspan) {
        var table = document.getElementById("tinytable_wikheynuh4fnfkdllb44");
        const targetRow = table.rows[i];
        const targetCell = targetRow.cells[j];
        for (let r = 0; r < rowspan; r++) {
          // Only start deleting cells to the right for the first row (r == 0)
          if (r === 0) {
            // Delete cells to the right of the target cell in the first row
            for (let c = colspan - 1; c > 0; c--) {
              if (table.rows[i + r].cells[j + c]) {
                table.rows[i + r].deleteCell(j + c);
              }
            }
          }
          // For rows below the first, delete starting from the target column
          if (r > 0) {
            for (let c = colspan - 1; c >= 0; c--) {
              if (table.rows[i + r] && table.rows[i + r].cells[j]) {
                table.rows[i + r].deleteCell(j);
              }
            }
          }
        }
        // Set rowspan and colspan of the target cell
        targetCell.rowSpan = rowspan;
        targetCell.colSpan = colspan;
      }
window.addEventListener('load', function () { styleCell_wikheynuh4fnfkdllb44(0, 0, 'tinytable_css_idkamjdduc6n4wfvyn0y2f') })
window.addEventListener('load', function () { styleCell_wikheynuh4fnfkdllb44(0, 1, 'tinytable_css_idka936lh6462uiiphrmon') })
window.addEventListener('load', function () { styleCell_wikheynuh4fnfkdllb44(1, 0, 'tinytable_css_id219bxyucwbtc2ww2ry4a') })
window.addEventListener('load', function () { styleCell_wikheynuh4fnfkdllb44(1, 1, 'tinytable_css_iddm0lx2get3kiglx27eeo') })
window.addEventListener('load', function () { styleCell_wikheynuh4fnfkdllb44(2, 0, 'tinytable_css_id219bxyucwbtc2ww2ry4a') })
window.addEventListener('load', function () { styleCell_wikheynuh4fnfkdllb44(2, 1, 'tinytable_css_iddm0lx2get3kiglx27eeo') })
window.addEventListener('load', function () { styleCell_wikheynuh4fnfkdllb44(3, 0, 'tinytable_css_id219bxyucwbtc2ww2ry4a') })
window.addEventListener('load', function () { styleCell_wikheynuh4fnfkdllb44(3, 1, 'tinytable_css_iddm0lx2get3kiglx27eeo') })
window.addEventListener('load', function () { styleCell_wikheynuh4fnfkdllb44(4, 0, 'tinytable_css_idoa27yl9fdbgwbfkrfm72') })
window.addEventListener('load', function () { styleCell_wikheynuh4fnfkdllb44(4, 1, 'tinytable_css_idftbaxn04rbybt0t05lhq') })
window.addEventListener('load', function () { styleCell_wikheynuh4fnfkdllb44(5, 0, 'tinytable_css_id219bxyucwbtc2ww2ry4a') })
window.addEventListener('load', function () { styleCell_wikheynuh4fnfkdllb44(5, 1, 'tinytable_css_iddm0lx2get3kiglx27eeo') })
window.addEventListener('load', function () { styleCell_wikheynuh4fnfkdllb44(6, 0, 'tinytable_css_id219bxyucwbtc2ww2ry4a') })
window.addEventListener('load', function () { styleCell_wikheynuh4fnfkdllb44(6, 1, 'tinytable_css_iddm0lx2get3kiglx27eeo') })
window.addEventListener('load', function () { styleCell_wikheynuh4fnfkdllb44(7, 0, 'tinytable_css_id219bxyucwbtc2ww2ry4a') })
window.addEventListener('load', function () { styleCell_wikheynuh4fnfkdllb44(7, 1, 'tinytable_css_iddm0lx2get3kiglx27eeo') })
window.addEventListener('load', function () { styleCell_wikheynuh4fnfkdllb44(8, 0, 'tinytable_css_id219bxyucwbtc2ww2ry4a') })
window.addEventListener('load', function () { styleCell_wikheynuh4fnfkdllb44(8, 1, 'tinytable_css_iddm0lx2get3kiglx27eeo') })
window.addEventListener('load', function () { styleCell_wikheynuh4fnfkdllb44(9, 0, 'tinytable_css_id219bxyucwbtc2ww2ry4a') })
window.addEventListener('load', function () { styleCell_wikheynuh4fnfkdllb44(9, 1, 'tinytable_css_iddm0lx2get3kiglx27eeo') })
window.addEventListener('load', function () { styleCell_wikheynuh4fnfkdllb44(10, 0, 'tinytable_css_id219bxyucwbtc2ww2ry4a') })
window.addEventListener('load', function () { styleCell_wikheynuh4fnfkdllb44(10, 1, 'tinytable_css_iddm0lx2get3kiglx27eeo') })
window.addEventListener('load', function () { styleCell_wikheynuh4fnfkdllb44(11, 0, 'tinytable_css_id219bxyucwbtc2ww2ry4a') })
window.addEventListener('load', function () { styleCell_wikheynuh4fnfkdllb44(11, 1, 'tinytable_css_iddm0lx2get3kiglx27eeo') })
window.addEventListener('load', function () { styleCell_wikheynuh4fnfkdllb44(12, 0, 'tinytable_css_id219bxyucwbtc2ww2ry4a') })
window.addEventListener('load', function () { styleCell_wikheynuh4fnfkdllb44(12, 1, 'tinytable_css_iddm0lx2get3kiglx27eeo') })
window.addEventListener('load', function () { styleCell_wikheynuh4fnfkdllb44(13, 0, 'tinytable_css_id219bxyucwbtc2ww2ry4a') })
window.addEventListener('load', function () { styleCell_wikheynuh4fnfkdllb44(13, 1, 'tinytable_css_iddm0lx2get3kiglx27eeo') })
window.addEventListener('load', function () { styleCell_wikheynuh4fnfkdllb44(14, 0, 'tinytable_css_id219bxyucwbtc2ww2ry4a') })
window.addEventListener('load', function () { styleCell_wikheynuh4fnfkdllb44(14, 1, 'tinytable_css_iddm0lx2get3kiglx27eeo') })
    </script>

    <style>
    .table td.tinytable_css_idkamjdduc6n4wfvyn0y2f, .table th.tinytable_css_idkamjdduc6n4wfvyn0y2f {  text-align: left;  border-bottom: solid 0.1em #d3d8dc; }
    .table td.tinytable_css_idka936lh6462uiiphrmon, .table th.tinytable_css_idka936lh6462uiiphrmon {  text-align: center;  border-bottom: solid 0.1em #d3d8dc; }
    .table td.tinytable_css_id219bxyucwbtc2ww2ry4a, .table th.tinytable_css_id219bxyucwbtc2ww2ry4a {  text-align: left; }
    .table td.tinytable_css_iddm0lx2get3kiglx27eeo, .table th.tinytable_css_iddm0lx2get3kiglx27eeo {  text-align: center; }
    .table td.tinytable_css_idoa27yl9fdbgwbfkrfm72, .table th.tinytable_css_idoa27yl9fdbgwbfkrfm72 {  border-bottom: solid 0.05em black;  text-align: left; }
    .table td.tinytable_css_idftbaxn04rbybt0t05lhq, .table th.tinytable_css_idftbaxn04rbybt0t05lhq {  border-bottom: solid 0.05em black;  text-align: center; }
    </style>
    <div class="container">
      <table class="table table-borderless" id="tinytable_wikheynuh4fnfkdllb44" style="width: auto; margin-left: auto; margin-right: auto;" data-quarto-disable-processing="true">
        <thead>
        
              <tr>
                <th scope="col"> </th>
                <th scope="col">(1)</th>
              </tr>
        </thead>
        
        <tbody>
                <tr>
                  <td>(Intercept)             </td>
                  <td>4.971    </td>
                </tr>
                <tr>
                  <td>treatment_group1        </td>
                  <td>3.035    </td>
                </tr>
                <tr>
                  <td>time1                   </td>
                  <td>1.006    </td>
                </tr>
                <tr>
                  <td>treatment_group1 × time1</td>
                  <td>5.057    </td>
                </tr>
                <tr>
                  <td>Num.Obs.                </td>
                  <td>2000     </td>
                </tr>
                <tr>
                  <td>R2                      </td>
                  <td>0.927    </td>
                </tr>
                <tr>
                  <td>R2 Adj.                 </td>
                  <td>0.927    </td>
                </tr>
                <tr>
                  <td>Log.Lik.                </td>
                  <td>-2802.166</td>
                </tr>
                <tr>
                  <td>ELPD                    </td>
                  <td>-2806.3  </td>
                </tr>
                <tr>
                  <td>ELPD s.e.               </td>
                  <td>32.1     </td>
                </tr>
                <tr>
                  <td>LOOIC                   </td>
                  <td>5612.5   </td>
                </tr>
                <tr>
                  <td>LOOIC s.e.              </td>
                  <td>64.2     </td>
                </tr>
                <tr>
                  <td>WAIC                    </td>
                  <td>5612.5   </td>
                </tr>
                <tr>
                  <td>RMSE                    </td>
                  <td>0.98     </td>
                </tr>
        </tbody>
      </table>
    </div>
<!-- hack to avoid NA insertion in last line -->
</div>
</div>
</figure>
</div>
</div>
</section>
<section id="assumptions" class="level3" data-number="15.3.2">
<h3 data-number="15.3.2" class="anchored" data-anchor-id="assumptions"><span class="header-section-number">15.3.2</span> Assumptions</h3>
<p>If we want to use difference-in-differences, then we need to satisfy the assumptions. There were three that were touched on earlier, but here we will focus on the “parallel trends” assumption. The parallel trends assumption haunts everything to do with difference-in-differences analysis because we can never prove it; we can just be convinced of it, and try to convince others.</p>
<p>To see why we can never prove it, consider an example in which we want to know the effect of a new stadium on a professional sports team’s wins/loses. To do this we consider two professional basketball teams: the Golden State Warriors and the Toronto Raptors. The Warriors changed stadiums at the start of the 2019-20 season, while the Raptors did not, so we will consider four time periods: the 2016-17 season, 2017-18 season, 2018-19 season, and finally we will compare the performance with the one after they moved, so the 2019-20 season. The Raptors here act as our counterfactual. This means that we assume the relationship between the Warriors and the Raptors, in the absence of a new stadium, would have continued to change in a consistent way. But the fundamental problem of causal inference means that we can never know that for certain. We must present sufficient evidence to assuage any concerns that a reader may have.</p>
<p>There are four main threats to validity when we use difference-in-differences, and we need to address all of them <span class="citation" data-cites="Cunningham2021">(<a href="99-references.html#ref-Cunningham2021" role="doc-biblioref">Cunningham 2021, 272–77</a>)</span>:</p>
<ol type="1">
<li>Non-parallel trends. The treatment and control groups may be based on differences. As such it can be difficult to convincingly argue for parallel trends. In this case, maybe try to find another factor to consider in your model that may adjust for some of that. This may require triple-differenced approaches. For instance, in the earlier example, we could perhaps add the San Francisco 49ers, a football team, as they are in the same broad geographic area as the Warriors. Or maybe rethink the analysis to see if we can make a different control group. Adding additional earlier time periods may help but may introduce more issues, which we touch on in the third point.</li>
<li>Compositional differences. This is a concern when working with repeated cross-sections. What if the composition of those cross-sections change? For instance, if we are working at an app that is rapidly growing, and we want to look at the effect of some change. In our initial cross-section, we may have mostly young people, but in a subsequent cross-section, we may have more older people as the demographics of the app usage change. Hence our results may just be an age-effect, not an effect of the change that we are interested in.</li>
<li>Long-term effects compared with reliability. As we discussed in <a href="08-hunt.html" class="quarto-xref"><span>Chapter 8</span></a>, there is a trade-off between the length of the analysis that we run. As we run the analysis for longer there is more opportunity for other factors to affect the results. There is also increased chance for someone who was not treated to be treated. But, on the other hand, it can be difficult to convincingly argue that short-term results will continue in the long term.</li>
<li>Functional form dependence. This is less of an issue when the outcomes are similar, but if they are different then functional form may be responsible for some aspects of the results.</li>
</ol>
</section>
<section id="french-newspaper-prices-between-1960-and-1974" class="level3" data-number="15.3.3">
<h3 data-number="15.3.3" class="anchored" data-anchor-id="french-newspaper-prices-between-1960-and-1974"><span class="header-section-number">15.3.3</span> French newspaper prices between 1960 and 1974</h3>
<p>In this case study we introduce <span class="citation" data-cites="angelucci2019newspapers">Angelucci and Cagé (<a href="99-references.html#ref-angelucci2019newspapers" role="doc-biblioref">2019</a>)</span>. They are interested in understanding the effect of the introduction of television on French newspapers. We will replicate one of the main findings.</p>
<p>The business model of newspapers has been challenged by the internet and many local newspapers have closed. This issue is not new. When television was introduced, there were similar concerns. <span class="citation" data-cites="angelucci2019newspapers">Angelucci and Cagé (<a href="99-references.html#ref-angelucci2019newspapers" role="doc-biblioref">2019</a>)</span> use the introduction of television advertising in France, announced in 1967, to examine the effect of decreased advertising revenue on newspapers. They create a dataset of French newspapers from 1960 to 1974 and then use difference-in-differences to examine the effect of the reduction in advertising revenues on newspapers’ content and prices. The change that they focus on is the introduction of television advertising, which they argue affected national newspapers more than local newspapers. They find that this change results in both less journalism content in the newspapers and lower newspaper prices. Focusing on this change, and analyzing it using difference-in-differences, is important because it allows us to disentangle a few competing effects. For instance, did newspapers become redundant because they could no longer charge high prices for their advertisements, or because consumers preferred to get their news from the television?</p>
<p>We can get free access to the <a href="https://www.openicpsr.org/openicpsr/project/116438/version/V1/view">data</a> that underpins <span class="citation" data-cites="angelucci2019newspapers">Angelucci and Cagé (<a href="99-references.html#ref-angelucci2019newspapers" role="doc-biblioref">2019</a>)</span> after registration. The dataset is in the Stata data format, “.dta”, which we can read with <code>read_dta()</code> from <code>haven</code>. The file that we are interested in is “Angelucci_Cage_AEJMicro_dataset.dta”, which is the “dta” folder.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb16"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb16-1"><a href="#cb16-1" aria-hidden="true" tabindex="-1"></a>newspapers <span class="ot">&lt;-</span> <span class="fu">read_dta</span>(<span class="st">"Angelucci_Cage_AEJMicro_dataset.dta"</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>There are 1,196 observations in the dataset and 52 variables. <span class="citation" data-cites="angelucci2019newspapers">Angelucci and Cagé (<a href="99-references.html#ref-angelucci2019newspapers" role="doc-biblioref">2019</a>)</span> are interested in the 1960-1974 time period which has around 100 newspapers. There are 14 national newspapers at the beginning of the period and 12 at the end. The key period is 1967, when the French government announced it would allow advertising on television. <span class="citation" data-cites="angelucci2019newspapers">Angelucci and Cagé (<a href="99-references.html#ref-angelucci2019newspapers" role="doc-biblioref">2019</a>)</span> argue that national newspapers were affected by this change, but local newspapers were not. The national newspapers are the treatment group and the local newspapers are the control group.</p>
<p>We focus just on the headline difference-in-differences result and construct summary statistics.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb17"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb17-1"><a href="#cb17-1" aria-hidden="true" tabindex="-1"></a>newspapers <span class="ot">&lt;-</span></span>
<span id="cb17-2"><a href="#cb17-2" aria-hidden="true" tabindex="-1"></a>  newspapers <span class="sc">|&gt;</span></span>
<span id="cb17-3"><a href="#cb17-3" aria-hidden="true" tabindex="-1"></a>  <span class="fu">select</span>(</span>
<span id="cb17-4"><a href="#cb17-4" aria-hidden="true" tabindex="-1"></a>    year, id_news, after_national, local, national, ra_cst, ps_cst, qtotal</span>
<span id="cb17-5"><a href="#cb17-5" aria-hidden="true" tabindex="-1"></a>    ) <span class="sc">|&gt;</span> </span>
<span id="cb17-6"><a href="#cb17-6" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(<span class="at">ra_cst_div_qtotal =</span> ra_cst <span class="sc">/</span> qtotal, </span>
<span id="cb17-7"><a href="#cb17-7" aria-hidden="true" tabindex="-1"></a>         <span class="fu">across</span>(<span class="fu">c</span>(id_news, after_national, local, national), as.factor),</span>
<span id="cb17-8"><a href="#cb17-8" aria-hidden="true" tabindex="-1"></a>         <span class="at">year =</span> <span class="fu">as.integer</span>(year))</span>
<span id="cb17-9"><a href="#cb17-9" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb17-10"><a href="#cb17-10" aria-hidden="true" tabindex="-1"></a>newspapers</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code># A tibble: 1,196 × 9
    year id_news after_national local national    ra_cst ps_cst  qtotal
   &lt;int&gt; &lt;fct&gt;   &lt;fct&gt;          &lt;fct&gt; &lt;fct&gt;        &lt;dbl&gt;  &lt;dbl&gt;   &lt;dbl&gt;
 1  1960 1       0              1     0         52890272   2.29  94478.
 2  1961 1       0              1     0         56601060   2.20  96289.
 3  1962 1       0              1     0         64840752   2.13  97313.
 4  1963 1       0              1     0         70582944   2.43 101068.
 5  1964 1       0              1     0         74977888   2.35 102103.
 6  1965 1       0              1     0         74438248   2.29 105169.
 7  1966 1       0              1     0         81383000   2.31 126235.
 8  1967 1       0              1     0         80263152   2.88 128667.
 9  1968 1       0              1     0         87165704   3.45 131824.
10  1969 1       0              1     0        102596384   3.28 132417.
# ℹ 1,186 more rows
# ℹ 1 more variable: ra_cst_div_qtotal &lt;dbl&gt;</code></pre>
</div>
</div>
<p>We are interested in what happened from 1967 onward, especially in terms of advertising revenue, and whether that was different for national, compared with local newspapers (<a href="#fig-frenchnewspapersrevenue" class="quarto-xref">Figure&nbsp;<span>15.5</span></a>). We use <code>scales</code> to adjust the y-axis.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb19"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb19-1"><a href="#cb19-1" aria-hidden="true" tabindex="-1"></a>newspapers <span class="sc">|&gt;</span></span>
<span id="cb19-2"><a href="#cb19-2" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(<span class="at">type =</span> <span class="fu">if_else</span>(local <span class="sc">==</span> <span class="dv">1</span>, <span class="st">"Local"</span>, <span class="st">"National"</span>)) <span class="sc">|&gt;</span></span>
<span id="cb19-3"><a href="#cb19-3" aria-hidden="true" tabindex="-1"></a>  <span class="fu">ggplot</span>(<span class="fu">aes</span>(<span class="at">x =</span> year, <span class="at">y =</span> ra_cst)) <span class="sc">+</span></span>
<span id="cb19-4"><a href="#cb19-4" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_point</span>(<span class="at">alpha =</span> <span class="fl">0.5</span>) <span class="sc">+</span></span>
<span id="cb19-5"><a href="#cb19-5" aria-hidden="true" tabindex="-1"></a>  <span class="fu">scale_y_continuous</span>(</span>
<span id="cb19-6"><a href="#cb19-6" aria-hidden="true" tabindex="-1"></a>    <span class="at">labels =</span> <span class="fu">dollar_format</span>(</span>
<span id="cb19-7"><a href="#cb19-7" aria-hidden="true" tabindex="-1"></a>      <span class="at">prefix =</span> <span class="st">"$"</span>,</span>
<span id="cb19-8"><a href="#cb19-8" aria-hidden="true" tabindex="-1"></a>      <span class="at">suffix =</span> <span class="st">"M"</span>,</span>
<span id="cb19-9"><a href="#cb19-9" aria-hidden="true" tabindex="-1"></a>      <span class="at">scale =</span> <span class="fl">0.000001</span>)) <span class="sc">+</span></span>
<span id="cb19-10"><a href="#cb19-10" aria-hidden="true" tabindex="-1"></a>  <span class="fu">labs</span>(<span class="at">x =</span> <span class="st">"Year"</span>, <span class="at">y =</span> <span class="st">"Advertising revenue"</span>) <span class="sc">+</span></span>
<span id="cb19-11"><a href="#cb19-11" aria-hidden="true" tabindex="-1"></a>  <span class="fu">facet_wrap</span>(<span class="fu">vars</span>(type), <span class="at">nrow =</span> <span class="dv">2</span>) <span class="sc">+</span></span>
<span id="cb19-12"><a href="#cb19-12" aria-hidden="true" tabindex="-1"></a>  <span class="fu">theme_minimal</span>() <span class="sc">+</span></span>
<span id="cb19-13"><a href="#cb19-13" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_vline</span>(<span class="at">xintercept =</span> <span class="fl">1966.5</span>, <span class="at">linetype =</span> <span class="st">"dashed"</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">
<div id="fig-frenchnewspapersrevenue" class="quarto-figure quarto-figure-center quarto-float anchored">
<figure class="quarto-float quarto-float-fig figure">
<div aria-describedby="fig-frenchnewspapersrevenue-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
<img src="14-causality_from_obs_files/figure-html/fig-frenchnewspapersrevenue-1.png" class="img-fluid figure-img" width="672">
</div>
<figcaption class="quarto-float-caption-bottom quarto-float-caption quarto-float-fig" id="fig-frenchnewspapersrevenue-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
Figure&nbsp;15.5: Revenue of French newspapers (1960-1974), by whether they were local or national
</figcaption>
</figure>
</div>
</div>
</div>
<p>The model that we are interested in estimating is:</p>
<p><span class="math display">\[\mbox{ln}(y_{n,t}) = \beta_0 + \beta_1\times(\mbox{National binary}\times\mbox{1967 onward binary}) + \lambda_n + \gamma_t + \epsilon\]</span></p>
<p>It is the <span class="math inline">\(\beta_1\)</span> coefficient that we are especially interested in. We estimate the models using <code>stan_glm()</code>.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb20"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb20-1"><a href="#cb20-1" aria-hidden="true" tabindex="-1"></a>ad_revenue <span class="ot">&lt;-</span></span>
<span id="cb20-2"><a href="#cb20-2" aria-hidden="true" tabindex="-1"></a>  <span class="fu">stan_glm</span>(</span>
<span id="cb20-3"><a href="#cb20-3" aria-hidden="true" tabindex="-1"></a>    <span class="at">formula =</span> <span class="fu">log</span>(ra_cst) <span class="sc">~</span> after_national <span class="sc">+</span> id_news <span class="sc">+</span> year,</span>
<span id="cb20-4"><a href="#cb20-4" aria-hidden="true" tabindex="-1"></a>    <span class="at">data =</span> newspapers,</span>
<span id="cb20-5"><a href="#cb20-5" aria-hidden="true" tabindex="-1"></a>    <span class="at">family =</span> <span class="fu">gaussian</span>(),</span>
<span id="cb20-6"><a href="#cb20-6" aria-hidden="true" tabindex="-1"></a>    <span class="at">prior =</span> <span class="fu">normal</span>(<span class="at">location =</span> <span class="dv">0</span>, <span class="at">scale =</span> <span class="fl">2.5</span>, <span class="at">autoscale =</span> <span class="cn">TRUE</span>),</span>
<span id="cb20-7"><a href="#cb20-7" aria-hidden="true" tabindex="-1"></a>    <span class="at">prior_intercept =</span> <span class="fu">normal</span>(<span class="dv">0</span>, <span class="fl">2.5</span>, <span class="at">autoscale =</span> <span class="cn">TRUE</span>),</span>
<span id="cb20-8"><a href="#cb20-8" aria-hidden="true" tabindex="-1"></a>    <span class="at">prior_aux =</span> <span class="fu">exponential</span>(<span class="at">rate =</span> <span class="dv">1</span>, <span class="at">autoscale =</span> <span class="cn">TRUE</span>),</span>
<span id="cb20-9"><a href="#cb20-9" aria-hidden="true" tabindex="-1"></a>    <span class="at">seed =</span> <span class="dv">853</span></span>
<span id="cb20-10"><a href="#cb20-10" aria-hidden="true" tabindex="-1"></a>  )</span>
<span id="cb20-11"><a href="#cb20-11" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb20-12"><a href="#cb20-12" aria-hidden="true" tabindex="-1"></a><span class="fu">saveRDS</span>(</span>
<span id="cb20-13"><a href="#cb20-13" aria-hidden="true" tabindex="-1"></a>  ad_revenue,</span>
<span id="cb20-14"><a href="#cb20-14" aria-hidden="true" tabindex="-1"></a>  <span class="at">file =</span> <span class="st">"ad_revenue.rds"</span></span>
<span id="cb20-15"><a href="#cb20-15" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb20-16"><a href="#cb20-16" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb20-17"><a href="#cb20-17" aria-hidden="true" tabindex="-1"></a>ad_revenue_div_circulation <span class="ot">&lt;-</span></span>
<span id="cb20-18"><a href="#cb20-18" aria-hidden="true" tabindex="-1"></a>  <span class="fu">stan_glm</span>(</span>
<span id="cb20-19"><a href="#cb20-19" aria-hidden="true" tabindex="-1"></a>    <span class="at">formula =</span> <span class="fu">log</span>(ra_cst_div_qtotal) <span class="sc">~</span> after_national <span class="sc">+</span> id_news <span class="sc">+</span> year,</span>
<span id="cb20-20"><a href="#cb20-20" aria-hidden="true" tabindex="-1"></a>    <span class="at">data =</span> newspapers,</span>
<span id="cb20-21"><a href="#cb20-21" aria-hidden="true" tabindex="-1"></a>    <span class="at">family =</span> <span class="fu">gaussian</span>(),</span>
<span id="cb20-22"><a href="#cb20-22" aria-hidden="true" tabindex="-1"></a>    <span class="at">prior =</span> <span class="fu">normal</span>(<span class="at">location =</span> <span class="dv">0</span>, <span class="at">scale =</span> <span class="fl">2.5</span>, <span class="at">autoscale =</span> <span class="cn">TRUE</span>),</span>
<span id="cb20-23"><a href="#cb20-23" aria-hidden="true" tabindex="-1"></a>    <span class="at">prior_intercept =</span> <span class="fu">normal</span>(<span class="dv">0</span>, <span class="fl">2.5</span>, <span class="at">autoscale =</span> <span class="cn">TRUE</span>),</span>
<span id="cb20-24"><a href="#cb20-24" aria-hidden="true" tabindex="-1"></a>    <span class="at">prior_aux =</span> <span class="fu">exponential</span>(<span class="at">rate =</span> <span class="dv">1</span>, <span class="at">autoscale =</span> <span class="cn">TRUE</span>),</span>
<span id="cb20-25"><a href="#cb20-25" aria-hidden="true" tabindex="-1"></a>    <span class="at">seed =</span> <span class="dv">853</span></span>
<span id="cb20-26"><a href="#cb20-26" aria-hidden="true" tabindex="-1"></a>  )</span>
<span id="cb20-27"><a href="#cb20-27" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb20-28"><a href="#cb20-28" aria-hidden="true" tabindex="-1"></a><span class="fu">saveRDS</span>(</span>
<span id="cb20-29"><a href="#cb20-29" aria-hidden="true" tabindex="-1"></a>  ad_revenue_div_circulation,</span>
<span id="cb20-30"><a href="#cb20-30" aria-hidden="true" tabindex="-1"></a>  <span class="at">file =</span> <span class="st">"ad_revenue_div_circulation.rds"</span></span>
<span id="cb20-31"><a href="#cb20-31" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb20-32"><a href="#cb20-32" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb20-33"><a href="#cb20-33" aria-hidden="true" tabindex="-1"></a><span class="co"># Consumer side</span></span>
<span id="cb20-34"><a href="#cb20-34" aria-hidden="true" tabindex="-1"></a>subscription_price <span class="ot">&lt;-</span></span>
<span id="cb20-35"><a href="#cb20-35" aria-hidden="true" tabindex="-1"></a>  <span class="fu">stan_glm</span>(</span>
<span id="cb20-36"><a href="#cb20-36" aria-hidden="true" tabindex="-1"></a>    <span class="at">formula =</span> <span class="fu">log</span>(ps_cst) <span class="sc">~</span> after_national <span class="sc">+</span> id_news <span class="sc">+</span> year,</span>
<span id="cb20-37"><a href="#cb20-37" aria-hidden="true" tabindex="-1"></a>    <span class="at">data =</span> newspapers,</span>
<span id="cb20-38"><a href="#cb20-38" aria-hidden="true" tabindex="-1"></a>    <span class="at">family =</span> <span class="fu">gaussian</span>(),</span>
<span id="cb20-39"><a href="#cb20-39" aria-hidden="true" tabindex="-1"></a>    <span class="at">prior =</span> <span class="fu">normal</span>(<span class="at">location =</span> <span class="dv">0</span>, <span class="at">scale =</span> <span class="fl">2.5</span>, <span class="at">autoscale =</span> <span class="cn">TRUE</span>),</span>
<span id="cb20-40"><a href="#cb20-40" aria-hidden="true" tabindex="-1"></a>    <span class="at">prior_intercept =</span> <span class="fu">normal</span>(<span class="dv">0</span>, <span class="fl">2.5</span>, <span class="at">autoscale =</span> <span class="cn">TRUE</span>),</span>
<span id="cb20-41"><a href="#cb20-41" aria-hidden="true" tabindex="-1"></a>    <span class="at">prior_aux =</span> <span class="fu">exponential</span>(<span class="at">rate =</span> <span class="dv">1</span>, <span class="at">autoscale =</span> <span class="cn">TRUE</span>),</span>
<span id="cb20-42"><a href="#cb20-42" aria-hidden="true" tabindex="-1"></a>    <span class="at">seed =</span> <span class="dv">853</span></span>
<span id="cb20-43"><a href="#cb20-43" aria-hidden="true" tabindex="-1"></a>  )</span>
<span id="cb20-44"><a href="#cb20-44" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb20-45"><a href="#cb20-45" aria-hidden="true" tabindex="-1"></a><span class="fu">saveRDS</span>(</span>
<span id="cb20-46"><a href="#cb20-46" aria-hidden="true" tabindex="-1"></a>  subscription_price,</span>
<span id="cb20-47"><a href="#cb20-47" aria-hidden="true" tabindex="-1"></a>  <span class="at">file =</span> <span class="st">"subscription_price.rds"</span></span>
<span id="cb20-48"><a href="#cb20-48" aria-hidden="true" tabindex="-1"></a>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div class="cell">
<div class="sourceCode cell-code" id="cb21"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb21-1"><a href="#cb21-1" aria-hidden="true" tabindex="-1"></a>ad_revenue <span class="ot">&lt;-</span></span>
<span id="cb21-2"><a href="#cb21-2" aria-hidden="true" tabindex="-1"></a>  <span class="fu">readRDS</span>(<span class="at">file =</span> <span class="st">"ad_revenue.rds"</span>)</span>
<span id="cb21-3"><a href="#cb21-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb21-4"><a href="#cb21-4" aria-hidden="true" tabindex="-1"></a>ad_revenue_div_circulation <span class="ot">&lt;-</span></span>
<span id="cb21-5"><a href="#cb21-5" aria-hidden="true" tabindex="-1"></a>  <span class="fu">readRDS</span>(<span class="at">file =</span> <span class="st">"ad_revenue_div_circulation"</span>)</span>
<span id="cb21-6"><a href="#cb21-6" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb21-7"><a href="#cb21-7" aria-hidden="true" tabindex="-1"></a>subscription_price <span class="ot">&lt;-</span></span>
<span id="cb21-8"><a href="#cb21-8" aria-hidden="true" tabindex="-1"></a>  <span class="fu">readRDS</span>(<span class="at">file =</span> <span class="st">"subscription_price.rds"</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>Looking at the advertising-side variables, such as revenue and prices, in <a href="#tbl-frenchnewspapersadvertising" class="quarto-xref">Table&nbsp;<span>15.2</span></a> we find consistently negative coefficients.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb22"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb22-1"><a href="#cb22-1" aria-hidden="true" tabindex="-1"></a>selected_variables <span class="ot">&lt;-</span> <span class="fu">c</span>(<span class="st">"year"</span> <span class="ot">=</span> <span class="st">"Year"</span>, <span class="st">"after_national1"</span> <span class="ot">=</span> <span class="st">"After change"</span>)</span>
<span id="cb22-2"><a href="#cb22-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb22-3"><a href="#cb22-3" aria-hidden="true" tabindex="-1"></a><span class="fu">modelsummary</span>(</span>
<span id="cb22-4"><a href="#cb22-4" aria-hidden="true" tabindex="-1"></a>  <span class="at">models =</span> <span class="fu">list</span>(</span>
<span id="cb22-5"><a href="#cb22-5" aria-hidden="true" tabindex="-1"></a>    <span class="st">"Ad revenue"</span> <span class="ot">=</span> ad_revenue,</span>
<span id="cb22-6"><a href="#cb22-6" aria-hidden="true" tabindex="-1"></a>    <span class="st">"Ad revenue over circulation"</span> <span class="ot">=</span> ad_revenue_div_circulation,</span>
<span id="cb22-7"><a href="#cb22-7" aria-hidden="true" tabindex="-1"></a>    <span class="st">"Subscription price"</span> <span class="ot">=</span> subscription_price</span>
<span id="cb22-8"><a href="#cb22-8" aria-hidden="true" tabindex="-1"></a>  ),</span>
<span id="cb22-9"><a href="#cb22-9" aria-hidden="true" tabindex="-1"></a>  <span class="at">fmt =</span> <span class="dv">2</span>,</span>
<span id="cb22-10"><a href="#cb22-10" aria-hidden="true" tabindex="-1"></a>  <span class="at">coef_map =</span> selected_variables</span>
<span id="cb22-11"><a href="#cb22-11" aria-hidden="true" tabindex="-1"></a>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div id="tbl-frenchnewspapersadvertising" class="cell quarto-float anchored">
<figure class="quarto-float quarto-float-tbl figure">
<figcaption class="quarto-float-caption-top quarto-float-caption quarto-float-tbl" id="tbl-frenchnewspapersadvertising-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
Table&nbsp;15.2: Effect of changed television advertising laws on revenue of French newspapers (1960-1974)
</figcaption>
<div aria-describedby="tbl-frenchnewspapersadvertising-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
<div class="cell-output-display">
<!-- preamble start -->

    <script>
      function styleCell_sd9ken4qlyfj540mrmo1(i, j, css_id) {
        var table = document.getElementById("tinytable_sd9ken4qlyfj540mrmo1");
        table.rows[i].cells[j].classList.add(css_id);
      }
      function insertSpanRow(i, colspan, content) {
        var table = document.getElementById('tinytable_sd9ken4qlyfj540mrmo1');
        var newRow = table.insertRow(i);
        var newCell = newRow.insertCell(0);
        newCell.setAttribute("colspan", colspan);
        // newCell.innerText = content;
        // this may be unsafe, but innerText does not interpret <br>
        newCell.innerHTML = content;
      }
      function spanCell_sd9ken4qlyfj540mrmo1(i, j, rowspan, colspan) {
        var table = document.getElementById("tinytable_sd9ken4qlyfj540mrmo1");
        const targetRow = table.rows[i];
        const targetCell = targetRow.cells[j];
        for (let r = 0; r < rowspan; r++) {
          // Only start deleting cells to the right for the first row (r == 0)
          if (r === 0) {
            // Delete cells to the right of the target cell in the first row
            for (let c = colspan - 1; c > 0; c--) {
              if (table.rows[i + r].cells[j + c]) {
                table.rows[i + r].deleteCell(j + c);
              }
            }
          }
          // For rows below the first, delete starting from the target column
          if (r > 0) {
            for (let c = colspan - 1; c >= 0; c--) {
              if (table.rows[i + r] && table.rows[i + r].cells[j]) {
                table.rows[i + r].deleteCell(j);
              }
            }
          }
        }
        // Set rowspan and colspan of the target cell
        targetCell.rowSpan = rowspan;
        targetCell.colSpan = colspan;
      }
window.addEventListener('load', function () { styleCell_sd9ken4qlyfj540mrmo1(0, 0, 'tinytable_css_id0wj9sh6hq2dekzhgquwi') })
window.addEventListener('load', function () { styleCell_sd9ken4qlyfj540mrmo1(0, 1, 'tinytable_css_idyajb6dwclbfhn0tmdk1v') })
window.addEventListener('load', function () { styleCell_sd9ken4qlyfj540mrmo1(0, 2, 'tinytable_css_idyajb6dwclbfhn0tmdk1v') })
window.addEventListener('load', function () { styleCell_sd9ken4qlyfj540mrmo1(0, 3, 'tinytable_css_idyajb6dwclbfhn0tmdk1v') })
window.addEventListener('load', function () { styleCell_sd9ken4qlyfj540mrmo1(1, 0, 'tinytable_css_idti97nucwjedyi75spcdh') })
window.addEventListener('load', function () { styleCell_sd9ken4qlyfj540mrmo1(1, 1, 'tinytable_css_idrlcv83hode8zguhy8055') })
window.addEventListener('load', function () { styleCell_sd9ken4qlyfj540mrmo1(1, 2, 'tinytable_css_idrlcv83hode8zguhy8055') })
window.addEventListener('load', function () { styleCell_sd9ken4qlyfj540mrmo1(1, 3, 'tinytable_css_idrlcv83hode8zguhy8055') })
window.addEventListener('load', function () { styleCell_sd9ken4qlyfj540mrmo1(2, 0, 'tinytable_css_idi1g9pfdbr8c11a0oohgm') })
window.addEventListener('load', function () { styleCell_sd9ken4qlyfj540mrmo1(2, 1, 'tinytable_css_id8kfwaup0up7edoztd7eu') })
window.addEventListener('load', function () { styleCell_sd9ken4qlyfj540mrmo1(2, 2, 'tinytable_css_id8kfwaup0up7edoztd7eu') })
window.addEventListener('load', function () { styleCell_sd9ken4qlyfj540mrmo1(2, 3, 'tinytable_css_id8kfwaup0up7edoztd7eu') })
window.addEventListener('load', function () { styleCell_sd9ken4qlyfj540mrmo1(3, 0, 'tinytable_css_idti97nucwjedyi75spcdh') })
window.addEventListener('load', function () { styleCell_sd9ken4qlyfj540mrmo1(3, 1, 'tinytable_css_idrlcv83hode8zguhy8055') })
window.addEventListener('load', function () { styleCell_sd9ken4qlyfj540mrmo1(3, 2, 'tinytable_css_idrlcv83hode8zguhy8055') })
window.addEventListener('load', function () { styleCell_sd9ken4qlyfj540mrmo1(3, 3, 'tinytable_css_idrlcv83hode8zguhy8055') })
window.addEventListener('load', function () { styleCell_sd9ken4qlyfj540mrmo1(4, 0, 'tinytable_css_idti97nucwjedyi75spcdh') })
window.addEventListener('load', function () { styleCell_sd9ken4qlyfj540mrmo1(4, 1, 'tinytable_css_idrlcv83hode8zguhy8055') })
window.addEventListener('load', function () { styleCell_sd9ken4qlyfj540mrmo1(4, 2, 'tinytable_css_idrlcv83hode8zguhy8055') })
window.addEventListener('load', function () { styleCell_sd9ken4qlyfj540mrmo1(4, 3, 'tinytable_css_idrlcv83hode8zguhy8055') })
window.addEventListener('load', function () { styleCell_sd9ken4qlyfj540mrmo1(5, 0, 'tinytable_css_idti97nucwjedyi75spcdh') })
window.addEventListener('load', function () { styleCell_sd9ken4qlyfj540mrmo1(5, 1, 'tinytable_css_idrlcv83hode8zguhy8055') })
window.addEventListener('load', function () { styleCell_sd9ken4qlyfj540mrmo1(5, 2, 'tinytable_css_idrlcv83hode8zguhy8055') })
window.addEventListener('load', function () { styleCell_sd9ken4qlyfj540mrmo1(5, 3, 'tinytable_css_idrlcv83hode8zguhy8055') })
window.addEventListener('load', function () { styleCell_sd9ken4qlyfj540mrmo1(6, 0, 'tinytable_css_idti97nucwjedyi75spcdh') })
window.addEventListener('load', function () { styleCell_sd9ken4qlyfj540mrmo1(6, 1, 'tinytable_css_idrlcv83hode8zguhy8055') })
window.addEventListener('load', function () { styleCell_sd9ken4qlyfj540mrmo1(6, 2, 'tinytable_css_idrlcv83hode8zguhy8055') })
window.addEventListener('load', function () { styleCell_sd9ken4qlyfj540mrmo1(6, 3, 'tinytable_css_idrlcv83hode8zguhy8055') })
window.addEventListener('load', function () { styleCell_sd9ken4qlyfj540mrmo1(7, 0, 'tinytable_css_idti97nucwjedyi75spcdh') })
window.addEventListener('load', function () { styleCell_sd9ken4qlyfj540mrmo1(7, 1, 'tinytable_css_idrlcv83hode8zguhy8055') })
window.addEventListener('load', function () { styleCell_sd9ken4qlyfj540mrmo1(7, 2, 'tinytable_css_idrlcv83hode8zguhy8055') })
window.addEventListener('load', function () { styleCell_sd9ken4qlyfj540mrmo1(7, 3, 'tinytable_css_idrlcv83hode8zguhy8055') })
window.addEventListener('load', function () { styleCell_sd9ken4qlyfj540mrmo1(8, 0, 'tinytable_css_idti97nucwjedyi75spcdh') })
window.addEventListener('load', function () { styleCell_sd9ken4qlyfj540mrmo1(8, 1, 'tinytable_css_idrlcv83hode8zguhy8055') })
window.addEventListener('load', function () { styleCell_sd9ken4qlyfj540mrmo1(8, 2, 'tinytable_css_idrlcv83hode8zguhy8055') })
window.addEventListener('load', function () { styleCell_sd9ken4qlyfj540mrmo1(8, 3, 'tinytable_css_idrlcv83hode8zguhy8055') })
window.addEventListener('load', function () { styleCell_sd9ken4qlyfj540mrmo1(9, 0, 'tinytable_css_idti97nucwjedyi75spcdh') })
window.addEventListener('load', function () { styleCell_sd9ken4qlyfj540mrmo1(9, 1, 'tinytable_css_idrlcv83hode8zguhy8055') })
window.addEventListener('load', function () { styleCell_sd9ken4qlyfj540mrmo1(9, 2, 'tinytable_css_idrlcv83hode8zguhy8055') })
window.addEventListener('load', function () { styleCell_sd9ken4qlyfj540mrmo1(9, 3, 'tinytable_css_idrlcv83hode8zguhy8055') })
window.addEventListener('load', function () { styleCell_sd9ken4qlyfj540mrmo1(10, 0, 'tinytable_css_idti97nucwjedyi75spcdh') })
window.addEventListener('load', function () { styleCell_sd9ken4qlyfj540mrmo1(10, 1, 'tinytable_css_idrlcv83hode8zguhy8055') })
window.addEventListener('load', function () { styleCell_sd9ken4qlyfj540mrmo1(10, 2, 'tinytable_css_idrlcv83hode8zguhy8055') })
window.addEventListener('load', function () { styleCell_sd9ken4qlyfj540mrmo1(10, 3, 'tinytable_css_idrlcv83hode8zguhy8055') })
window.addEventListener('load', function () { styleCell_sd9ken4qlyfj540mrmo1(11, 0, 'tinytable_css_idti97nucwjedyi75spcdh') })
window.addEventListener('load', function () { styleCell_sd9ken4qlyfj540mrmo1(11, 1, 'tinytable_css_idrlcv83hode8zguhy8055') })
window.addEventListener('load', function () { styleCell_sd9ken4qlyfj540mrmo1(11, 2, 'tinytable_css_idrlcv83hode8zguhy8055') })
window.addEventListener('load', function () { styleCell_sd9ken4qlyfj540mrmo1(11, 3, 'tinytable_css_idrlcv83hode8zguhy8055') })
window.addEventListener('load', function () { styleCell_sd9ken4qlyfj540mrmo1(12, 0, 'tinytable_css_idti97nucwjedyi75spcdh') })
window.addEventListener('load', function () { styleCell_sd9ken4qlyfj540mrmo1(12, 1, 'tinytable_css_idrlcv83hode8zguhy8055') })
window.addEventListener('load', function () { styleCell_sd9ken4qlyfj540mrmo1(12, 2, 'tinytable_css_idrlcv83hode8zguhy8055') })
window.addEventListener('load', function () { styleCell_sd9ken4qlyfj540mrmo1(12, 3, 'tinytable_css_idrlcv83hode8zguhy8055') })
    </script>

    <style>
    .table td.tinytable_css_id0wj9sh6hq2dekzhgquwi, .table th.tinytable_css_id0wj9sh6hq2dekzhgquwi {  text-align: left;  border-bottom: solid 0.1em #d3d8dc; }
    .table td.tinytable_css_idyajb6dwclbfhn0tmdk1v, .table th.tinytable_css_idyajb6dwclbfhn0tmdk1v {  text-align: center;  border-bottom: solid 0.1em #d3d8dc; }
    .table td.tinytable_css_idti97nucwjedyi75spcdh, .table th.tinytable_css_idti97nucwjedyi75spcdh {  text-align: left; }
    .table td.tinytable_css_idrlcv83hode8zguhy8055, .table th.tinytable_css_idrlcv83hode8zguhy8055 {  text-align: center; }
    .table td.tinytable_css_idi1g9pfdbr8c11a0oohgm, .table th.tinytable_css_idi1g9pfdbr8c11a0oohgm {  border-bottom: solid 0.05em black;  text-align: left; }
    .table td.tinytable_css_id8kfwaup0up7edoztd7eu, .table th.tinytable_css_id8kfwaup0up7edoztd7eu {  border-bottom: solid 0.05em black;  text-align: center; }
    </style>
    <div class="container">
      <table class="table table-borderless" id="tinytable_sd9ken4qlyfj540mrmo1" style="width: auto; margin-left: auto; margin-right: auto;" data-quarto-disable-processing="true">
        <thead>
        
              <tr>
                <th scope="col"> </th>
                <th scope="col">Ad revenue</th>
                <th scope="col">Ad revenue over circulation</th>
                <th scope="col">Subscription price</th>
              </tr>
        </thead>
        
        <tbody>
                <tr>
                  <td>Year        </td>
                  <td>0.05   </td>
                  <td>0.04   </td>
                  <td>0.05   </td>
                </tr>
                <tr>
                  <td>After change</td>
                  <td>-0.23  </td>
                  <td>-0.15  </td>
                  <td>-0.04  </td>
                </tr>
                <tr>
                  <td>Num.Obs.    </td>
                  <td>1052   </td>
                  <td>1048   </td>
                  <td>1044   </td>
                </tr>
                <tr>
                  <td>R2          </td>
                  <td>0.984  </td>
                  <td>0.896  </td>
                  <td>0.868  </td>
                </tr>
                <tr>
                  <td>R2 Adj.     </td>
                  <td>0.983  </td>
                  <td>0.886  </td>
                  <td>0.852  </td>
                </tr>
                <tr>
                  <td>Log.Lik.    </td>
                  <td>336.539</td>
                  <td>441.471</td>
                  <td>875.559</td>
                </tr>
                <tr>
                  <td>ELPD        </td>
                  <td>257.4  </td>
                  <td>362.3  </td>
                  <td>793.5  </td>
                </tr>
                <tr>
                  <td>ELPD s.e.   </td>
                  <td>34.4   </td>
                  <td>45.6   </td>
                  <td>24.3   </td>
                </tr>
                <tr>
                  <td>LOOIC       </td>
                  <td>-514.8 </td>
                  <td>-724.6 </td>
                  <td>-1586.9</td>
                </tr>
                <tr>
                  <td>LOOIC s.e.  </td>
                  <td>68.9   </td>
                  <td>91.2   </td>
                  <td>48.6   </td>
                </tr>
                <tr>
                  <td>WAIC        </td>
                  <td>-515.9 </td>
                  <td>-725.5 </td>
                  <td>-1588.9</td>
                </tr>
                <tr>
                  <td>RMSE        </td>
                  <td>0.17   </td>
                  <td>0.16   </td>
                  <td>0.10   </td>
                </tr>
        </tbody>
      </table>
    </div>
<!-- hack to avoid NA insertion in last line -->
</div>
</div>
</figure>
</div>
</div>
<p>We can replicate the main results of <span class="citation" data-cites="angelucci2019newspapers">Angelucci and Cagé (<a href="99-references.html#ref-angelucci2019newspapers" role="doc-biblioref">2019</a>)</span> and find that in many cases there appears to be a difference from 1967 onward. <span class="citation" data-cites="angelucci2019newspapers">Angelucci and Cagé (<a href="99-references.html#ref-angelucci2019newspapers" role="doc-biblioref">2019, 353–58</a>)</span> also include an excellent example of the discussion of interpretation, external validity, and robustness that is required for difference-in-differences models.</p>
</section>
</section>
<section id="propensity-score-matching" class="level2" data-number="15.4">
<h2 data-number="15.4" class="anchored" data-anchor-id="propensity-score-matching"><span class="header-section-number">15.4</span> Propensity score matching</h2>
<p>Difference-in-differences is a powerful analysis framework. But it can be tough to identify appropriate treatment and control groups. <span class="citation" data-cites="alexander2018age">Alexander and Ward (<a href="99-references.html#ref-alexander2018age" role="doc-biblioref">2018</a>)</span> compare migrant brothers, where one brother had most of their education in a different country, and the other brother had most of their education in the United States. Given the data that are available, this match provides a reasonable treatment and control group. But other matches could have given different results, for instance friends or cousins.</p>
<p>We can only match based on observable variables. For instance, age-group or education. At two different times we compare smoking rates in 18-year-olds in one city with smoking rates in 18-year-olds in another city. This would be a coarse match because we know that there are many differences between 18-year-olds, even in terms of the variables that we commonly observe, say gender and education. One way to deal with this would be to create sub-groups: 18-year-old males with a high school education, etc. But then the sample sizes quickly become small. We also have the issue of how to deal with continuous variables. And is an 18-year-old really that different to a 19-year-old? Why not also compare with them?</p>
<p>One way to proceed is to consider a nearest neighbor approach, but there can be limited concern for uncertainty with this approach. There can also be an issue with having many variables because we end up with a high-dimension graph. This leads to propensity score matching. Here we explain the process of propensity score matching and a few of the concerns that are commonly brought up about it.</p>
<p>Propensity score matching involves assigning some probability—the “propensity score”—to each observation. We construct that probability based on the observation’s values for the predictors without the treatment. That probability is our best guess at the probability of the observation being treated, regardless of whether it was actually treated. For instance, if 18-year-old males were treated but 19-year-old males were not, then, as there is not much difference between 18-year-old and 19-year-old males in general, our assigned probability would be similar. We then compare the outcomes of observations with similar propensity scores.</p>
<section id="simulated-example-free-shipping" class="level3" data-number="15.4.1">
<h3 data-number="15.4.1" class="anchored" data-anchor-id="simulated-example-free-shipping"><span class="header-section-number">15.4.1</span> Simulated example: free shipping</h3>
<p>One advantage of propensity score matching is that it allows us to easily consider many predictor variables at once, and it can be constructed using logistic regression. To be more specific we can simulate some data. We will pretend that we work for a large online retailer. We are going to treat some individuals with free shipping to see what happens to their average purchase.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb23"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb23-1"><a href="#cb23-1" aria-hidden="true" tabindex="-1"></a><span class="fu">set.seed</span>(<span class="dv">853</span>)</span>
<span id="cb23-2"><a href="#cb23-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb23-3"><a href="#cb23-3" aria-hidden="true" tabindex="-1"></a>sample_size <span class="ot">&lt;-</span> <span class="dv">10000</span></span>
<span id="cb23-4"><a href="#cb23-4" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb23-5"><a href="#cb23-5" aria-hidden="true" tabindex="-1"></a>purchase_data <span class="ot">&lt;-</span></span>
<span id="cb23-6"><a href="#cb23-6" aria-hidden="true" tabindex="-1"></a>  <span class="fu">tibble</span>(</span>
<span id="cb23-7"><a href="#cb23-7" aria-hidden="true" tabindex="-1"></a>    <span class="at">unique_person_id =</span> <span class="dv">1</span><span class="sc">:</span>sample_size,</span>
<span id="cb23-8"><a href="#cb23-8" aria-hidden="true" tabindex="-1"></a>    <span class="at">age =</span> <span class="fu">sample</span>(<span class="at">x =</span> <span class="dv">18</span><span class="sc">:</span><span class="dv">100</span>, <span class="at">size =</span> sample_size, <span class="at">replace =</span> <span class="cn">TRUE</span>),</span>
<span id="cb23-9"><a href="#cb23-9" aria-hidden="true" tabindex="-1"></a>    <span class="at">gender =</span> <span class="fu">sample</span>(</span>
<span id="cb23-10"><a href="#cb23-10" aria-hidden="true" tabindex="-1"></a>      <span class="at">x =</span> <span class="fu">c</span>(<span class="st">"Female"</span>, <span class="st">"Male"</span>, <span class="st">"Other/decline"</span>),</span>
<span id="cb23-11"><a href="#cb23-11" aria-hidden="true" tabindex="-1"></a>      <span class="at">size =</span> sample_size,</span>
<span id="cb23-12"><a href="#cb23-12" aria-hidden="true" tabindex="-1"></a>      <span class="at">replace =</span> <span class="cn">TRUE</span>,</span>
<span id="cb23-13"><a href="#cb23-13" aria-hidden="true" tabindex="-1"></a>      <span class="at">prob =</span> <span class="fu">c</span>(<span class="fl">0.49</span>, <span class="fl">0.47</span>, <span class="fl">0.02</span>)</span>
<span id="cb23-14"><a href="#cb23-14" aria-hidden="true" tabindex="-1"></a>    ),</span>
<span id="cb23-15"><a href="#cb23-15" aria-hidden="true" tabindex="-1"></a>    <span class="at">income =</span> <span class="fu">rnorm</span>(<span class="at">n =</span> sample_size, <span class="at">mean =</span> <span class="dv">60000</span>, <span class="at">sd =</span> <span class="dv">15000</span>) <span class="sc">|&gt;</span> <span class="fu">round</span>(<span class="dv">0</span>)</span>
<span id="cb23-16"><a href="#cb23-16" aria-hidden="true" tabindex="-1"></a>  ) </span>
<span id="cb23-17"><a href="#cb23-17" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb23-18"><a href="#cb23-18" aria-hidden="true" tabindex="-1"></a>purchase_data</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code># A tibble: 10,000 × 4
   unique_person_id   age gender income
              &lt;int&gt; &lt;int&gt; &lt;chr&gt;   &lt;dbl&gt;
 1                1    26 Male    68637
 2                2    81 Female  71486
 3                3    34 Male    75652
 4                4    46 Male    68068
 5                5   100 Female  73206
 6                6    20 Male    41872
 7                7    50 Female  75957
 8                8    36 Female  56566
 9                9    72 Male    54621
10               10    52 Female  40722
# ℹ 9,990 more rows</code></pre>
</div>
</div>
<p>Then we need to add some probability of being treated with free shipping. We will say that it depends on our predictors and that younger, higher-income, male individuals make this treatment more likely. We only know that because we simulated the situation. We would not know it if we were using actual data.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb25"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb25-1"><a href="#cb25-1" aria-hidden="true" tabindex="-1"></a>purchase_data <span class="ot">&lt;-</span> </span>
<span id="cb25-2"><a href="#cb25-2" aria-hidden="true" tabindex="-1"></a>  purchase_data <span class="sc">|&gt;</span></span>
<span id="cb25-3"><a href="#cb25-3" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(</span>
<span id="cb25-4"><a href="#cb25-4" aria-hidden="true" tabindex="-1"></a>    <span class="co"># change characteristics to bounded numbers</span></span>
<span id="cb25-5"><a href="#cb25-5" aria-hidden="true" tabindex="-1"></a>    <span class="at">age_num =</span> <span class="fu">rank</span>(<span class="dv">1</span> <span class="sc">/</span> age, <span class="at">ties.method =</span> <span class="st">"random"</span>) <span class="sc">%/%</span> <span class="dv">3000</span>,</span>
<span id="cb25-6"><a href="#cb25-6" aria-hidden="true" tabindex="-1"></a>    <span class="co"># force it between 0 and 3</span></span>
<span id="cb25-7"><a href="#cb25-7" aria-hidden="true" tabindex="-1"></a>    <span class="at">gender_num =</span> <span class="fu">case_when</span>(</span>
<span id="cb25-8"><a href="#cb25-8" aria-hidden="true" tabindex="-1"></a>      gender <span class="sc">==</span> <span class="st">"Male"</span> <span class="sc">~</span> <span class="dv">3</span>,</span>
<span id="cb25-9"><a href="#cb25-9" aria-hidden="true" tabindex="-1"></a>      gender <span class="sc">==</span> <span class="st">"Female"</span> <span class="sc">~</span> <span class="dv">2</span>,</span>
<span id="cb25-10"><a href="#cb25-10" aria-hidden="true" tabindex="-1"></a>      gender <span class="sc">==</span> <span class="st">"Other/decline"</span> <span class="sc">~</span> <span class="dv">1</span></span>
<span id="cb25-11"><a href="#cb25-11" aria-hidden="true" tabindex="-1"></a>    ),</span>
<span id="cb25-12"><a href="#cb25-12" aria-hidden="true" tabindex="-1"></a>    <span class="at">income_num =</span> <span class="fu">rank</span>(income, <span class="at">ties.method =</span> <span class="st">"random"</span>) <span class="sc">%/%</span> <span class="dv">3000</span></span>
<span id="cb25-13"><a href="#cb25-13" aria-hidden="true" tabindex="-1"></a>  ) <span class="sc">|&gt;</span></span>
<span id="cb25-14"><a href="#cb25-14" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(</span>
<span id="cb25-15"><a href="#cb25-15" aria-hidden="true" tabindex="-1"></a>    <span class="at">sum_num =</span> age_num <span class="sc">+</span> gender_num <span class="sc">+</span> income_num,</span>
<span id="cb25-16"><a href="#cb25-16" aria-hidden="true" tabindex="-1"></a>    <span class="at">softmax_prob =</span> <span class="fu">exp</span>(sum_num) <span class="sc">/</span> <span class="fu">exp</span>(<span class="fu">max</span>(sum_num) <span class="sc">+</span> <span class="fl">0.5</span>),</span>
<span id="cb25-17"><a href="#cb25-17" aria-hidden="true" tabindex="-1"></a>    <span class="at">free_shipping =</span> <span class="fu">rbinom</span>(<span class="at">n =</span> sample_size, <span class="at">size =</span> <span class="dv">1</span>, <span class="at">prob =</span> softmax_prob)) <span class="sc">|&gt;</span></span>
<span id="cb25-18"><a href="#cb25-18" aria-hidden="true" tabindex="-1"></a>  <span class="fu">select</span>(<span class="sc">-</span>(age_num<span class="sc">:</span>softmax_prob))</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>Finally, we need to have some measure of a person’s average spend. We will assume that this increases with income. We want those with free shipping to be slightly higher than those without.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb26"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb26-1"><a href="#cb26-1" aria-hidden="true" tabindex="-1"></a>purchase_data <span class="ot">&lt;-</span></span>
<span id="cb26-2"><a href="#cb26-2" aria-hidden="true" tabindex="-1"></a>  purchase_data <span class="sc">|&gt;</span></span>
<span id="cb26-3"><a href="#cb26-3" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(</span>
<span id="cb26-4"><a href="#cb26-4" aria-hidden="true" tabindex="-1"></a>    <span class="at">noise =</span> <span class="fu">rnorm</span>(<span class="at">n =</span> <span class="fu">nrow</span>(purchase_data), <span class="at">mean =</span> <span class="dv">5</span>, <span class="at">sd =</span> <span class="dv">2</span>),</span>
<span id="cb26-5"><a href="#cb26-5" aria-hidden="true" tabindex="-1"></a>    <span class="at">spend =</span> income <span class="sc">/</span> <span class="dv">1000</span> <span class="sc">+</span> noise,</span>
<span id="cb26-6"><a href="#cb26-6" aria-hidden="true" tabindex="-1"></a>    <span class="at">spend =</span> <span class="fu">if_else</span>(free_shipping <span class="sc">==</span> <span class="dv">1</span>, spend <span class="sc">+</span> <span class="dv">10</span>, spend),</span>
<span id="cb26-7"><a href="#cb26-7" aria-hidden="true" tabindex="-1"></a>    <span class="at">spend =</span> <span class="fu">as.integer</span>(spend)</span>
<span id="cb26-8"><a href="#cb26-8" aria-hidden="true" tabindex="-1"></a>    ) <span class="sc">|&gt;</span></span>
<span id="cb26-9"><a href="#cb26-9" aria-hidden="true" tabindex="-1"></a>  <span class="fu">select</span>(<span class="sc">-</span>noise) <span class="sc">|&gt;</span></span>
<span id="cb26-10"><a href="#cb26-10" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(<span class="fu">across</span>(<span class="fu">c</span>(gender, free_shipping), as.factor))</span>
<span id="cb26-11"><a href="#cb26-11" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb26-12"><a href="#cb26-12" aria-hidden="true" tabindex="-1"></a>purchase_data</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code># A tibble: 10,000 × 6
   unique_person_id   age gender income free_shipping spend
              &lt;int&gt; &lt;int&gt; &lt;fct&gt;   &lt;dbl&gt; &lt;fct&gt;         &lt;int&gt;
 1                1    26 Male    68637 0                72
 2                2    81 Female  71486 0                73
 3                3    34 Male    75652 0                80
 4                4    46 Male    68068 0                75
 5                5   100 Female  73206 0                78
 6                6    20 Male    41872 0                45
 7                7    50 Female  75957 0                78
 8                8    36 Female  56566 0                62
 9                9    72 Male    54621 0                55
10               10    52 Female  40722 0                47
# ℹ 9,990 more rows</code></pre>
</div>
</div>
<p>Naively we can see that there is a difference in the average spend between those with free shipping and those without (<a href="#tbl-heyheybigspender" class="quarto-xref">Table&nbsp;<span>15.3</span></a>). But the fundamental concern is what would have the spend have been of those with free shipping if they have not had free shipping. <a href="#tbl-heyheybigspender" class="quarto-xref">Table&nbsp;<span>15.3</span></a> shows an average comparison but not everyone had the same chance of getting free shipping. So we question the validity of that use of an average comparison. Instead we use propensity score matching to “link” each observation that actually got free shipping with their most similar observation, based on the observable variables, that did not get free shipping.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb28"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb28-1"><a href="#cb28-1" aria-hidden="true" tabindex="-1"></a>purchase_data <span class="sc">|&gt;</span></span>
<span id="cb28-2"><a href="#cb28-2" aria-hidden="true" tabindex="-1"></a>  <span class="fu">summarise</span>(<span class="at">average_spend =</span> <span class="fu">round</span>(<span class="fu">mean</span>(spend), <span class="dv">2</span>), <span class="at">.by =</span> free_shipping) <span class="sc">|&gt;</span></span>
<span id="cb28-3"><a href="#cb28-3" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(<span class="at">free_shipping =</span> <span class="fu">if_else</span>(free_shipping <span class="sc">==</span> <span class="dv">0</span>, <span class="st">"No"</span>, <span class="st">"Yes"</span>)) <span class="sc">|&gt;</span></span>
<span id="cb28-4"><a href="#cb28-4" aria-hidden="true" tabindex="-1"></a>  <span class="fu">kable</span>(</span>
<span id="cb28-5"><a href="#cb28-5" aria-hidden="true" tabindex="-1"></a>    <span class="at">col.names =</span> <span class="fu">c</span>(<span class="st">"Received free shipping?"</span>, <span class="st">"Average spend"</span>),</span>
<span id="cb28-6"><a href="#cb28-6" aria-hidden="true" tabindex="-1"></a>    <span class="at">booktabs =</span> <span class="cn">TRUE</span>, <span class="at">linesep =</span> <span class="st">""</span></span>
<span id="cb28-7"><a href="#cb28-7" aria-hidden="true" tabindex="-1"></a>  )</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div id="tbl-heyheybigspender" class="cell quarto-float anchored">
<figure class="quarto-float quarto-float-tbl figure">
<figcaption class="quarto-float-caption-top quarto-float-caption quarto-float-tbl" id="tbl-heyheybigspender-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
Table&nbsp;15.3: Difference in average spend by whether had free shipping
</figcaption>
<div aria-describedby="tbl-heyheybigspender-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
<div class="cell-output-display">
<table class="do-not-create-environment cell table table-sm table-striped small">
<thead>
<tr class="header">
<th style="text-align: left;">Received free shipping?</th>
<th style="text-align: right;">Average spend</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td style="text-align: left;">No</td>
<td style="text-align: right;">64.44</td>
</tr>
<tr class="even">
<td style="text-align: left;">Yes</td>
<td style="text-align: right;">86.71</td>
</tr>
</tbody>
</table>
</div>
</div>
</figure>
</div>
</div>
<p>We use <code>matchit()</code> from <code>MatchIt</code> to implement logistic regression and create matched groups. We then use <code>match.data()</code> to get the data of matches containing both all 254 people who were actually treated with free shipping and the untreated person who is considered as similar to them, based on propensity score, as possible. The result is a dataset of 508 observations.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb29"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb29-1"><a href="#cb29-1" aria-hidden="true" tabindex="-1"></a>matched_groups <span class="ot">&lt;-</span> </span>
<span id="cb29-2"><a href="#cb29-2" aria-hidden="true" tabindex="-1"></a>  <span class="fu">matchit</span>(</span>
<span id="cb29-3"><a href="#cb29-3" aria-hidden="true" tabindex="-1"></a>  free_shipping <span class="sc">~</span> age <span class="sc">+</span> gender <span class="sc">+</span> income,</span>
<span id="cb29-4"><a href="#cb29-4" aria-hidden="true" tabindex="-1"></a>  <span class="at">data =</span> purchase_data,</span>
<span id="cb29-5"><a href="#cb29-5" aria-hidden="true" tabindex="-1"></a>  <span class="at">method =</span> <span class="st">"nearest"</span>,</span>
<span id="cb29-6"><a href="#cb29-6" aria-hidden="true" tabindex="-1"></a>  <span class="at">distance =</span> <span class="st">"glm"</span></span>
<span id="cb29-7"><a href="#cb29-7" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb29-8"><a href="#cb29-8" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb29-9"><a href="#cb29-9" aria-hidden="true" tabindex="-1"></a>matched_groups</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>A matchit object
 - method: 1:1 nearest neighbor matching without replacement
 - distance: Propensity score
             - estimated with logistic regression
 - number of obs.: 10000 (original), 508 (matched)
 - target estimand: ATT
 - covariates: age, gender, income</code></pre>
</div>
<div class="sourceCode cell-code" id="cb31"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb31-1"><a href="#cb31-1" aria-hidden="true" tabindex="-1"></a>matched_dataset <span class="ot">&lt;-</span> <span class="fu">match.data</span>(matched_groups)</span>
<span id="cb31-2"><a href="#cb31-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb31-3"><a href="#cb31-3" aria-hidden="true" tabindex="-1"></a>matched_dataset</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code># A tibble: 508 × 9
   unique_person_id   age gender     income free_shipping spend distance weights
              &lt;int&gt; &lt;int&gt; &lt;fct&gt;       &lt;dbl&gt; &lt;fct&gt;         &lt;int&gt;    &lt;dbl&gt;   &lt;dbl&gt;
 1               23    28 Female      65685 1                79  0.0334        1
 2               24    67 Male        71150 0                76  0.0220        1
 3               32    22 Female      86071 0                92  0.131         1
 4               48    66 Female     100105 0               108  0.0473        1
 5               59    25 Male        55548 1                68  0.0541        1
 6               82    66 Male        70721 0                75  0.0224        1
 7               83    58 Male        83443 0                88  0.0651        1
 8               87    46 Male        59073 1                73  0.0271        1
 9              119    89 Other/dec…  72284 0                74  0.00301       1
10              125    51 Female      81164 1                96  0.0303        1
# ℹ 498 more rows
# ℹ 1 more variable: subclass &lt;fct&gt;</code></pre>
</div>
</div>
<p>Finally, we can estimate the effect of being treated on average spend using linear regression (<a href="#tbl-treatedexample" class="quarto-xref">Table&nbsp;<span>15.4</span></a>). We are particularly interested in the coefficient associated with the treatment variable, in this case free shipping.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb33"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb33-1"><a href="#cb33-1" aria-hidden="true" tabindex="-1"></a>propensity_score_regression <span class="ot">&lt;-</span> <span class="fu">lm</span>(</span>
<span id="cb33-2"><a href="#cb33-2" aria-hidden="true" tabindex="-1"></a>  spend <span class="sc">~</span> age <span class="sc">+</span> gender <span class="sc">+</span> income <span class="sc">+</span> free_shipping,</span>
<span id="cb33-3"><a href="#cb33-3" aria-hidden="true" tabindex="-1"></a>  <span class="at">data =</span> matched_dataset</span>
<span id="cb33-4"><a href="#cb33-4" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb33-5"><a href="#cb33-5" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb33-6"><a href="#cb33-6" aria-hidden="true" tabindex="-1"></a><span class="fu">modelsummary</span>(propensity_score_regression)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div id="tbl-treatedexample" class="cell quarto-float anchored">
<figure class="quarto-float quarto-float-tbl figure">
<figcaption class="quarto-float-caption-top quarto-float-caption quarto-float-tbl" id="tbl-treatedexample-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
Table&nbsp;15.4: Effect of being treated, using simulated data
</figcaption>
<div aria-describedby="tbl-treatedexample-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
<div class="cell-output-display">
<!-- preamble start -->

    <script>
      function styleCell_9p73cogq6zzn1vim0fwe(i, j, css_id) {
        var table = document.getElementById("tinytable_9p73cogq6zzn1vim0fwe");
        table.rows[i].cells[j].classList.add(css_id);
      }
      function insertSpanRow(i, colspan, content) {
        var table = document.getElementById('tinytable_9p73cogq6zzn1vim0fwe');
        var newRow = table.insertRow(i);
        var newCell = newRow.insertCell(0);
        newCell.setAttribute("colspan", colspan);
        // newCell.innerText = content;
        // this may be unsafe, but innerText does not interpret <br>
        newCell.innerHTML = content;
      }
      function spanCell_9p73cogq6zzn1vim0fwe(i, j, rowspan, colspan) {
        var table = document.getElementById("tinytable_9p73cogq6zzn1vim0fwe");
        const targetRow = table.rows[i];
        const targetCell = targetRow.cells[j];
        for (let r = 0; r < rowspan; r++) {
          // Only start deleting cells to the right for the first row (r == 0)
          if (r === 0) {
            // Delete cells to the right of the target cell in the first row
            for (let c = colspan - 1; c > 0; c--) {
              if (table.rows[i + r].cells[j + c]) {
                table.rows[i + r].deleteCell(j + c);
              }
            }
          }
          // For rows below the first, delete starting from the target column
          if (r > 0) {
            for (let c = colspan - 1; c >= 0; c--) {
              if (table.rows[i + r] && table.rows[i + r].cells[j]) {
                table.rows[i + r].deleteCell(j);
              }
            }
          }
        }
        // Set rowspan and colspan of the target cell
        targetCell.rowSpan = rowspan;
        targetCell.colSpan = colspan;
      }
window.addEventListener('load', function () { styleCell_9p73cogq6zzn1vim0fwe(0, 0, 'tinytable_css_idt77sljsgrlsd4g6aozko') })
window.addEventListener('load', function () { styleCell_9p73cogq6zzn1vim0fwe(0, 1, 'tinytable_css_ides4325bxnx4vo5gcf0o8') })
window.addEventListener('load', function () { styleCell_9p73cogq6zzn1vim0fwe(1, 0, 'tinytable_css_id0o85vn2plmevrtuvt9bh') })
window.addEventListener('load', function () { styleCell_9p73cogq6zzn1vim0fwe(1, 1, 'tinytable_css_idqz6ro6k1bn1fgdrkk8hp') })
window.addEventListener('load', function () { styleCell_9p73cogq6zzn1vim0fwe(2, 0, 'tinytable_css_id0o85vn2plmevrtuvt9bh') })
window.addEventListener('load', function () { styleCell_9p73cogq6zzn1vim0fwe(2, 1, 'tinytable_css_idqz6ro6k1bn1fgdrkk8hp') })
window.addEventListener('load', function () { styleCell_9p73cogq6zzn1vim0fwe(3, 0, 'tinytable_css_id0o85vn2plmevrtuvt9bh') })
window.addEventListener('load', function () { styleCell_9p73cogq6zzn1vim0fwe(3, 1, 'tinytable_css_idqz6ro6k1bn1fgdrkk8hp') })
window.addEventListener('load', function () { styleCell_9p73cogq6zzn1vim0fwe(4, 0, 'tinytable_css_id0o85vn2plmevrtuvt9bh') })
window.addEventListener('load', function () { styleCell_9p73cogq6zzn1vim0fwe(4, 1, 'tinytable_css_idqz6ro6k1bn1fgdrkk8hp') })
window.addEventListener('load', function () { styleCell_9p73cogq6zzn1vim0fwe(5, 0, 'tinytable_css_id0o85vn2plmevrtuvt9bh') })
window.addEventListener('load', function () { styleCell_9p73cogq6zzn1vim0fwe(5, 1, 'tinytable_css_idqz6ro6k1bn1fgdrkk8hp') })
window.addEventListener('load', function () { styleCell_9p73cogq6zzn1vim0fwe(6, 0, 'tinytable_css_id0o85vn2plmevrtuvt9bh') })
window.addEventListener('load', function () { styleCell_9p73cogq6zzn1vim0fwe(6, 1, 'tinytable_css_idqz6ro6k1bn1fgdrkk8hp') })
window.addEventListener('load', function () { styleCell_9p73cogq6zzn1vim0fwe(7, 0, 'tinytable_css_id0o85vn2plmevrtuvt9bh') })
window.addEventListener('load', function () { styleCell_9p73cogq6zzn1vim0fwe(7, 1, 'tinytable_css_idqz6ro6k1bn1fgdrkk8hp') })
window.addEventListener('load', function () { styleCell_9p73cogq6zzn1vim0fwe(8, 0, 'tinytable_css_id0o85vn2plmevrtuvt9bh') })
window.addEventListener('load', function () { styleCell_9p73cogq6zzn1vim0fwe(8, 1, 'tinytable_css_idqz6ro6k1bn1fgdrkk8hp') })
window.addEventListener('load', function () { styleCell_9p73cogq6zzn1vim0fwe(9, 0, 'tinytable_css_id0o85vn2plmevrtuvt9bh') })
window.addEventListener('load', function () { styleCell_9p73cogq6zzn1vim0fwe(9, 1, 'tinytable_css_idqz6ro6k1bn1fgdrkk8hp') })
window.addEventListener('load', function () { styleCell_9p73cogq6zzn1vim0fwe(10, 0, 'tinytable_css_id0o85vn2plmevrtuvt9bh') })
window.addEventListener('load', function () { styleCell_9p73cogq6zzn1vim0fwe(10, 1, 'tinytable_css_idqz6ro6k1bn1fgdrkk8hp') })
window.addEventListener('load', function () { styleCell_9p73cogq6zzn1vim0fwe(11, 0, 'tinytable_css_id0o85vn2plmevrtuvt9bh') })
window.addEventListener('load', function () { styleCell_9p73cogq6zzn1vim0fwe(11, 1, 'tinytable_css_idqz6ro6k1bn1fgdrkk8hp') })
window.addEventListener('load', function () { styleCell_9p73cogq6zzn1vim0fwe(12, 0, 'tinytable_css_id3nr2xcgtxgdax3oilwwe') })
window.addEventListener('load', function () { styleCell_9p73cogq6zzn1vim0fwe(12, 1, 'tinytable_css_id6qcgh2dxe4y1f240gnjf') })
window.addEventListener('load', function () { styleCell_9p73cogq6zzn1vim0fwe(13, 0, 'tinytable_css_id0o85vn2plmevrtuvt9bh') })
window.addEventListener('load', function () { styleCell_9p73cogq6zzn1vim0fwe(13, 1, 'tinytable_css_idqz6ro6k1bn1fgdrkk8hp') })
window.addEventListener('load', function () { styleCell_9p73cogq6zzn1vim0fwe(14, 0, 'tinytable_css_id0o85vn2plmevrtuvt9bh') })
window.addEventListener('load', function () { styleCell_9p73cogq6zzn1vim0fwe(14, 1, 'tinytable_css_idqz6ro6k1bn1fgdrkk8hp') })
window.addEventListener('load', function () { styleCell_9p73cogq6zzn1vim0fwe(15, 0, 'tinytable_css_id0o85vn2plmevrtuvt9bh') })
window.addEventListener('load', function () { styleCell_9p73cogq6zzn1vim0fwe(15, 1, 'tinytable_css_idqz6ro6k1bn1fgdrkk8hp') })
window.addEventListener('load', function () { styleCell_9p73cogq6zzn1vim0fwe(16, 0, 'tinytable_css_id0o85vn2plmevrtuvt9bh') })
window.addEventListener('load', function () { styleCell_9p73cogq6zzn1vim0fwe(16, 1, 'tinytable_css_idqz6ro6k1bn1fgdrkk8hp') })
window.addEventListener('load', function () { styleCell_9p73cogq6zzn1vim0fwe(17, 0, 'tinytable_css_id0o85vn2plmevrtuvt9bh') })
window.addEventListener('load', function () { styleCell_9p73cogq6zzn1vim0fwe(17, 1, 'tinytable_css_idqz6ro6k1bn1fgdrkk8hp') })
window.addEventListener('load', function () { styleCell_9p73cogq6zzn1vim0fwe(18, 0, 'tinytable_css_id0o85vn2plmevrtuvt9bh') })
window.addEventListener('load', function () { styleCell_9p73cogq6zzn1vim0fwe(18, 1, 'tinytable_css_idqz6ro6k1bn1fgdrkk8hp') })
window.addEventListener('load', function () { styleCell_9p73cogq6zzn1vim0fwe(19, 0, 'tinytable_css_id0o85vn2plmevrtuvt9bh') })
window.addEventListener('load', function () { styleCell_9p73cogq6zzn1vim0fwe(19, 1, 'tinytable_css_idqz6ro6k1bn1fgdrkk8hp') })
window.addEventListener('load', function () { styleCell_9p73cogq6zzn1vim0fwe(20, 0, 'tinytable_css_id0o85vn2plmevrtuvt9bh') })
window.addEventListener('load', function () { styleCell_9p73cogq6zzn1vim0fwe(20, 1, 'tinytable_css_idqz6ro6k1bn1fgdrkk8hp') })
    </script>

    <style>
    .table td.tinytable_css_idt77sljsgrlsd4g6aozko, .table th.tinytable_css_idt77sljsgrlsd4g6aozko {  text-align: left;  border-bottom: solid 0.1em #d3d8dc; }
    .table td.tinytable_css_ides4325bxnx4vo5gcf0o8, .table th.tinytable_css_ides4325bxnx4vo5gcf0o8 {  text-align: center;  border-bottom: solid 0.1em #d3d8dc; }
    .table td.tinytable_css_id0o85vn2plmevrtuvt9bh, .table th.tinytable_css_id0o85vn2plmevrtuvt9bh {  text-align: left; }
    .table td.tinytable_css_idqz6ro6k1bn1fgdrkk8hp, .table th.tinytable_css_idqz6ro6k1bn1fgdrkk8hp {  text-align: center; }
    .table td.tinytable_css_id3nr2xcgtxgdax3oilwwe, .table th.tinytable_css_id3nr2xcgtxgdax3oilwwe {  border-bottom: solid 0.05em black;  text-align: left; }
    .table td.tinytable_css_id6qcgh2dxe4y1f240gnjf, .table th.tinytable_css_id6qcgh2dxe4y1f240gnjf {  border-bottom: solid 0.05em black;  text-align: center; }
    </style>
    <div class="container">
      <table class="table table-borderless" id="tinytable_9p73cogq6zzn1vim0fwe" style="width: auto; margin-left: auto; margin-right: auto;" data-quarto-disable-processing="true">
        <thead>
        
              <tr>
                <th scope="col"> </th>
                <th scope="col">(1)</th>
              </tr>
        </thead>
        
        <tbody>
                <tr>
                  <td>(Intercept)        </td>
                  <td>3.862    </td>
                </tr>
                <tr>
                  <td>                   </td>
                  <td>(0.506)  </td>
                </tr>
                <tr>
                  <td>age                </td>
                  <td>0.007    </td>
                </tr>
                <tr>
                  <td>                   </td>
                  <td>(0.005)  </td>
                </tr>
                <tr>
                  <td>genderMale         </td>
                  <td>0.013    </td>
                </tr>
                <tr>
                  <td>                   </td>
                  <td>(0.202)  </td>
                </tr>
                <tr>
                  <td>genderOther/decline</td>
                  <td>-0.509   </td>
                </tr>
                <tr>
                  <td>                   </td>
                  <td>(0.847)  </td>
                </tr>
                <tr>
                  <td>income             </td>
                  <td>0.001    </td>
                </tr>
                <tr>
                  <td>                   </td>
                  <td>(0.000)  </td>
                </tr>
                <tr>
                  <td>free_shipping1     </td>
                  <td>10.073   </td>
                </tr>
                <tr>
                  <td>                   </td>
                  <td>(0.180)  </td>
                </tr>
                <tr>
                  <td>Num.Obs.           </td>
                  <td>508      </td>
                </tr>
                <tr>
                  <td>R2                 </td>
                  <td>0.983    </td>
                </tr>
                <tr>
                  <td>R2 Adj.            </td>
                  <td>0.983    </td>
                </tr>
                <tr>
                  <td>AIC                </td>
                  <td>2167.6   </td>
                </tr>
                <tr>
                  <td>BIC                </td>
                  <td>2197.2   </td>
                </tr>
                <tr>
                  <td>Log.Lik.           </td>
                  <td>-1076.811</td>
                </tr>
                <tr>
                  <td>F                  </td>
                  <td>5911.747 </td>
                </tr>
                <tr>
                  <td>RMSE               </td>
                  <td>2.02     </td>
                </tr>
        </tbody>
      </table>
    </div>
<!-- hack to avoid NA insertion in last line -->
</div>
</div>
</figure>
</div>
</div>
<p>In <a href="#tbl-treatedexample" class="quarto-xref">Table&nbsp;<span>15.4</span></a>, which was based on only the matched sample, we find that the effect is what we simulated. That is, there is a difference of ten between the average spend of those who received free shipping and those that did not. That is in contrast to <a href="#tbl-heyheybigspender" class="quarto-xref">Table&nbsp;<span>15.3</span></a> which was based on the entire sample.</p>
<p>We cover propensity score matching because it is widely used. But there are tradeoffs. Transparency is needed when it is being used <span class="citation" data-cites="omggreifer">(<a href="99-references.html#ref-omggreifer" role="doc-biblioref">Greifer 2021</a>)</span>. These concerns include <span class="citation" data-cites="king2019propensity">(<a href="99-references.html#ref-king2019propensity" role="doc-biblioref">King and Nielsen 2019</a>)</span>:</p>
<ol type="1">
<li>Unobservables. Propensity score matching cannot match on unobserved variables. This may be fine in a classroom setting, but in more realistic settings it will likely cause issues. It is difficult to understand why individuals that appear to be so similar, would have received different treatments, unless there is something unobserved that causes the difference. As propensity score matching cannot account for these, it is difficult to know which features are actually being brought together.</li>
<li>Modeling. The results of propensity score matching tend to be specific to the model that is used. As there is considerable flexibility as to which model is used, this enables researchers to pick through matches to find one that suits. Additionally, because the two regression steps (the matching and the analysis) are conducted separately, there is no propagation of uncertainty.</li>
</ol>
<p>The fundamental problem of unobservables can never be shown to be inconsequential because that would require the unobserved data. Those who want to use propensity score matching, and other matching methods, need to be able to argue convincingly that it is appropriate. <span class="citation" data-cites="mckenzieforthedefence">McKenzie (<a href="99-references.html#ref-mckenzieforthedefence" role="doc-biblioref">2021</a>)</span> presents a few cases where this is possible, for instance, when there are capacity limits. As is the common theme of this book, such cases will require focusing on the data and a deep understanding of the situation that produced it.</p>
</section>
</section>
<section id="regression-discontinuity-design" class="level2" data-number="15.5">
<h2 data-number="15.5" class="anchored" data-anchor-id="regression-discontinuity-design"><span class="header-section-number">15.5</span> Regression discontinuity design</h2>
<p>Regression discontinuity design (RDD) was established by <span class="citation" data-cites="thistlethwaite1960regression">Thistlethwaite and Campbell (<a href="99-references.html#ref-thistlethwaite1960regression" role="doc-biblioref">1960</a>)</span> and is a popular way to get causality when there is a continuous variable with cut-offs that determine treatment. Is there a difference between a student who gets 79 per cent and a student who gets 80 per cent? Probably not much, but one may get a A-, while the other may get a B+. Seeing that on a transcript could affect who gets a job which could affect income. In this case the percentage is a “forcing variable” or “forcing function” and the cut-off for an A- is a “threshold”. As the treatment is determined by the forcing variable we need to control for that variable. These seemingly arbitrary cut-offs can be seen all the time. Hence, there has been a great deal of work using RDD.</p>
<p>There is sometimes slightly different terminology used when it comes to RDD. For instance, <span class="citation" data-cites="Cunningham2021">Cunningham (<a href="99-references.html#ref-Cunningham2021" role="doc-biblioref">2021</a>)</span> refers to the forcing function as a running variable. The exact terminology that is used does not matter provided we use it consistently.</p>
<section id="simulated-example-income-and-grades" class="level3" data-number="15.5.1">
<h3 data-number="15.5.1" class="anchored" data-anchor-id="simulated-example-income-and-grades"><span class="header-section-number">15.5.1</span> Simulated example: income and grades</h3>
<p>To be more specific about the situation, we simulate data. We will consider the relationship between income and grades, and simulate there to be a change if a student gets at least 80 (<a href="#fig-rddmarks" class="quarto-xref">Figure&nbsp;<span>15.6</span></a>).</p>
<div class="cell" data-warnings="false">
<div class="sourceCode cell-code" id="cb34"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb34-1"><a href="#cb34-1" aria-hidden="true" tabindex="-1"></a><span class="fu">set.seed</span>(<span class="dv">853</span>)</span>
<span id="cb34-2"><a href="#cb34-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb34-3"><a href="#cb34-3" aria-hidden="true" tabindex="-1"></a>num_observations <span class="ot">&lt;-</span> <span class="dv">1000</span></span>
<span id="cb34-4"><a href="#cb34-4" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb34-5"><a href="#cb34-5" aria-hidden="true" tabindex="-1"></a>rdd_example_data <span class="ot">&lt;-</span> <span class="fu">tibble</span>(</span>
<span id="cb34-6"><a href="#cb34-6" aria-hidden="true" tabindex="-1"></a>  <span class="at">person =</span> <span class="fu">c</span>(<span class="dv">1</span><span class="sc">:</span>num_observations),</span>
<span id="cb34-7"><a href="#cb34-7" aria-hidden="true" tabindex="-1"></a>  <span class="at">mark =</span> <span class="fu">runif</span>(num_observations, <span class="at">min =</span> <span class="dv">78</span>, <span class="at">max =</span> <span class="dv">82</span>),</span>
<span id="cb34-8"><a href="#cb34-8" aria-hidden="true" tabindex="-1"></a>  <span class="at">income =</span> <span class="fu">rnorm</span>(num_observations, <span class="dv">10</span>, <span class="dv">1</span>)</span>
<span id="cb34-9"><a href="#cb34-9" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb34-10"><a href="#cb34-10" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb34-11"><a href="#cb34-11" aria-hidden="true" tabindex="-1"></a><span class="do">## Make income more likely to be higher if mark at least 80</span></span>
<span id="cb34-12"><a href="#cb34-12" aria-hidden="true" tabindex="-1"></a>rdd_example_data <span class="ot">&lt;-</span></span>
<span id="cb34-13"><a href="#cb34-13" aria-hidden="true" tabindex="-1"></a>  rdd_example_data <span class="sc">|&gt;</span></span>
<span id="cb34-14"><a href="#cb34-14" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(</span>
<span id="cb34-15"><a href="#cb34-15" aria-hidden="true" tabindex="-1"></a>    <span class="at">noise =</span> <span class="fu">rnorm</span>(<span class="at">n =</span> num_observations, <span class="at">mean =</span> <span class="dv">2</span>, <span class="at">sd =</span> <span class="dv">1</span>),</span>
<span id="cb34-16"><a href="#cb34-16" aria-hidden="true" tabindex="-1"></a>    <span class="at">income =</span> <span class="fu">if_else</span>(mark <span class="sc">&gt;=</span> <span class="dv">80</span>, income <span class="sc">+</span> noise, income)</span>
<span id="cb34-17"><a href="#cb34-17" aria-hidden="true" tabindex="-1"></a>  )</span>
<span id="cb34-18"><a href="#cb34-18" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb34-19"><a href="#cb34-19" aria-hidden="true" tabindex="-1"></a>rdd_example_data</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code># A tibble: 1,000 × 4
   person  mark income noise
    &lt;int&gt; &lt;dbl&gt;  &lt;dbl&gt; &lt;dbl&gt;
 1      1  79.4   9.43 1.87 
 2      2  78.5   9.69 2.26 
 3      3  79.9  10.8  1.14 
 4      4  79.3   9.34 2.50 
 5      5  78.1  10.7  2.21 
 6      6  79.6   9.83 2.47 
 7      7  78.5   8.96 4.22 
 8      8  79.0  10.5  3.11 
 9      9  78.6   9.53 0.671
10     10  78.8  10.6  2.46 
# ℹ 990 more rows</code></pre>
</div>
</div>
<div class="cell">
<div class="sourceCode cell-code" id="cb36"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb36-1"><a href="#cb36-1" aria-hidden="true" tabindex="-1"></a>rdd_example_data <span class="sc">|&gt;</span></span>
<span id="cb36-2"><a href="#cb36-2" aria-hidden="true" tabindex="-1"></a>  <span class="fu">ggplot</span>(<span class="fu">aes</span>(</span>
<span id="cb36-3"><a href="#cb36-3" aria-hidden="true" tabindex="-1"></a>    <span class="at">x =</span> mark,</span>
<span id="cb36-4"><a href="#cb36-4" aria-hidden="true" tabindex="-1"></a>    <span class="at">y =</span> income</span>
<span id="cb36-5"><a href="#cb36-5" aria-hidden="true" tabindex="-1"></a>  )) <span class="sc">+</span></span>
<span id="cb36-6"><a href="#cb36-6" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_point</span>(<span class="at">alpha =</span> <span class="fl">0.2</span>) <span class="sc">+</span></span>
<span id="cb36-7"><a href="#cb36-7" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_smooth</span>(</span>
<span id="cb36-8"><a href="#cb36-8" aria-hidden="true" tabindex="-1"></a>    <span class="at">data =</span> rdd_example_data <span class="sc">|&gt;</span> <span class="fu">filter</span>(mark <span class="sc">&lt;</span> <span class="dv">80</span>),</span>
<span id="cb36-9"><a href="#cb36-9" aria-hidden="true" tabindex="-1"></a>    <span class="at">method =</span> <span class="st">"lm"</span>,</span>
<span id="cb36-10"><a href="#cb36-10" aria-hidden="true" tabindex="-1"></a>    <span class="at">color =</span> <span class="st">"black"</span>,</span>
<span id="cb36-11"><a href="#cb36-11" aria-hidden="true" tabindex="-1"></a>    <span class="at">formula =</span> <span class="st">"y ~ x"</span></span>
<span id="cb36-12"><a href="#cb36-12" aria-hidden="true" tabindex="-1"></a>  ) <span class="sc">+</span></span>
<span id="cb36-13"><a href="#cb36-13" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_smooth</span>(</span>
<span id="cb36-14"><a href="#cb36-14" aria-hidden="true" tabindex="-1"></a>    <span class="at">data =</span> rdd_example_data <span class="sc">|&gt;</span> <span class="fu">filter</span>(mark <span class="sc">&gt;=</span> <span class="dv">80</span>),</span>
<span id="cb36-15"><a href="#cb36-15" aria-hidden="true" tabindex="-1"></a>    <span class="at">method =</span> <span class="st">"lm"</span>,</span>
<span id="cb36-16"><a href="#cb36-16" aria-hidden="true" tabindex="-1"></a>    <span class="at">color =</span> <span class="st">"black"</span>,</span>
<span id="cb36-17"><a href="#cb36-17" aria-hidden="true" tabindex="-1"></a>    <span class="at">formula =</span> <span class="st">"y ~ x"</span></span>
<span id="cb36-18"><a href="#cb36-18" aria-hidden="true" tabindex="-1"></a>  ) <span class="sc">+</span></span>
<span id="cb36-19"><a href="#cb36-19" aria-hidden="true" tabindex="-1"></a>  <span class="fu">theme_minimal</span>() <span class="sc">+</span></span>
<span id="cb36-20"><a href="#cb36-20" aria-hidden="true" tabindex="-1"></a>  <span class="fu">labs</span>(</span>
<span id="cb36-21"><a href="#cb36-21" aria-hidden="true" tabindex="-1"></a>    <span class="at">x =</span> <span class="st">"Mark"</span>,</span>
<span id="cb36-22"><a href="#cb36-22" aria-hidden="true" tabindex="-1"></a>    <span class="at">y =</span> <span class="st">"Income ($)"</span></span>
<span id="cb36-23"><a href="#cb36-23" aria-hidden="true" tabindex="-1"></a>  )</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">
<div id="fig-rddmarks" class="quarto-figure quarto-figure-center quarto-float anchored">
<figure class="quarto-float quarto-float-fig figure">
<div aria-describedby="fig-rddmarks-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
<img src="14-causality_from_obs_files/figure-html/fig-rddmarks-1.png" class="img-fluid figure-img" width="672">
</div>
<figcaption class="quarto-float-caption-bottom quarto-float-caption quarto-float-fig" id="fig-rddmarks-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
Figure&nbsp;15.6: Illustration of simulated data that shows an effect on income from getting a mark that is 80, compared with 79
</figcaption>
</figure>
</div>
</div>
</div>
<p>We can use a binary variable with linear regression to estimate the effect of getting a mark over 80 on income. We expect the coefficient to be around two, which is what we simulated, and what we find (<a href="#tbl-rddexample" class="quarto-xref">Table&nbsp;<span>15.5</span></a>).</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb37"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb37-1"><a href="#cb37-1" aria-hidden="true" tabindex="-1"></a>rdd_example_data <span class="ot">&lt;-</span></span>
<span id="cb37-2"><a href="#cb37-2" aria-hidden="true" tabindex="-1"></a>  rdd_example_data <span class="sc">|&gt;</span></span>
<span id="cb37-3"><a href="#cb37-3" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(<span class="at">mark_80_and_over =</span> <span class="fu">if_else</span>(mark <span class="sc">&lt;</span> <span class="dv">80</span>, <span class="dv">0</span>, <span class="dv">1</span>))</span>
<span id="cb37-4"><a href="#cb37-4" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb37-5"><a href="#cb37-5" aria-hidden="true" tabindex="-1"></a>rdd_example <span class="ot">&lt;-</span></span>
<span id="cb37-6"><a href="#cb37-6" aria-hidden="true" tabindex="-1"></a>  <span class="fu">stan_glm</span>(</span>
<span id="cb37-7"><a href="#cb37-7" aria-hidden="true" tabindex="-1"></a>    <span class="at">formula =</span> income <span class="sc">~</span> mark <span class="sc">+</span> mark_80_and_over,</span>
<span id="cb37-8"><a href="#cb37-8" aria-hidden="true" tabindex="-1"></a>    <span class="at">data =</span> rdd_example_data,</span>
<span id="cb37-9"><a href="#cb37-9" aria-hidden="true" tabindex="-1"></a>    <span class="at">family =</span> <span class="fu">gaussian</span>(),</span>
<span id="cb37-10"><a href="#cb37-10" aria-hidden="true" tabindex="-1"></a>    <span class="at">prior =</span> <span class="fu">normal</span>(<span class="at">location =</span> <span class="dv">0</span>, <span class="at">scale =</span> <span class="fl">2.5</span>, <span class="at">autoscale =</span> <span class="cn">TRUE</span>),</span>
<span id="cb37-11"><a href="#cb37-11" aria-hidden="true" tabindex="-1"></a>    <span class="at">prior_intercept =</span> <span class="fu">normal</span>(<span class="dv">0</span>, <span class="fl">2.5</span>, <span class="at">autoscale =</span> <span class="cn">TRUE</span>),</span>
<span id="cb37-12"><a href="#cb37-12" aria-hidden="true" tabindex="-1"></a>    <span class="at">prior_aux =</span> <span class="fu">exponential</span>(<span class="at">rate =</span> <span class="dv">1</span>, <span class="at">autoscale =</span> <span class="cn">TRUE</span>),</span>
<span id="cb37-13"><a href="#cb37-13" aria-hidden="true" tabindex="-1"></a>    <span class="at">seed =</span> <span class="dv">853</span></span>
<span id="cb37-14"><a href="#cb37-14" aria-hidden="true" tabindex="-1"></a>  )</span>
<span id="cb37-15"><a href="#cb37-15" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb37-16"><a href="#cb37-16" aria-hidden="true" tabindex="-1"></a><span class="fu">saveRDS</span>(</span>
<span id="cb37-17"><a href="#cb37-17" aria-hidden="true" tabindex="-1"></a>  rdd_example,</span>
<span id="cb37-18"><a href="#cb37-18" aria-hidden="true" tabindex="-1"></a>  <span class="at">file =</span> <span class="st">"rdd_example.rds"</span></span>
<span id="cb37-19"><a href="#cb37-19" aria-hidden="true" tabindex="-1"></a>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div class="cell">
<div class="sourceCode cell-code" id="cb38"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb38-1"><a href="#cb38-1" aria-hidden="true" tabindex="-1"></a>rdd_example <span class="ot">&lt;-</span></span>
<span id="cb38-2"><a href="#cb38-2" aria-hidden="true" tabindex="-1"></a>  <span class="fu">readRDS</span>(<span class="at">file =</span> <span class="st">"rdd_example.rds"</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div class="cell">
<div class="sourceCode cell-code" id="cb39"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb39-1"><a href="#cb39-1" aria-hidden="true" tabindex="-1"></a><span class="fu">modelsummary</span>(</span>
<span id="cb39-2"><a href="#cb39-2" aria-hidden="true" tabindex="-1"></a>  <span class="at">models =</span> rdd_example,</span>
<span id="cb39-3"><a href="#cb39-3" aria-hidden="true" tabindex="-1"></a>  <span class="at">fmt =</span> <span class="dv">2</span></span>
<span id="cb39-4"><a href="#cb39-4" aria-hidden="true" tabindex="-1"></a>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div id="tbl-rddexample" class="cell quarto-float anchored">
<figure class="quarto-float quarto-float-tbl figure">
<figcaption class="quarto-float-caption-top quarto-float-caption quarto-float-tbl" id="tbl-rddexample-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
Table&nbsp;15.5: Example of regression discontinuity with simulated data
</figcaption>
<div aria-describedby="tbl-rddexample-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
<div class="cell-output-display">
<!-- preamble start -->

    <script>
      function styleCell_c7s996e5v759wwk4hzhu(i, j, css_id) {
        var table = document.getElementById("tinytable_c7s996e5v759wwk4hzhu");
        table.rows[i].cells[j].classList.add(css_id);
      }
      function insertSpanRow(i, colspan, content) {
        var table = document.getElementById('tinytable_c7s996e5v759wwk4hzhu');
        var newRow = table.insertRow(i);
        var newCell = newRow.insertCell(0);
        newCell.setAttribute("colspan", colspan);
        // newCell.innerText = content;
        // this may be unsafe, but innerText does not interpret <br>
        newCell.innerHTML = content;
      }
      function spanCell_c7s996e5v759wwk4hzhu(i, j, rowspan, colspan) {
        var table = document.getElementById("tinytable_c7s996e5v759wwk4hzhu");
        const targetRow = table.rows[i];
        const targetCell = targetRow.cells[j];
        for (let r = 0; r < rowspan; r++) {
          // Only start deleting cells to the right for the first row (r == 0)
          if (r === 0) {
            // Delete cells to the right of the target cell in the first row
            for (let c = colspan - 1; c > 0; c--) {
              if (table.rows[i + r].cells[j + c]) {
                table.rows[i + r].deleteCell(j + c);
              }
            }
          }
          // For rows below the first, delete starting from the target column
          if (r > 0) {
            for (let c = colspan - 1; c >= 0; c--) {
              if (table.rows[i + r] && table.rows[i + r].cells[j]) {
                table.rows[i + r].deleteCell(j);
              }
            }
          }
        }
        // Set rowspan and colspan of the target cell
        targetCell.rowSpan = rowspan;
        targetCell.colSpan = colspan;
      }
window.addEventListener('load', function () { styleCell_c7s996e5v759wwk4hzhu(0, 0, 'tinytable_css_idd3503mt5906gk1s62fwy') })
window.addEventListener('load', function () { styleCell_c7s996e5v759wwk4hzhu(0, 1, 'tinytable_css_idvjqul6h07f1o00cebdt2') })
window.addEventListener('load', function () { styleCell_c7s996e5v759wwk4hzhu(1, 0, 'tinytable_css_idnijhtlwk43jbj4vvn07t') })
window.addEventListener('load', function () { styleCell_c7s996e5v759wwk4hzhu(1, 1, 'tinytable_css_id0o5kaxl5uzvyje3t452p') })
window.addEventListener('load', function () { styleCell_c7s996e5v759wwk4hzhu(2, 0, 'tinytable_css_idnijhtlwk43jbj4vvn07t') })
window.addEventListener('load', function () { styleCell_c7s996e5v759wwk4hzhu(2, 1, 'tinytable_css_id0o5kaxl5uzvyje3t452p') })
window.addEventListener('load', function () { styleCell_c7s996e5v759wwk4hzhu(3, 0, 'tinytable_css_idrr5qmml7j69cy358sykq') })
window.addEventListener('load', function () { styleCell_c7s996e5v759wwk4hzhu(3, 1, 'tinytable_css_idz0ag1kjovfzv1sgxsw4s') })
window.addEventListener('load', function () { styleCell_c7s996e5v759wwk4hzhu(4, 0, 'tinytable_css_idnijhtlwk43jbj4vvn07t') })
window.addEventListener('load', function () { styleCell_c7s996e5v759wwk4hzhu(4, 1, 'tinytable_css_id0o5kaxl5uzvyje3t452p') })
window.addEventListener('load', function () { styleCell_c7s996e5v759wwk4hzhu(5, 0, 'tinytable_css_idnijhtlwk43jbj4vvn07t') })
window.addEventListener('load', function () { styleCell_c7s996e5v759wwk4hzhu(5, 1, 'tinytable_css_id0o5kaxl5uzvyje3t452p') })
window.addEventListener('load', function () { styleCell_c7s996e5v759wwk4hzhu(6, 0, 'tinytable_css_idnijhtlwk43jbj4vvn07t') })
window.addEventListener('load', function () { styleCell_c7s996e5v759wwk4hzhu(6, 1, 'tinytable_css_id0o5kaxl5uzvyje3t452p') })
window.addEventListener('load', function () { styleCell_c7s996e5v759wwk4hzhu(7, 0, 'tinytable_css_idnijhtlwk43jbj4vvn07t') })
window.addEventListener('load', function () { styleCell_c7s996e5v759wwk4hzhu(7, 1, 'tinytable_css_id0o5kaxl5uzvyje3t452p') })
window.addEventListener('load', function () { styleCell_c7s996e5v759wwk4hzhu(8, 0, 'tinytable_css_idnijhtlwk43jbj4vvn07t') })
window.addEventListener('load', function () { styleCell_c7s996e5v759wwk4hzhu(8, 1, 'tinytable_css_id0o5kaxl5uzvyje3t452p') })
window.addEventListener('load', function () { styleCell_c7s996e5v759wwk4hzhu(9, 0, 'tinytable_css_idnijhtlwk43jbj4vvn07t') })
window.addEventListener('load', function () { styleCell_c7s996e5v759wwk4hzhu(9, 1, 'tinytable_css_id0o5kaxl5uzvyje3t452p') })
window.addEventListener('load', function () { styleCell_c7s996e5v759wwk4hzhu(10, 0, 'tinytable_css_idnijhtlwk43jbj4vvn07t') })
window.addEventListener('load', function () { styleCell_c7s996e5v759wwk4hzhu(10, 1, 'tinytable_css_id0o5kaxl5uzvyje3t452p') })
window.addEventListener('load', function () { styleCell_c7s996e5v759wwk4hzhu(11, 0, 'tinytable_css_idnijhtlwk43jbj4vvn07t') })
window.addEventListener('load', function () { styleCell_c7s996e5v759wwk4hzhu(11, 1, 'tinytable_css_id0o5kaxl5uzvyje3t452p') })
window.addEventListener('load', function () { styleCell_c7s996e5v759wwk4hzhu(12, 0, 'tinytable_css_idnijhtlwk43jbj4vvn07t') })
window.addEventListener('load', function () { styleCell_c7s996e5v759wwk4hzhu(12, 1, 'tinytable_css_id0o5kaxl5uzvyje3t452p') })
window.addEventListener('load', function () { styleCell_c7s996e5v759wwk4hzhu(13, 0, 'tinytable_css_idnijhtlwk43jbj4vvn07t') })
window.addEventListener('load', function () { styleCell_c7s996e5v759wwk4hzhu(13, 1, 'tinytable_css_id0o5kaxl5uzvyje3t452p') })
    </script>

    <style>
    .table td.tinytable_css_idd3503mt5906gk1s62fwy, .table th.tinytable_css_idd3503mt5906gk1s62fwy {  text-align: left;  border-bottom: solid 0.1em #d3d8dc; }
    .table td.tinytable_css_idvjqul6h07f1o00cebdt2, .table th.tinytable_css_idvjqul6h07f1o00cebdt2 {  text-align: center;  border-bottom: solid 0.1em #d3d8dc; }
    .table td.tinytable_css_idnijhtlwk43jbj4vvn07t, .table th.tinytable_css_idnijhtlwk43jbj4vvn07t {  text-align: left; }
    .table td.tinytable_css_id0o5kaxl5uzvyje3t452p, .table th.tinytable_css_id0o5kaxl5uzvyje3t452p {  text-align: center; }
    .table td.tinytable_css_idrr5qmml7j69cy358sykq, .table th.tinytable_css_idrr5qmml7j69cy358sykq {  border-bottom: solid 0.05em black;  text-align: left; }
    .table td.tinytable_css_idz0ag1kjovfzv1sgxsw4s, .table th.tinytable_css_idz0ag1kjovfzv1sgxsw4s {  border-bottom: solid 0.05em black;  text-align: center; }
    </style>
    <div class="container">
      <table class="table table-borderless" id="tinytable_c7s996e5v759wwk4hzhu" style="width: auto; margin-left: auto; margin-right: auto;" data-quarto-disable-processing="true">
        <thead>
        
              <tr>
                <th scope="col"> </th>
                <th scope="col">(1)</th>
              </tr>
        </thead>
        
        <tbody>
                <tr>
                  <td>(Intercept)     </td>
                  <td>5.22     </td>
                </tr>
                <tr>
                  <td>mark            </td>
                  <td>0.06     </td>
                </tr>
                <tr>
                  <td>mark_80_and_over</td>
                  <td>1.89     </td>
                </tr>
                <tr>
                  <td>Num.Obs.        </td>
                  <td>1000     </td>
                </tr>
                <tr>
                  <td>R2              </td>
                  <td>0.417    </td>
                </tr>
                <tr>
                  <td>R2 Adj.         </td>
                  <td>0.415    </td>
                </tr>
                <tr>
                  <td>Log.Lik.        </td>
                  <td>-1591.847</td>
                </tr>
                <tr>
                  <td>ELPD            </td>
                  <td>-1595.1  </td>
                </tr>
                <tr>
                  <td>ELPD s.e.       </td>
                  <td>25.4     </td>
                </tr>
                <tr>
                  <td>LOOIC           </td>
                  <td>3190.3   </td>
                </tr>
                <tr>
                  <td>LOOIC s.e.      </td>
                  <td>50.9     </td>
                </tr>
                <tr>
                  <td>WAIC            </td>
                  <td>3190.3   </td>
                </tr>
                <tr>
                  <td>RMSE            </td>
                  <td>1.19     </td>
                </tr>
        </tbody>
      </table>
    </div>
<!-- hack to avoid NA insertion in last line -->
</div>
</div>
</figure>
</div>
</div>
<p>There are various caveats to this estimate that we will discuss, but the essentials of RDD are here. Given an appropriate set-up, and model, RDD can compare favorably to randomized trials <span class="citation" data-cites="bloombellreiman2020">(<a href="99-references.html#ref-bloombellreiman2020" role="doc-biblioref">Bloom, Bell, and Reiman 2020</a>)</span>.</p>
<p>We could also implement RDD using <code>rdrobust</code>. The advantage of this approach is that many common extensions are easily available.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb40"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb40-1"><a href="#cb40-1" aria-hidden="true" tabindex="-1"></a><span class="fu">rdrobust</span>(</span>
<span id="cb40-2"><a href="#cb40-2" aria-hidden="true" tabindex="-1"></a>  <span class="at">y =</span> rdd_example_data<span class="sc">$</span>income,</span>
<span id="cb40-3"><a href="#cb40-3" aria-hidden="true" tabindex="-1"></a>  <span class="at">x =</span> rdd_example_data<span class="sc">$</span>mark,</span>
<span id="cb40-4"><a href="#cb40-4" aria-hidden="true" tabindex="-1"></a>  <span class="at">c =</span> <span class="dv">80</span>,</span>
<span id="cb40-5"><a href="#cb40-5" aria-hidden="true" tabindex="-1"></a>  <span class="at">h =</span> <span class="dv">2</span>,</span>
<span id="cb40-6"><a href="#cb40-6" aria-hidden="true" tabindex="-1"></a>  <span class="at">all =</span> <span class="cn">TRUE</span></span>
<span id="cb40-7"><a href="#cb40-7" aria-hidden="true" tabindex="-1"></a>) <span class="sc">|&gt;</span></span>
<span id="cb40-8"><a href="#cb40-8" aria-hidden="true" tabindex="-1"></a>  <span class="fu">summary</span>()</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>Sharp RD estimates using local polynomial regression.

Number of Obs.                 1000
BW type                      Manual
Kernel                   Triangular
VCE method                       NN

Number of Obs.                  497          503
Eff. Number of Obs.             497          503
Order est. (p)                    1            1
Order bias  (q)                   2            2
BW est. (h)                   2.000        2.000
BW bias (b)                   2.000        2.000
rho (h/b)                     1.000        1.000
Unique Obs.                     497          503

=============================================================================
        Method     Coef. Std. Err.         z     P&gt;|z|      [ 95% C.I. ]       
=============================================================================
  Conventional     1.913     0.161    11.876     0.000     [1.597 , 2.229]     
Bias-Corrected     1.966     0.161    12.207     0.000     [1.650 , 2.282]     
        Robust     1.966     0.232     8.461     0.000     [1.511 , 2.422]     
=============================================================================</code></pre>
</div>
</div>
</section>
<section id="assumptions-1" class="level3" data-number="15.5.2">
<h3 data-number="15.5.2" class="anchored" data-anchor-id="assumptions-1"><span class="header-section-number">15.5.2</span> Assumptions</h3>
<p>The key assumptions of RDD are <span class="citation" data-cites="Cunningham2021">(<a href="99-references.html#ref-Cunningham2021" role="doc-biblioref">Cunningham 2021, 163</a>)</span>:</p>
<ol type="1">
<li>The cut-off is specific, fixed, and known to all.</li>
<li>The forcing function is continuous.</li>
</ol>
<p>The first assumption is largely about being unable to manipulate the cut-off, and ensures that the cut-off has meaning. The second assumption enables us to be confident that people on either side of the threshold are similar, apart from just happening to just fall on either side of the threshold.</p>
<p>When we discussed randomized control trials and A/B testing in <a href="08-hunt.html" class="quarto-xref"><span>Chapter 8</span></a> the randomized assignment of the treatment meant that the control and treatment groups were the same, but for the treatment. Then we moved to difference-in-differences, and we assumed that there was a common trend between the treated and control groups. We allowed that the groups could be different, but that we could “difference out” their differences. Finally, we considered matching, and we said that even if the control and treatment groups seemed different, we were able to match, to some extent, those who were treated with a group that were like them in all ways, apart from the fact that they were not treated.</p>
<p>In regression discontinuity we consider a slightly different setting. The two groups are completely different in terms of the forcing variable. They are on either side of the threshold. There is no overlap at all. But we know the threshold and believe that those on either side are essentially matched. Let us consider the 2019 NBA Eastern Conference Semifinals—Toronto and Philadelphia:</p>
<ul>
<li>Game 1: Raptors win 108-95;</li>
<li>Game 2: 76ers win 94-89;</li>
<li>Game 3: 76ers win 116-95;</li>
<li>Game 4: Raptors win 101-96;</li>
<li>Game 5: Raptors win 125-89;</li>
<li>Game 6: 76ers win 112-101; and finally,</li>
<li>Game 7: Raptors win 92-90, because of a ball that went in after bouncing on the rim four times.</li>
</ul>
<p>Was there really that much difference between the teams?</p>
<p>The continuity assumption is important, but we cannot test this as it is based on a counterfactual. Instead, we need to convince people of it. Ways to do this include:</p>
<ul>
<li>Using a test/train set-up.</li>
<li>Trying different specifications. We are especially concerned if results do not broadly persist with just linear or quadratic functions.</li>
<li>Considering different subsets of the data.</li>
<li>Considering different windows, which is the term we give to how far each side of the cutoff we examine.</li>
<li>Being clear about uncertainty intervals, especially in graphs.</li>
<li>Discuss and assuaging concerns about the possibility of omitted variables.</li>
</ul>
<p>The threshold is also important. For instance, is there an actual shift or is there a non-linear relationship?</p>
<p>There are a variety of weaknesses of RDD, including:</p>
<ul>
<li>External validity may be difficult. For instance, when we think about the A-/B+ example, it is hard to see those generalizing to also B-/C+ students.</li>
<li>The important responses are those that are close to the cut-off. This means that even if we have many A and B students, they do not help much. Hence, we need a lot of data or we may have concerns about our ability to support our claims <span class="citation" data-cites="green2009testing">(<a href="99-references.html#ref-green2009testing" role="doc-biblioref">Green et al. 2009</a>)</span>.</li>
<li>As the researcher, we have a lot of freedom to implement different options. This means that open science best practice becomes vital.</li>
</ul>
<p>To this point we have considered “sharp” RDD. That is, the threshold is strict. But, in reality, often the boundary is a little less strict. In a sharp RDD setting, if we know the value of the forcing function then we know the outcome. For instance, if a student gets a mark of 80 then we know that they got an A-, but if they got a mark of 79 then we know that they got a B+. But with fuzzy RDD it is only known with some probability.</p>
<p>We want as “sharp” an effect as possible, but if the thresholds are known, then they will be gamed. For instance, there is a lot of evidence that people run for certain marathon times, and we know that people aim for certain grades. Similarly, from the other side, it is a lot easier for an instructor to just give out As than it is to have to justify Bs. One way to look at this is to consider how “balanced” the sample is on either side of the threshold. We can do this using histograms with appropriate bins. For instance, think of the age-heaping that we found in the cleaned Kenyan census data in <a href="09-clean_and_prepare.html" class="quarto-xref"><span>Chapter 9</span></a>.</p>
<p>Another key factor for RDD is the possible effect of the decision around the choice of model. For instance, <a href="#fig-rddissuperconcerning" class="quarto-xref">Figure&nbsp;<span>15.7</span></a> illustrates the difference between linear (<a href="#fig-rddissuperconcerning-1" class="quarto-xref">Figure&nbsp;<span>15.7 (a)</span></a>) and polynomial (<a href="#fig-rddissuperconcerning-2" class="quarto-xref">Figure&nbsp;<span>15.7 (b)</span></a>).</p>
<div class="sourceCode cell-code" id="cb42"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb42-1"><a href="#cb42-1" aria-hidden="true" tabindex="-1"></a>some_data <span class="ot">&lt;-</span></span>
<span id="cb42-2"><a href="#cb42-2" aria-hidden="true" tabindex="-1"></a>  <span class="fu">tibble</span>(</span>
<span id="cb42-3"><a href="#cb42-3" aria-hidden="true" tabindex="-1"></a>    <span class="at">outcome =</span> <span class="fu">rnorm</span>(<span class="at">n =</span> <span class="dv">100</span>, <span class="at">mean =</span> <span class="dv">1</span>, <span class="at">sd =</span> <span class="dv">1</span>),</span>
<span id="cb42-4"><a href="#cb42-4" aria-hidden="true" tabindex="-1"></a>    <span class="at">running_variable =</span> <span class="fu">c</span>(<span class="dv">1</span><span class="sc">:</span><span class="dv">100</span>),</span>
<span id="cb42-5"><a href="#cb42-5" aria-hidden="true" tabindex="-1"></a>    <span class="at">location =</span> <span class="st">"before"</span></span>
<span id="cb42-6"><a href="#cb42-6" aria-hidden="true" tabindex="-1"></a>  )</span>
<span id="cb42-7"><a href="#cb42-7" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb42-8"><a href="#cb42-8" aria-hidden="true" tabindex="-1"></a>some_more_data <span class="ot">&lt;-</span></span>
<span id="cb42-9"><a href="#cb42-9" aria-hidden="true" tabindex="-1"></a>  <span class="fu">tibble</span>(</span>
<span id="cb42-10"><a href="#cb42-10" aria-hidden="true" tabindex="-1"></a>    <span class="at">outcome =</span> <span class="fu">rnorm</span>(<span class="at">n =</span> <span class="dv">100</span>, <span class="at">mean =</span> <span class="dv">2</span>, <span class="at">sd =</span> <span class="dv">1</span>),</span>
<span id="cb42-11"><a href="#cb42-11" aria-hidden="true" tabindex="-1"></a>    <span class="at">running_variable =</span> <span class="fu">c</span>(<span class="dv">101</span><span class="sc">:</span><span class="dv">200</span>),</span>
<span id="cb42-12"><a href="#cb42-12" aria-hidden="true" tabindex="-1"></a>    <span class="at">location =</span> <span class="st">"after"</span></span>
<span id="cb42-13"><a href="#cb42-13" aria-hidden="true" tabindex="-1"></a>  )</span>
<span id="cb42-14"><a href="#cb42-14" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb42-15"><a href="#cb42-15" aria-hidden="true" tabindex="-1"></a>both <span class="ot">&lt;-</span></span>
<span id="cb42-16"><a href="#cb42-16" aria-hidden="true" tabindex="-1"></a>  <span class="fu">rbind</span>(some_data, some_more_data)</span>
<span id="cb42-17"><a href="#cb42-17" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb42-18"><a href="#cb42-18" aria-hidden="true" tabindex="-1"></a>both <span class="sc">|&gt;</span></span>
<span id="cb42-19"><a href="#cb42-19" aria-hidden="true" tabindex="-1"></a>  <span class="fu">ggplot</span>(<span class="fu">aes</span>(<span class="at">x =</span> running_variable, <span class="at">y =</span> outcome, <span class="at">color =</span> location)) <span class="sc">+</span></span>
<span id="cb42-20"><a href="#cb42-20" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_point</span>(<span class="at">alpha =</span> <span class="fl">0.5</span>) <span class="sc">+</span></span>
<span id="cb42-21"><a href="#cb42-21" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_smooth</span>(<span class="at">formula =</span> y <span class="sc">~</span> x, <span class="at">method =</span> <span class="st">"lm"</span>) <span class="sc">+</span></span>
<span id="cb42-22"><a href="#cb42-22" aria-hidden="true" tabindex="-1"></a>  <span class="fu">theme_minimal</span>() <span class="sc">+</span></span>
<span id="cb42-23"><a href="#cb42-23" aria-hidden="true" tabindex="-1"></a>  <span class="fu">theme</span>(<span class="at">legend.position =</span> <span class="st">"bottom"</span>)</span>
<span id="cb42-24"><a href="#cb42-24" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb42-25"><a href="#cb42-25" aria-hidden="true" tabindex="-1"></a>both <span class="sc">|&gt;</span></span>
<span id="cb42-26"><a href="#cb42-26" aria-hidden="true" tabindex="-1"></a>  <span class="fu">ggplot</span>(<span class="fu">aes</span>(<span class="at">x =</span> running_variable, <span class="at">y =</span> outcome, <span class="at">color =</span> location)) <span class="sc">+</span></span>
<span id="cb42-27"><a href="#cb42-27" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_point</span>(<span class="at">alpha =</span> <span class="fl">0.5</span>) <span class="sc">+</span></span>
<span id="cb42-28"><a href="#cb42-28" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_smooth</span>(<span class="at">formula =</span> y <span class="sc">~</span> <span class="fu">poly</span>(x, <span class="dv">3</span>), <span class="at">method =</span> <span class="st">"lm"</span>) <span class="sc">+</span></span>
<span id="cb42-29"><a href="#cb42-29" aria-hidden="true" tabindex="-1"></a>  <span class="fu">theme_minimal</span>() <span class="sc">+</span></span>
<span id="cb42-30"><a href="#cb42-30" aria-hidden="true" tabindex="-1"></a>  <span class="fu">theme</span>(<span class="at">legend.position =</span> <span class="st">"bottom"</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div id="fig-rddissuperconcerning" class="quarto-layout-panel">
<figure class="quarto-float quarto-float-fig figure">
<div aria-describedby="fig-rddissuperconcerning-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
<div class="quarto-layout-row">
<div class="cell-output-display quarto-layout-cell-subref quarto-layout-cell" data-ref-parent="fig-rddissuperconcerning" style="flex-basis: 50.0%;justify-content: flex-start;">
<div id="fig-rddissuperconcerning-1" class="quarto-figure quarto-figure-center quarto-float anchored">
<figure class="quarto-float quarto-subfloat-fig figure">
<div aria-describedby="fig-rddissuperconcerning-1-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
<img src="14-causality_from_obs_files/figure-html/fig-rddissuperconcerning-1.png" class="img-fluid figure-img" data-ref-parent="fig-rddissuperconcerning" width="672">
</div>
<figcaption class="quarto-float-caption-bottom quarto-subfloat-caption quarto-subfloat-fig" id="fig-rddissuperconcerning-1-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
(a) Linear
</figcaption>
</figure>
</div>
</div>
<div class="cell-output-display quarto-layout-cell-subref quarto-layout-cell" data-ref-parent="fig-rddissuperconcerning" style="flex-basis: 50.0%;justify-content: flex-start;">
<div id="fig-rddissuperconcerning-2" class="quarto-figure quarto-figure-center quarto-float anchored">
<figure class="quarto-float quarto-subfloat-fig figure">
<div aria-describedby="fig-rddissuperconcerning-2-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
<img src="14-causality_from_obs_files/figure-html/fig-rddissuperconcerning-2.png" class="img-fluid figure-img" data-ref-parent="fig-rddissuperconcerning" width="672">
</div>
<figcaption class="quarto-float-caption-bottom quarto-subfloat-caption quarto-subfloat-fig" id="fig-rddissuperconcerning-2-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
(b) Polynomial
</figcaption>
</figure>
</div>
</div>
</div>
</div>
<figcaption class="quarto-float-caption-bottom quarto-float-caption quarto-float-fig" id="fig-rddissuperconcerning-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
Figure&nbsp;15.7: Comparing the result of considering the same situation with different functions
</figcaption>
</figure>
</div>
<p>The result is that our estimate of the difference in outcome is dependent on the choice of model. We see this issue occur often in RDD <span class="citation" data-cites="gelmanonrdd">(<a href="99-references.html#ref-gelmanonrdd" role="doc-biblioref">Gelman 2019</a>)</span> and it is especially recommended that higher order polynomials not be used, and instead the choice of models be either linear, quadratic, or some other smooth function <span class="citation" data-cites="gelmanimbensrdd">(<a href="99-references.html#ref-gelmanimbensrdd" role="doc-biblioref">Gelman and Imbens 2019</a>)</span>.</p>
<p>RDD is a popular approach, but meta-analysis suggests that standard errors are often inappropriately small and this could result in spurious results <span class="citation" data-cites="stommessaysno">(<a href="99-references.html#ref-stommessaysno" role="doc-biblioref">Stommes, Aronow, and Sävje 2023</a>)</span>. If you use RDD it is critical that you discuss the possibility of much wider standard errors than are reported by software packages, and what effect this would have on your conclusions.</p>
</section>
<section id="alcohol-and-crime-in-california" class="level3" data-number="15.5.3">
<h3 data-number="15.5.3" class="anchored" data-anchor-id="alcohol-and-crime-in-california"><span class="header-section-number">15.5.3</span> Alcohol and crime in California</h3>
<p>There are many opportunities to use regression discontinuity design. For instance, we often see it used in elections where one candidate barely wins. <span class="citation" data-cites="caugheysekhon2011">Caughey and Sekhon (<a href="99-references.html#ref-caugheysekhon2011" role="doc-biblioref">2011</a>)</span> examine US House elections between 1942 and 2008 and showed that there is considerable difference between bare winners and bare losers. They highlight that one of the advantages of regression discontinuity is the fact that the assumptions can be tested. Another common use is when there is a somewhat arbitrary cut-off. For instance, in much of the USA the legal drinking age is 21. <span class="citation" data-cites="carpenterdobkin">Carpenter and Dobkin (<a href="99-references.html#ref-carpenterdobkin" role="doc-biblioref">2015</a>)</span> consider the possible effect of alcohol on crime by comparing arrests and other records of those who are either side of 21 in California. They find those who are slightly over 21 are slightly more likely to be arrested than those slightly under 21. We will revisit <span class="citation" data-cites="carpenterdobkin">Carpenter and Dobkin (<a href="99-references.html#ref-carpenterdobkin" role="doc-biblioref">2015</a>)</span> in the context of crime in California.</p>
<p>We can obtain their replication data <span class="citation" data-cites="carpenterdobkinreplicationdata">(<a href="99-references.html#ref-carpenterdobkinreplicationdata" role="doc-biblioref">Carpenter and Dobkin 2014</a>)</span> from <a href="https://dataverse.harvard.edu/dataset.xhtml?persistentId=doi:10.7910/DVN/27070">here</a>. <span class="citation" data-cites="carpenterdobkin">Carpenter and Dobkin (<a href="99-references.html#ref-carpenterdobkin" role="doc-biblioref">2015</a>)</span> consider a large number of variables and construct a rate, and average this rate over a fortnight, but for simplicity, we will just consider numbers for a few variables: assault, aggravated assault, DUI, and traffic violations (<a href="#fig-californiaarrests" class="quarto-xref">Figure&nbsp;<span>15.8</span></a>).</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb43"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb43-1"><a href="#cb43-1" aria-hidden="true" tabindex="-1"></a>carpenter_dobkin <span class="ot">&lt;-</span></span>
<span id="cb43-2"><a href="#cb43-2" aria-hidden="true" tabindex="-1"></a>  <span class="fu">read_dta</span>(</span>
<span id="cb43-3"><a href="#cb43-3" aria-hidden="true" tabindex="-1"></a>    <span class="st">"P01 Age Profile of Arrest Rates 1979-2006.dta"</span></span>
<span id="cb43-4"><a href="#cb43-4" aria-hidden="true" tabindex="-1"></a>  )</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div class="cell">
<div class="sourceCode cell-code" id="cb44"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb44-1"><a href="#cb44-1" aria-hidden="true" tabindex="-1"></a>carpenter_dobkin_prepared <span class="ot">&lt;-</span></span>
<span id="cb44-2"><a href="#cb44-2" aria-hidden="true" tabindex="-1"></a>  carpenter_dobkin <span class="sc">|&gt;</span></span>
<span id="cb44-3"><a href="#cb44-3" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(<span class="at">age =</span> <span class="dv">21</span> <span class="sc">+</span> days_to_21 <span class="sc">/</span> <span class="dv">365</span>) <span class="sc">|&gt;</span></span>
<span id="cb44-4"><a href="#cb44-4" aria-hidden="true" tabindex="-1"></a>  <span class="fu">select</span>(age, assault, aggravated_assault, dui, traffic_violations) <span class="sc">|&gt;</span></span>
<span id="cb44-5"><a href="#cb44-5" aria-hidden="true" tabindex="-1"></a>  <span class="fu">pivot_longer</span>(</span>
<span id="cb44-6"><a href="#cb44-6" aria-hidden="true" tabindex="-1"></a>    <span class="at">cols =</span> <span class="fu">c</span>(assault, aggravated_assault, dui, traffic_violations),</span>
<span id="cb44-7"><a href="#cb44-7" aria-hidden="true" tabindex="-1"></a>    <span class="at">names_to =</span> <span class="st">"arrested_for"</span>,</span>
<span id="cb44-8"><a href="#cb44-8" aria-hidden="true" tabindex="-1"></a>    <span class="at">values_to =</span> <span class="st">"number"</span></span>
<span id="cb44-9"><a href="#cb44-9" aria-hidden="true" tabindex="-1"></a>  )</span>
<span id="cb44-10"><a href="#cb44-10" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb44-11"><a href="#cb44-11" aria-hidden="true" tabindex="-1"></a>carpenter_dobkin_prepared <span class="sc">|&gt;</span></span>
<span id="cb44-12"><a href="#cb44-12" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(</span>
<span id="cb44-13"><a href="#cb44-13" aria-hidden="true" tabindex="-1"></a>    <span class="at">arrested_for =</span></span>
<span id="cb44-14"><a href="#cb44-14" aria-hidden="true" tabindex="-1"></a>      <span class="fu">case_when</span>(</span>
<span id="cb44-15"><a href="#cb44-15" aria-hidden="true" tabindex="-1"></a>        arrested_for <span class="sc">==</span> <span class="st">"assault"</span> <span class="sc">~</span> <span class="st">"Assault"</span>,</span>
<span id="cb44-16"><a href="#cb44-16" aria-hidden="true" tabindex="-1"></a>        arrested_for <span class="sc">==</span> <span class="st">"aggravated_assault"</span> <span class="sc">~</span> <span class="st">"Aggravated assault"</span>,</span>
<span id="cb44-17"><a href="#cb44-17" aria-hidden="true" tabindex="-1"></a>        arrested_for <span class="sc">==</span> <span class="st">"dui"</span> <span class="sc">~</span> <span class="st">"DUI"</span>,</span>
<span id="cb44-18"><a href="#cb44-18" aria-hidden="true" tabindex="-1"></a>        arrested_for <span class="sc">==</span> <span class="st">"traffic_violations"</span> <span class="sc">~</span> <span class="st">"Traffic violations"</span></span>
<span id="cb44-19"><a href="#cb44-19" aria-hidden="true" tabindex="-1"></a>      )</span>
<span id="cb44-20"><a href="#cb44-20" aria-hidden="true" tabindex="-1"></a>  ) <span class="sc">|&gt;</span></span>
<span id="cb44-21"><a href="#cb44-21" aria-hidden="true" tabindex="-1"></a>  <span class="fu">ggplot</span>(<span class="fu">aes</span>(<span class="at">x =</span> age, <span class="at">y =</span> number)) <span class="sc">+</span></span>
<span id="cb44-22"><a href="#cb44-22" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_point</span>(<span class="at">alpha =</span> <span class="fl">0.05</span>) <span class="sc">+</span></span>
<span id="cb44-23"><a href="#cb44-23" aria-hidden="true" tabindex="-1"></a>  <span class="fu">facet_wrap</span>(<span class="at">facets =</span> <span class="fu">vars</span>(arrested_for), <span class="at">scales =</span> <span class="st">"free_y"</span>) <span class="sc">+</span></span>
<span id="cb44-24"><a href="#cb44-24" aria-hidden="true" tabindex="-1"></a>  <span class="fu">theme_minimal</span>()</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">
<div id="fig-californiaarrests" class="quarto-figure quarto-figure-center quarto-float anchored">
<figure class="quarto-float quarto-float-fig figure">
<div aria-describedby="fig-californiaarrests-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
<img src="14-causality_from_obs_files/figure-html/fig-californiaarrests-1.png" class="img-fluid figure-img" width="672">
</div>
<figcaption class="quarto-float-caption-bottom quarto-float-caption quarto-float-fig" id="fig-californiaarrests-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
Figure&nbsp;15.8: Comparing the number of arrests either side of turning 21 for selected reasons
</figcaption>
</figure>
</div>
</div>
</div>
<div class="cell">
<div class="sourceCode cell-code" id="cb45"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb45-1"><a href="#cb45-1" aria-hidden="true" tabindex="-1"></a>carpenter_dobkin_aggravated_assault_only <span class="ot">&lt;-</span></span>
<span id="cb45-2"><a href="#cb45-2" aria-hidden="true" tabindex="-1"></a>  carpenter_dobkin_prepared <span class="sc">|&gt;</span></span>
<span id="cb45-3"><a href="#cb45-3" aria-hidden="true" tabindex="-1"></a>  <span class="fu">filter</span>(</span>
<span id="cb45-4"><a href="#cb45-4" aria-hidden="true" tabindex="-1"></a>    arrested_for <span class="sc">==</span> <span class="st">"aggravated_assault"</span>,</span>
<span id="cb45-5"><a href="#cb45-5" aria-hidden="true" tabindex="-1"></a>    <span class="fu">abs</span>(age <span class="sc">-</span> <span class="dv">21</span>) <span class="sc">&lt;</span> <span class="dv">2</span></span>
<span id="cb45-6"><a href="#cb45-6" aria-hidden="true" tabindex="-1"></a>  ) <span class="sc">|&gt;</span></span>
<span id="cb45-7"><a href="#cb45-7" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(<span class="at">is_21_or_more =</span> <span class="fu">if_else</span>(age <span class="sc">&lt;</span> <span class="dv">21</span>, <span class="dv">0</span>, <span class="dv">1</span>))</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div class="cell">
<div class="sourceCode cell-code" id="cb46"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb46-1"><a href="#cb46-1" aria-hidden="true" tabindex="-1"></a>rdd_carpenter_dobkin <span class="ot">&lt;-</span></span>
<span id="cb46-2"><a href="#cb46-2" aria-hidden="true" tabindex="-1"></a>  <span class="fu">stan_glm</span>(</span>
<span id="cb46-3"><a href="#cb46-3" aria-hidden="true" tabindex="-1"></a>    <span class="at">formula =</span> number <span class="sc">~</span> age <span class="sc">+</span> is_21_or_more,</span>
<span id="cb46-4"><a href="#cb46-4" aria-hidden="true" tabindex="-1"></a>    <span class="at">data =</span> carpenter_dobkin_aggravated_assault_only,</span>
<span id="cb46-5"><a href="#cb46-5" aria-hidden="true" tabindex="-1"></a>    <span class="at">family =</span> <span class="fu">gaussian</span>(),</span>
<span id="cb46-6"><a href="#cb46-6" aria-hidden="true" tabindex="-1"></a>    <span class="at">prior =</span> <span class="fu">normal</span>(<span class="at">location =</span> <span class="dv">0</span>, <span class="at">scale =</span> <span class="fl">2.5</span>, <span class="at">autoscale =</span> <span class="cn">TRUE</span>),</span>
<span id="cb46-7"><a href="#cb46-7" aria-hidden="true" tabindex="-1"></a>    <span class="at">prior_intercept =</span> <span class="fu">normal</span>(<span class="dv">0</span>, <span class="fl">2.5</span>, <span class="at">autoscale =</span> <span class="cn">TRUE</span>),</span>
<span id="cb46-8"><a href="#cb46-8" aria-hidden="true" tabindex="-1"></a>    <span class="at">prior_aux =</span> <span class="fu">exponential</span>(<span class="at">rate =</span> <span class="dv">1</span>, <span class="at">autoscale =</span> <span class="cn">TRUE</span>),</span>
<span id="cb46-9"><a href="#cb46-9" aria-hidden="true" tabindex="-1"></a>    <span class="at">seed =</span> <span class="dv">853</span></span>
<span id="cb46-10"><a href="#cb46-10" aria-hidden="true" tabindex="-1"></a>  )</span>
<span id="cb46-11"><a href="#cb46-11" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb46-12"><a href="#cb46-12" aria-hidden="true" tabindex="-1"></a><span class="fu">saveRDS</span>(</span>
<span id="cb46-13"><a href="#cb46-13" aria-hidden="true" tabindex="-1"></a>  rdd_example,</span>
<span id="cb46-14"><a href="#cb46-14" aria-hidden="true" tabindex="-1"></a>  <span class="at">file =</span> <span class="st">"rdd_example.rds"</span></span>
<span id="cb46-15"><a href="#cb46-15" aria-hidden="true" tabindex="-1"></a>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div class="cell">
<div class="sourceCode cell-code" id="cb47"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb47-1"><a href="#cb47-1" aria-hidden="true" tabindex="-1"></a>rdd_carpenter_dobkin <span class="ot">&lt;-</span></span>
<span id="cb47-2"><a href="#cb47-2" aria-hidden="true" tabindex="-1"></a>  <span class="fu">readRDS</span>(<span class="at">file =</span> <span class="st">"rdd_carpenter_dobkin.rds"</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div class="cell">
<div class="sourceCode cell-code" id="cb48"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb48-1"><a href="#cb48-1" aria-hidden="true" tabindex="-1"></a><span class="fu">modelsummary</span>(</span>
<span id="cb48-2"><a href="#cb48-2" aria-hidden="true" tabindex="-1"></a>  <span class="at">models =</span> rdd_carpenter_dobkin,</span>
<span id="cb48-3"><a href="#cb48-3" aria-hidden="true" tabindex="-1"></a>  <span class="at">fmt =</span> <span class="dv">2</span></span>
<span id="cb48-4"><a href="#cb48-4" aria-hidden="true" tabindex="-1"></a>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div id="tbl-rddcarpenterdobkin" class="cell quarto-float anchored">
<figure class="quarto-float quarto-float-tbl figure">
<figcaption class="quarto-float-caption-top quarto-float-caption quarto-float-tbl" id="tbl-rddcarpenterdobkin-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
Table&nbsp;15.6: Examining the effect of alcohol on crime in California
</figcaption>
<div aria-describedby="tbl-rddcarpenterdobkin-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
<div class="cell-output-display">
<!-- preamble start -->

    <script>
      function styleCell_mg46vw30nhclccnt1vts(i, j, css_id) {
        var table = document.getElementById("tinytable_mg46vw30nhclccnt1vts");
        table.rows[i].cells[j].classList.add(css_id);
      }
      function insertSpanRow(i, colspan, content) {
        var table = document.getElementById('tinytable_mg46vw30nhclccnt1vts');
        var newRow = table.insertRow(i);
        var newCell = newRow.insertCell(0);
        newCell.setAttribute("colspan", colspan);
        // newCell.innerText = content;
        // this may be unsafe, but innerText does not interpret <br>
        newCell.innerHTML = content;
      }
      function spanCell_mg46vw30nhclccnt1vts(i, j, rowspan, colspan) {
        var table = document.getElementById("tinytable_mg46vw30nhclccnt1vts");
        const targetRow = table.rows[i];
        const targetCell = targetRow.cells[j];
        for (let r = 0; r < rowspan; r++) {
          // Only start deleting cells to the right for the first row (r == 0)
          if (r === 0) {
            // Delete cells to the right of the target cell in the first row
            for (let c = colspan - 1; c > 0; c--) {
              if (table.rows[i + r].cells[j + c]) {
                table.rows[i + r].deleteCell(j + c);
              }
            }
          }
          // For rows below the first, delete starting from the target column
          if (r > 0) {
            for (let c = colspan - 1; c >= 0; c--) {
              if (table.rows[i + r] && table.rows[i + r].cells[j]) {
                table.rows[i + r].deleteCell(j);
              }
            }
          }
        }
        // Set rowspan and colspan of the target cell
        targetCell.rowSpan = rowspan;
        targetCell.colSpan = colspan;
      }
window.addEventListener('load', function () { styleCell_mg46vw30nhclccnt1vts(0, 0, 'tinytable_css_id8k8onhj8vtyg8wltnzcn') })
window.addEventListener('load', function () { styleCell_mg46vw30nhclccnt1vts(0, 1, 'tinytable_css_idqzez85f3rw62nslt7aao') })
window.addEventListener('load', function () { styleCell_mg46vw30nhclccnt1vts(1, 0, 'tinytable_css_idttvnbinpuwkcgp84frmm') })
window.addEventListener('load', function () { styleCell_mg46vw30nhclccnt1vts(1, 1, 'tinytable_css_id0jy56vvbyg3s52d2t6e8') })
window.addEventListener('load', function () { styleCell_mg46vw30nhclccnt1vts(2, 0, 'tinytable_css_idttvnbinpuwkcgp84frmm') })
window.addEventListener('load', function () { styleCell_mg46vw30nhclccnt1vts(2, 1, 'tinytable_css_id0jy56vvbyg3s52d2t6e8') })
window.addEventListener('load', function () { styleCell_mg46vw30nhclccnt1vts(3, 0, 'tinytable_css_id5upsl0zumpu83wyuss2a') })
window.addEventListener('load', function () { styleCell_mg46vw30nhclccnt1vts(3, 1, 'tinytable_css_idf42pn3o0yx3euhq1hie1') })
window.addEventListener('load', function () { styleCell_mg46vw30nhclccnt1vts(4, 0, 'tinytable_css_idttvnbinpuwkcgp84frmm') })
window.addEventListener('load', function () { styleCell_mg46vw30nhclccnt1vts(4, 1, 'tinytable_css_id0jy56vvbyg3s52d2t6e8') })
window.addEventListener('load', function () { styleCell_mg46vw30nhclccnt1vts(5, 0, 'tinytable_css_idttvnbinpuwkcgp84frmm') })
window.addEventListener('load', function () { styleCell_mg46vw30nhclccnt1vts(5, 1, 'tinytable_css_id0jy56vvbyg3s52d2t6e8') })
window.addEventListener('load', function () { styleCell_mg46vw30nhclccnt1vts(6, 0, 'tinytable_css_idttvnbinpuwkcgp84frmm') })
window.addEventListener('load', function () { styleCell_mg46vw30nhclccnt1vts(6, 1, 'tinytable_css_id0jy56vvbyg3s52d2t6e8') })
window.addEventListener('load', function () { styleCell_mg46vw30nhclccnt1vts(7, 0, 'tinytable_css_idttvnbinpuwkcgp84frmm') })
window.addEventListener('load', function () { styleCell_mg46vw30nhclccnt1vts(7, 1, 'tinytable_css_id0jy56vvbyg3s52d2t6e8') })
window.addEventListener('load', function () { styleCell_mg46vw30nhclccnt1vts(8, 0, 'tinytable_css_idttvnbinpuwkcgp84frmm') })
window.addEventListener('load', function () { styleCell_mg46vw30nhclccnt1vts(8, 1, 'tinytable_css_id0jy56vvbyg3s52d2t6e8') })
window.addEventListener('load', function () { styleCell_mg46vw30nhclccnt1vts(9, 0, 'tinytable_css_idttvnbinpuwkcgp84frmm') })
window.addEventListener('load', function () { styleCell_mg46vw30nhclccnt1vts(9, 1, 'tinytable_css_id0jy56vvbyg3s52d2t6e8') })
window.addEventListener('load', function () { styleCell_mg46vw30nhclccnt1vts(10, 0, 'tinytable_css_idttvnbinpuwkcgp84frmm') })
window.addEventListener('load', function () { styleCell_mg46vw30nhclccnt1vts(10, 1, 'tinytable_css_id0jy56vvbyg3s52d2t6e8') })
window.addEventListener('load', function () { styleCell_mg46vw30nhclccnt1vts(11, 0, 'tinytable_css_idttvnbinpuwkcgp84frmm') })
window.addEventListener('load', function () { styleCell_mg46vw30nhclccnt1vts(11, 1, 'tinytable_css_id0jy56vvbyg3s52d2t6e8') })
window.addEventListener('load', function () { styleCell_mg46vw30nhclccnt1vts(12, 0, 'tinytable_css_idttvnbinpuwkcgp84frmm') })
window.addEventListener('load', function () { styleCell_mg46vw30nhclccnt1vts(12, 1, 'tinytable_css_id0jy56vvbyg3s52d2t6e8') })
window.addEventListener('load', function () { styleCell_mg46vw30nhclccnt1vts(13, 0, 'tinytable_css_idttvnbinpuwkcgp84frmm') })
window.addEventListener('load', function () { styleCell_mg46vw30nhclccnt1vts(13, 1, 'tinytable_css_id0jy56vvbyg3s52d2t6e8') })
    </script>

    <style>
    .table td.tinytable_css_id8k8onhj8vtyg8wltnzcn, .table th.tinytable_css_id8k8onhj8vtyg8wltnzcn {  text-align: left;  border-bottom: solid 0.1em #d3d8dc; }
    .table td.tinytable_css_idqzez85f3rw62nslt7aao, .table th.tinytable_css_idqzez85f3rw62nslt7aao {  text-align: center;  border-bottom: solid 0.1em #d3d8dc; }
    .table td.tinytable_css_idttvnbinpuwkcgp84frmm, .table th.tinytable_css_idttvnbinpuwkcgp84frmm {  text-align: left; }
    .table td.tinytable_css_id0jy56vvbyg3s52d2t6e8, .table th.tinytable_css_id0jy56vvbyg3s52d2t6e8 {  text-align: center; }
    .table td.tinytable_css_id5upsl0zumpu83wyuss2a, .table th.tinytable_css_id5upsl0zumpu83wyuss2a {  border-bottom: solid 0.05em black;  text-align: left; }
    .table td.tinytable_css_idf42pn3o0yx3euhq1hie1, .table th.tinytable_css_idf42pn3o0yx3euhq1hie1 {  border-bottom: solid 0.05em black;  text-align: center; }
    </style>
    <div class="container">
      <table class="table table-borderless" id="tinytable_mg46vw30nhclccnt1vts" style="width: auto; margin-left: auto; margin-right: auto;" data-quarto-disable-processing="true">
        <thead>
        
              <tr>
                <th scope="col"> </th>
                <th scope="col">(1)</th>
              </tr>
        </thead>
        
        <tbody>
                <tr>
                  <td>(Intercept)  </td>
                  <td>145.54   </td>
                </tr>
                <tr>
                  <td>age          </td>
                  <td>3.87     </td>
                </tr>
                <tr>
                  <td>is_21_or_more</td>
                  <td>13.24    </td>
                </tr>
                <tr>
                  <td>Num.Obs.     </td>
                  <td>1459     </td>
                </tr>
                <tr>
                  <td>R2           </td>
                  <td>0.299    </td>
                </tr>
                <tr>
                  <td>R2 Adj.      </td>
                  <td>0.297    </td>
                </tr>
                <tr>
                  <td>Log.Lik.     </td>
                  <td>-6153.757</td>
                </tr>
                <tr>
                  <td>ELPD         </td>
                  <td>-6157.3  </td>
                </tr>
                <tr>
                  <td>ELPD s.e.    </td>
                  <td>32.9     </td>
                </tr>
                <tr>
                  <td>LOOIC        </td>
                  <td>12314.6  </td>
                </tr>
                <tr>
                  <td>LOOIC s.e.   </td>
                  <td>65.7     </td>
                </tr>
                <tr>
                  <td>WAIC         </td>
                  <td>12314.6  </td>
                </tr>
                <tr>
                  <td>RMSE         </td>
                  <td>16.42    </td>
                </tr>
        </tbody>
      </table>
    </div>
<!-- hack to avoid NA insertion in last line -->
</div>
</div>
</figure>
</div>
</div>
<p>And the results are similar if we use <code>rdrobust</code>.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb49"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb49-1"><a href="#cb49-1" aria-hidden="true" tabindex="-1"></a><span class="fu">rdrobust</span>(</span>
<span id="cb49-2"><a href="#cb49-2" aria-hidden="true" tabindex="-1"></a>  <span class="at">y =</span> carpenter_dobkin_aggravated_assault_only<span class="sc">$</span>number,</span>
<span id="cb49-3"><a href="#cb49-3" aria-hidden="true" tabindex="-1"></a>  <span class="at">x =</span> carpenter_dobkin_aggravated_assault_only<span class="sc">$</span>age,</span>
<span id="cb49-4"><a href="#cb49-4" aria-hidden="true" tabindex="-1"></a>  <span class="at">c =</span> <span class="dv">21</span>,</span>
<span id="cb49-5"><a href="#cb49-5" aria-hidden="true" tabindex="-1"></a>  <span class="at">h =</span> <span class="dv">2</span>,</span>
<span id="cb49-6"><a href="#cb49-6" aria-hidden="true" tabindex="-1"></a>  <span class="at">all =</span> <span class="cn">TRUE</span></span>
<span id="cb49-7"><a href="#cb49-7" aria-hidden="true" tabindex="-1"></a>) <span class="sc">|&gt;</span></span>
<span id="cb49-8"><a href="#cb49-8" aria-hidden="true" tabindex="-1"></a>  <span class="fu">summary</span>()</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>Sharp RD estimates using local polynomial regression.

Number of Obs.                 1459
BW type                      Manual
Kernel                   Triangular
VCE method                       NN

Number of Obs.                  729          730
Eff. Number of Obs.             729          730
Order est. (p)                    1            1
Order bias  (q)                   2            2
BW est. (h)                   2.000        2.000
BW bias (b)                   2.000        2.000
rho (h/b)                     1.000        1.000
Unique Obs.                     729          730

=============================================================================
        Method     Coef. Std. Err.         z     P&gt;|z|      [ 95% C.I. ]       
=============================================================================
  Conventional    14.126     1.918     7.364     0.000    [10.366 , 17.886]    
Bias-Corrected    16.708     1.918     8.709     0.000    [12.948 , 20.468]    
        Robust    16.708     2.879     5.804     0.000    [11.066 , 22.350]    
=============================================================================</code></pre>
</div>
</div>
</section>
</section>
<section id="instrumental-variables" class="level2" data-number="15.6">
<h2 data-number="15.6" class="anchored" data-anchor-id="instrumental-variables"><span class="header-section-number">15.6</span> Instrumental variables</h2>
<p>Instrumental variables (IV) is an approach that can be handy when we have some type of treatment and control going on, but we have a lot of correlation with other variables and we possibly do not have a variable that actually measures what we are interested in. Adjusting for observables will not be enough to create a good estimate. Instead we find some variable—the eponymous instrumental variable—that is:</p>
<ol type="1">
<li>correlated with the treatment variable, but</li>
<li>not correlated with the outcome.</li>
</ol>
<p>This solves our problem because the only way the instrumental variable can have an effect is through the treatment variable, and so we can adjust our understanding of the effect of the treatment variable appropriately. The trade-off is that instrumental variables must satisfy a bunch of different assumptions, and that, frankly, they are difficult to identify <em>ex ante</em>. Nonetheless, when we are able to use them, they are a powerful tool for speaking about causality.</p>
<p>The canonical instrumental variables example is smoking. These days we know that smoking causes cancer. But because smoking is correlated with a lot of other variables, for instance, education, it could be that it was actually education that causes cancer. RCTs may be possible, but they are likely to be troublesome in terms of speed and ethics, and so instead we look for some other variable that is correlated with smoking, but not, in and of itself, with lung cancer. In this case, we look to tax rates, and other policy responses, on cigarettes. As the tax rates on cigarettes are correlated with the number of cigarettes that are smoked, but not correlated with lung cancer, other than through their impact on cigarette smoking, through them we can assess the effect of cigarettes smoked on lung cancer.</p>
<p>To implement instrumental variables we first regress tax rates on cigarette smoking to get some coefficient on the instrumental variable, and then (in a separate regression) regress tax rates on lung cancer to again, get some coefficient on the instrumental variable. Our estimate is then the ratio of these coefficients, which is described as a “Wald estimate” <span class="citation" data-cites="gelmanandhill">(<a href="99-references.html#ref-gelmanandhill" role="doc-biblioref">Gelman and Hill 2007, 219</a>)</span>.</p>
<p>Sometimes instrumental variables are used in the context of random allocation of treatment, such as the Oregon Health Insurance Experiment introduced in <a href="08-hunt.html" class="quarto-xref"><span>Chapter 8</span></a>. Recall the issue was that a lottery was used to select individuals who were allocated to apply for health insurance, but there was nothing forcing them to do this. Our approach would then be to consider the relationship between being selected and taking up health insurance, and then between various health outcomes and taking up insurance. Our instrumental variable estimate, which would be the ratio, would estimate only those that took up health insurance because they were selected.</p>
<p>Following the language of <span class="citation" data-cites="gelmanandhill">Gelman and Hill (<a href="99-references.html#ref-gelmanandhill" role="doc-biblioref">2007, 216</a>)</span>, when we use instrumental variables we make a variety of assumptions including:</p>
<ul>
<li>Ignorability of the instrument.</li>
<li>Correlation between the instrumental variable and the treatment variable.</li>
<li>Monotonicity.</li>
<li>Exclusion restriction.</li>
</ul>
<p>As an aside, the history of instrumental variables is intriguing, and <span class="citation" data-cites="stock2003retrospectives">Stock and Trebbi (<a href="99-references.html#ref-stock2003retrospectives" role="doc-biblioref">2003</a>)</span>, via <span class="citation" data-cites="Cunningham2021">Cunningham (<a href="99-references.html#ref-Cunningham2021" role="doc-biblioref">2021</a>)</span>, provide a brief overview. The method was first published in <span class="citation" data-cites="wright1928tariff">Wright (<a href="99-references.html#ref-wright1928tariff" role="doc-biblioref">1928</a>)</span>. This is a book about the effect of tariffs on animal and vegetable oil. Why might instrumental variables be important in a book about tariffs on animal and vegetable oil? The fundamental problem is that the effect of tariffs depends on both supply and demand. But we only know prices and quantities, so we do not know what is driving the effect. We can use instrumental variables to pin down causality. The intriguing aspect is that the instrumental variables discussion is only in “Appendix B” of that book. It would seem odd to relegate a major statistical break through to an appendix. Further, Philip G. Wright, the book’s author, had a son Sewall Wright, who had considerable expertise in statistics and the specific method used in “Appendix B”. Hence the mystery of “Appendix B”: did Philip or Sewall write it? <span class="citation" data-cites="Cunningham2021">Cunningham (<a href="99-references.html#ref-Cunningham2021" role="doc-biblioref">2021</a>)</span>, <span class="citation" data-cites="stock2003retrospectives">Stock and Trebbi (<a href="99-references.html#ref-stock2003retrospectives" role="doc-biblioref">2003</a>)</span>, and <span class="citation" data-cites="angristkrueger">Angrist and Krueger (<a href="99-references.html#ref-angristkrueger" role="doc-biblioref">2001</a>)</span> all go into more detail, but on balance feel that it is likely that Philip authored the work.</p>
<section id="simulated-example-health-status-smoking-and-tax-rates" class="level3" data-number="15.6.1">
<h3 data-number="15.6.1" class="anchored" data-anchor-id="simulated-example-health-status-smoking-and-tax-rates"><span class="header-section-number">15.6.1</span> Simulated example: health status, smoking, and tax rates</h3>
<p>Let us generate some data. We will explore a simulation related to the canonical example of health status, smoking, and tax rates. We are looking to explain how healthy someone is based on the amount they smoke, via the tax rate on smoking. We are going to generate different tax rates by provinces. The tax rate on cigarettes is now similar across the Canadian provinces but that this is fairly recent. Let us assume Alberta had a low tax, and Nova Scotia had a high tax.</p>
<p>We are simulating data for illustrative purposes, so we need to impose the answer that we want. When you actually use instrumental variables you will be reversing the process.</p>
<div class="cell" data-warnings="false">
<div class="sourceCode cell-code" id="cb51"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb51-1"><a href="#cb51-1" aria-hidden="true" tabindex="-1"></a><span class="fu">set.seed</span>(<span class="dv">853</span>)</span>
<span id="cb51-2"><a href="#cb51-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb51-3"><a href="#cb51-3" aria-hidden="true" tabindex="-1"></a>num_observations <span class="ot">&lt;-</span> <span class="dv">10000</span></span>
<span id="cb51-4"><a href="#cb51-4" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb51-5"><a href="#cb51-5" aria-hidden="true" tabindex="-1"></a>iv_example_data <span class="ot">&lt;-</span> <span class="fu">tibble</span>(</span>
<span id="cb51-6"><a href="#cb51-6" aria-hidden="true" tabindex="-1"></a>  <span class="at">person =</span> <span class="fu">c</span>(<span class="dv">1</span><span class="sc">:</span>num_observations),</span>
<span id="cb51-7"><a href="#cb51-7" aria-hidden="true" tabindex="-1"></a>  <span class="at">smoker =</span> </span>
<span id="cb51-8"><a href="#cb51-8" aria-hidden="true" tabindex="-1"></a>    <span class="fu">sample</span>(<span class="at">x =</span> <span class="fu">c</span>(<span class="dv">0</span><span class="sc">:</span><span class="dv">1</span>), <span class="at">size =</span> num_observations, <span class="at">replace =</span> <span class="cn">TRUE</span>)</span>
<span id="cb51-9"><a href="#cb51-9" aria-hidden="true" tabindex="-1"></a>  )</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>Now we need to relate the number of cigarettes that someone smoked to their health. We will model health status as a draw from the Normal distribution, with either a high or low mean depending on whether the person smokes.</p>
<div class="cell" data-warnings="false">
<div class="sourceCode cell-code" id="cb52"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb52-1"><a href="#cb52-1" aria-hidden="true" tabindex="-1"></a>iv_example_data <span class="ot">&lt;-</span></span>
<span id="cb52-2"><a href="#cb52-2" aria-hidden="true" tabindex="-1"></a>  iv_example_data <span class="sc">|&gt;</span></span>
<span id="cb52-3"><a href="#cb52-3" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(<span class="at">health =</span> <span class="fu">if_else</span>(</span>
<span id="cb52-4"><a href="#cb52-4" aria-hidden="true" tabindex="-1"></a>    smoker <span class="sc">==</span> <span class="dv">0</span>,</span>
<span id="cb52-5"><a href="#cb52-5" aria-hidden="true" tabindex="-1"></a>    <span class="fu">rnorm</span>(<span class="at">n =</span> <span class="fu">n</span>(), <span class="at">mean =</span> <span class="dv">1</span>, <span class="at">sd =</span> <span class="dv">1</span>),</span>
<span id="cb52-6"><a href="#cb52-6" aria-hidden="true" tabindex="-1"></a>    <span class="fu">rnorm</span>(<span class="at">n =</span> <span class="fu">n</span>(), <span class="at">mean =</span> <span class="dv">0</span>, <span class="at">sd =</span> <span class="dv">1</span>)</span>
<span id="cb52-7"><a href="#cb52-7" aria-hidden="true" tabindex="-1"></a>  ))</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>Now we need a relationship between cigarettes and the province (because in this illustration, the provinces have different tax rates).</p>
<div class="cell" data-warnings="false">
<div class="sourceCode cell-code" id="cb53"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb53-1"><a href="#cb53-1" aria-hidden="true" tabindex="-1"></a>iv_example_data <span class="ot">&lt;-</span> iv_example_data <span class="sc">|&gt;</span></span>
<span id="cb53-2"><a href="#cb53-2" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(</span>
<span id="cb53-3"><a href="#cb53-3" aria-hidden="true" tabindex="-1"></a>    <span class="at">province =</span> <span class="fu">case_when</span>(</span>
<span id="cb53-4"><a href="#cb53-4" aria-hidden="true" tabindex="-1"></a>      smoker <span class="sc">==</span> <span class="dv">0</span> <span class="sc">~</span> <span class="fu">sample</span>(</span>
<span id="cb53-5"><a href="#cb53-5" aria-hidden="true" tabindex="-1"></a>        <span class="fu">c</span>(<span class="st">"Nova Scotia"</span>, <span class="st">"Alberta"</span>),</span>
<span id="cb53-6"><a href="#cb53-6" aria-hidden="true" tabindex="-1"></a>        <span class="at">size =</span> <span class="fu">n</span>(),</span>
<span id="cb53-7"><a href="#cb53-7" aria-hidden="true" tabindex="-1"></a>        <span class="at">replace =</span> <span class="cn">TRUE</span>,</span>
<span id="cb53-8"><a href="#cb53-8" aria-hidden="true" tabindex="-1"></a>        <span class="at">prob =</span> <span class="fu">c</span>(<span class="dv">1</span><span class="sc">/</span><span class="dv">2</span>, <span class="dv">1</span><span class="sc">/</span><span class="dv">2</span>)</span>
<span id="cb53-9"><a href="#cb53-9" aria-hidden="true" tabindex="-1"></a>      ),</span>
<span id="cb53-10"><a href="#cb53-10" aria-hidden="true" tabindex="-1"></a>      smoker <span class="sc">==</span> <span class="dv">1</span> <span class="sc">~</span> <span class="fu">sample</span>(</span>
<span id="cb53-11"><a href="#cb53-11" aria-hidden="true" tabindex="-1"></a>        <span class="fu">c</span>(<span class="st">"Nova Scotia"</span>, <span class="st">"Alberta"</span>),</span>
<span id="cb53-12"><a href="#cb53-12" aria-hidden="true" tabindex="-1"></a>        <span class="at">size =</span> <span class="fu">n</span>(),</span>
<span id="cb53-13"><a href="#cb53-13" aria-hidden="true" tabindex="-1"></a>        <span class="at">replace =</span> <span class="cn">TRUE</span>,</span>
<span id="cb53-14"><a href="#cb53-14" aria-hidden="true" tabindex="-1"></a>        <span class="at">prob =</span> <span class="fu">c</span>(<span class="dv">1</span><span class="sc">/</span><span class="dv">4</span>, <span class="dv">3</span><span class="sc">/</span><span class="dv">4</span>)</span>
<span id="cb53-15"><a href="#cb53-15" aria-hidden="true" tabindex="-1"></a>      )</span>
<span id="cb53-16"><a href="#cb53-16" aria-hidden="true" tabindex="-1"></a>    ),</span>
<span id="cb53-17"><a href="#cb53-17" aria-hidden="true" tabindex="-1"></a>    <span class="at">tax =</span> <span class="fu">case_when</span>(province <span class="sc">==</span> <span class="st">"Alberta"</span> <span class="sc">~</span> <span class="fl">0.3</span>, </span>
<span id="cb53-18"><a href="#cb53-18" aria-hidden="true" tabindex="-1"></a>                    province <span class="sc">==</span> <span class="st">"Nova Scotia"</span> <span class="sc">~</span> <span class="fl">0.5</span>,</span>
<span id="cb53-19"><a href="#cb53-19" aria-hidden="true" tabindex="-1"></a>                    <span class="cn">TRUE</span> <span class="sc">~</span> <span class="dv">9999999</span></span>
<span id="cb53-20"><a href="#cb53-20" aria-hidden="true" tabindex="-1"></a>                    )</span>
<span id="cb53-21"><a href="#cb53-21" aria-hidden="true" tabindex="-1"></a>    )</span>
<span id="cb53-22"><a href="#cb53-22" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb53-23"><a href="#cb53-23" aria-hidden="true" tabindex="-1"></a>iv_example_data</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code># A tibble: 10,000 × 5
   person smoker  health province      tax
    &lt;int&gt;  &lt;int&gt;   &lt;dbl&gt; &lt;chr&gt;       &lt;dbl&gt;
 1      1      0  1.11   Alberta       0.3
 2      2      1 -0.0831 Alberta       0.3
 3      3      1 -0.0363 Alberta       0.3
 4      4      0  2.48   Alberta       0.3
 5      5      0  0.617  Nova Scotia   0.5
 6      6      0  0.748  Alberta       0.3
 7      7      0  0.499  Alberta       0.3
 8      8      0  1.05   Nova Scotia   0.5
 9      9      1  0.113  Alberta       0.3
10     10      1 -0.0105 Alberta       0.3
# ℹ 9,990 more rows</code></pre>
</div>
</div>
<p>Now we can look at our data.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb55"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb55-1"><a href="#cb55-1" aria-hidden="true" tabindex="-1"></a>iv_example_data <span class="sc">|&gt;</span></span>
<span id="cb55-2"><a href="#cb55-2" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(<span class="at">smoker =</span> <span class="fu">as_factor</span>(smoker)) <span class="sc">|&gt;</span></span>
<span id="cb55-3"><a href="#cb55-3" aria-hidden="true" tabindex="-1"></a>  <span class="fu">ggplot</span>(<span class="fu">aes</span>(<span class="at">x =</span> health, <span class="at">fill =</span> smoker)) <span class="sc">+</span></span>
<span id="cb55-4"><a href="#cb55-4" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_histogram</span>(<span class="at">position =</span> <span class="st">"dodge"</span>, <span class="at">binwidth =</span> <span class="fl">0.2</span>) <span class="sc">+</span></span>
<span id="cb55-5"><a href="#cb55-5" aria-hidden="true" tabindex="-1"></a>  <span class="fu">theme_minimal</span>() <span class="sc">+</span></span>
<span id="cb55-6"><a href="#cb55-6" aria-hidden="true" tabindex="-1"></a>  <span class="fu">labs</span>(</span>
<span id="cb55-7"><a href="#cb55-7" aria-hidden="true" tabindex="-1"></a>    <span class="at">x =</span> <span class="st">"Health rating"</span>,</span>
<span id="cb55-8"><a href="#cb55-8" aria-hidden="true" tabindex="-1"></a>    <span class="at">y =</span> <span class="st">"Number of people"</span>,</span>
<span id="cb55-9"><a href="#cb55-9" aria-hidden="true" tabindex="-1"></a>    <span class="at">fill =</span> <span class="st">"Smoker"</span></span>
<span id="cb55-10"><a href="#cb55-10" aria-hidden="true" tabindex="-1"></a>  ) <span class="sc">+</span></span>
<span id="cb55-11"><a href="#cb55-11" aria-hidden="true" tabindex="-1"></a>  <span class="fu">scale_fill_brewer</span>(<span class="at">palette =</span> <span class="st">"Set1"</span>) <span class="sc">+</span></span>
<span id="cb55-12"><a href="#cb55-12" aria-hidden="true" tabindex="-1"></a>  <span class="fu">facet_wrap</span>(<span class="fu">vars</span>(province))</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">
<div>
<figure class="figure">
<p><img src="14-causality_from_obs_files/figure-html/unnamed-chunk-52-1.png" class="img-fluid figure-img" width="672"></p>
</figure>
</div>
</div>
</div>
<p>Finally, we can use the tax rate as an instrumental variable to estimate the effect of smoking on health.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb56"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb56-1"><a href="#cb56-1" aria-hidden="true" tabindex="-1"></a>health_on_tax <span class="ot">&lt;-</span> <span class="fu">lm</span>(health <span class="sc">~</span> tax, <span class="at">data =</span> iv_example_data)</span>
<span id="cb56-2"><a href="#cb56-2" aria-hidden="true" tabindex="-1"></a>smoker_on_tax <span class="ot">&lt;-</span> <span class="fu">lm</span>(smoker <span class="sc">~</span> tax, <span class="at">data =</span> iv_example_data)</span>
<span id="cb56-3"><a href="#cb56-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb56-4"><a href="#cb56-4" aria-hidden="true" tabindex="-1"></a><span class="fu">tibble</span>(</span>
<span id="cb56-5"><a href="#cb56-5" aria-hidden="true" tabindex="-1"></a>  <span class="at">coefficient =</span> <span class="fu">c</span>(<span class="st">"health ~ tax"</span>, <span class="st">"smoker ~ tax"</span>, <span class="st">"ratio"</span>),</span>
<span id="cb56-6"><a href="#cb56-6" aria-hidden="true" tabindex="-1"></a>  <span class="at">value =</span> <span class="fu">c</span>(</span>
<span id="cb56-7"><a href="#cb56-7" aria-hidden="true" tabindex="-1"></a>    <span class="fu">coef</span>(health_on_tax)[<span class="st">"tax"</span>],</span>
<span id="cb56-8"><a href="#cb56-8" aria-hidden="true" tabindex="-1"></a>    <span class="fu">coef</span>(smoker_on_tax)[<span class="st">"tax"</span>],</span>
<span id="cb56-9"><a href="#cb56-9" aria-hidden="true" tabindex="-1"></a>    <span class="fu">coef</span>(health_on_tax)[<span class="st">"tax"</span>] <span class="sc">/</span> <span class="fu">coef</span>(smoker_on_tax)[<span class="st">"tax"</span>]</span>
<span id="cb56-10"><a href="#cb56-10" aria-hidden="true" tabindex="-1"></a>  )</span>
<span id="cb56-11"><a href="#cb56-11" aria-hidden="true" tabindex="-1"></a>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code># A tibble: 3 × 2
  coefficient   value
  &lt;chr&gt;         &lt;dbl&gt;
1 health ~ tax  1.24 
2 smoker ~ tax -1.27 
3 ratio        -0.980</code></pre>
</div>
</div>
<p>By understanding the effect of tax rates on both smoking and health, we find that if you smoke then your health is likely to be worse than if you do not smoke.</p>
<p>We can use <code>iv_robust()</code> from <code>estimatr</code> to estimate IV (<a href="#tbl-ivexamplesmoker" class="quarto-xref">Table&nbsp;<span>15.7</span></a>). One nice reason for doing this is that it can help to keep everything organized and adjust the standard errors.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb58"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb58-1"><a href="#cb58-1" aria-hidden="true" tabindex="-1"></a><span class="fu">iv_robust</span>(health <span class="sc">~</span> smoker <span class="sc">|</span> tax, <span class="at">data =</span> iv_example_data) <span class="sc">|&gt;</span></span>
<span id="cb58-2"><a href="#cb58-2" aria-hidden="true" tabindex="-1"></a>  <span class="fu">modelsummary</span>()</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div id="tbl-ivexamplesmoker" class="cell quarto-float anchored">
<figure class="quarto-float quarto-float-tbl figure">
<figcaption class="quarto-float-caption-top quarto-float-caption quarto-float-tbl" id="tbl-ivexamplesmoker-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
Table&nbsp;15.7: Instrumental variable example using simulated data
</figcaption>
<div aria-describedby="tbl-ivexamplesmoker-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
<div class="cell-output-display">
<!-- preamble start -->

    <script>
      function styleCell_98mu5byckj10zc30im06(i, j, css_id) {
        var table = document.getElementById("tinytable_98mu5byckj10zc30im06");
        table.rows[i].cells[j].classList.add(css_id);
      }
      function insertSpanRow(i, colspan, content) {
        var table = document.getElementById('tinytable_98mu5byckj10zc30im06');
        var newRow = table.insertRow(i);
        var newCell = newRow.insertCell(0);
        newCell.setAttribute("colspan", colspan);
        // newCell.innerText = content;
        // this may be unsafe, but innerText does not interpret <br>
        newCell.innerHTML = content;
      }
      function spanCell_98mu5byckj10zc30im06(i, j, rowspan, colspan) {
        var table = document.getElementById("tinytable_98mu5byckj10zc30im06");
        const targetRow = table.rows[i];
        const targetCell = targetRow.cells[j];
        for (let r = 0; r < rowspan; r++) {
          // Only start deleting cells to the right for the first row (r == 0)
          if (r === 0) {
            // Delete cells to the right of the target cell in the first row
            for (let c = colspan - 1; c > 0; c--) {
              if (table.rows[i + r].cells[j + c]) {
                table.rows[i + r].deleteCell(j + c);
              }
            }
          }
          // For rows below the first, delete starting from the target column
          if (r > 0) {
            for (let c = colspan - 1; c >= 0; c--) {
              if (table.rows[i + r] && table.rows[i + r].cells[j]) {
                table.rows[i + r].deleteCell(j);
              }
            }
          }
        }
        // Set rowspan and colspan of the target cell
        targetCell.rowSpan = rowspan;
        targetCell.colSpan = colspan;
      }
window.addEventListener('load', function () { styleCell_98mu5byckj10zc30im06(0, 0, 'tinytable_css_idpm5ivsc8zd6wpwupvlpz') })
window.addEventListener('load', function () { styleCell_98mu5byckj10zc30im06(0, 1, 'tinytable_css_id8f8uakrut4mqrz8ilcr5') })
window.addEventListener('load', function () { styleCell_98mu5byckj10zc30im06(1, 0, 'tinytable_css_id6rqeh8uo4y1nuwq4cs5g') })
window.addEventListener('load', function () { styleCell_98mu5byckj10zc30im06(1, 1, 'tinytable_css_id6eylm3qi5ccxkzx245fd') })
window.addEventListener('load', function () { styleCell_98mu5byckj10zc30im06(2, 0, 'tinytable_css_id6rqeh8uo4y1nuwq4cs5g') })
window.addEventListener('load', function () { styleCell_98mu5byckj10zc30im06(2, 1, 'tinytable_css_id6eylm3qi5ccxkzx245fd') })
window.addEventListener('load', function () { styleCell_98mu5byckj10zc30im06(3, 0, 'tinytable_css_id6rqeh8uo4y1nuwq4cs5g') })
window.addEventListener('load', function () { styleCell_98mu5byckj10zc30im06(3, 1, 'tinytable_css_id6eylm3qi5ccxkzx245fd') })
window.addEventListener('load', function () { styleCell_98mu5byckj10zc30im06(4, 0, 'tinytable_css_idta9d37sya9l2u99popsh') })
window.addEventListener('load', function () { styleCell_98mu5byckj10zc30im06(4, 1, 'tinytable_css_idlx7dcjfs3hola9e4xvdh') })
window.addEventListener('load', function () { styleCell_98mu5byckj10zc30im06(5, 0, 'tinytable_css_id6rqeh8uo4y1nuwq4cs5g') })
window.addEventListener('load', function () { styleCell_98mu5byckj10zc30im06(5, 1, 'tinytable_css_id6eylm3qi5ccxkzx245fd') })
window.addEventListener('load', function () { styleCell_98mu5byckj10zc30im06(6, 0, 'tinytable_css_id6rqeh8uo4y1nuwq4cs5g') })
window.addEventListener('load', function () { styleCell_98mu5byckj10zc30im06(6, 1, 'tinytable_css_id6eylm3qi5ccxkzx245fd') })
window.addEventListener('load', function () { styleCell_98mu5byckj10zc30im06(7, 0, 'tinytable_css_id6rqeh8uo4y1nuwq4cs5g') })
window.addEventListener('load', function () { styleCell_98mu5byckj10zc30im06(7, 1, 'tinytable_css_id6eylm3qi5ccxkzx245fd') })
window.addEventListener('load', function () { styleCell_98mu5byckj10zc30im06(8, 0, 'tinytable_css_id6rqeh8uo4y1nuwq4cs5g') })
window.addEventListener('load', function () { styleCell_98mu5byckj10zc30im06(8, 1, 'tinytable_css_id6eylm3qi5ccxkzx245fd') })
window.addEventListener('load', function () { styleCell_98mu5byckj10zc30im06(9, 0, 'tinytable_css_id6rqeh8uo4y1nuwq4cs5g') })
window.addEventListener('load', function () { styleCell_98mu5byckj10zc30im06(9, 1, 'tinytable_css_id6eylm3qi5ccxkzx245fd') })
window.addEventListener('load', function () { styleCell_98mu5byckj10zc30im06(10, 0, 'tinytable_css_id6rqeh8uo4y1nuwq4cs5g') })
window.addEventListener('load', function () { styleCell_98mu5byckj10zc30im06(10, 1, 'tinytable_css_id6eylm3qi5ccxkzx245fd') })
    </script>

    <style>
    .table td.tinytable_css_idpm5ivsc8zd6wpwupvlpz, .table th.tinytable_css_idpm5ivsc8zd6wpwupvlpz {  text-align: left;  border-bottom: solid 0.1em #d3d8dc; }
    .table td.tinytable_css_id8f8uakrut4mqrz8ilcr5, .table th.tinytable_css_id8f8uakrut4mqrz8ilcr5 {  text-align: center;  border-bottom: solid 0.1em #d3d8dc; }
    .table td.tinytable_css_id6rqeh8uo4y1nuwq4cs5g, .table th.tinytable_css_id6rqeh8uo4y1nuwq4cs5g {  text-align: left; }
    .table td.tinytable_css_id6eylm3qi5ccxkzx245fd, .table th.tinytable_css_id6eylm3qi5ccxkzx245fd {  text-align: center; }
    .table td.tinytable_css_idta9d37sya9l2u99popsh, .table th.tinytable_css_idta9d37sya9l2u99popsh {  border-bottom: solid 0.05em black;  text-align: left; }
    .table td.tinytable_css_idlx7dcjfs3hola9e4xvdh, .table th.tinytable_css_idlx7dcjfs3hola9e4xvdh {  border-bottom: solid 0.05em black;  text-align: center; }
    </style>
    <div class="container">
      <table class="table table-borderless" id="tinytable_98mu5byckj10zc30im06" style="width: auto; margin-left: auto; margin-right: auto;" data-quarto-disable-processing="true">
        <thead>
        
              <tr>
                <th scope="col"> </th>
                <th scope="col">(1)</th>
              </tr>
        </thead>
        
        <tbody>
                <tr>
                  <td>(Intercept)</td>
                  <td>0.977  </td>
                </tr>
                <tr>
                  <td>           </td>
                  <td>(0.041)</td>
                </tr>
                <tr>
                  <td>smoker     </td>
                  <td>-0.980 </td>
                </tr>
                <tr>
                  <td>           </td>
                  <td>(0.081)</td>
                </tr>
                <tr>
                  <td>Num.Obs.   </td>
                  <td>10000  </td>
                </tr>
                <tr>
                  <td>R2         </td>
                  <td>0.201  </td>
                </tr>
                <tr>
                  <td>R2 Adj.    </td>
                  <td>0.201  </td>
                </tr>
                <tr>
                  <td>AIC        </td>
                  <td>28342.1</td>
                </tr>
                <tr>
                  <td>BIC        </td>
                  <td>28363.7</td>
                </tr>
                <tr>
                  <td>RMSE       </td>
                  <td>1.00   </td>
                </tr>
        </tbody>
      </table>
    </div>
<!-- hack to avoid NA insertion in last line -->
</div>
</div>
</figure>
</div>
</div>
</section>
<section id="assumptions-2" class="level3" data-number="15.6.2">
<h3 data-number="15.6.2" class="anchored" data-anchor-id="assumptions-2"><span class="header-section-number">15.6.2</span> Assumptions</h3>
<p>The set-up of instrumental variables is described in <a href="#fig-dot-taxrebateasiv-quarto" class="quarto-xref">Figure&nbsp;<span>15.9</span></a>, which shows education as a confounder between income and happiness. A tax rebate likely only affects income, not education, and could be used as an instrumental variable.</p>
<div class="cell" data-fig-width="4" data-layout-align="default">
<div class="sourceCode cell-code" id="cb59"><pre class="sourceCode dot code-with-copy"><code class="sourceCode dot"><span id="cb59-1"><a href="#cb59-1" aria-hidden="true" tabindex="-1"></a><span class="kw">digraph</span> <span class="va">D</span> <span class="ot">{</span></span>
<span id="cb59-2"><a href="#cb59-2" aria-hidden="true" tabindex="-1"></a><span class="co">  </span></span>
<span id="cb59-3"><a href="#cb59-3" aria-hidden="true" tabindex="-1"></a><span class="co">  </span><span class="kw">node</span><span class="co"> </span><span class="ot">[</span><span class="at">shape</span><span class="ot">=</span><span class="va">plaintext</span><span class="co">, </span><span class="at">fontname</span><span class="co"> </span><span class="ot">=</span><span class="co"> </span><span class="st">"helvetica"</span><span class="ot">];</span></span>
<span id="cb59-4"><a href="#cb59-4" aria-hidden="true" tabindex="-1"></a><span class="co">  </span><span class="va">a</span><span class="co"> </span><span class="ot">[</span><span class="at">label</span><span class="co"> </span><span class="ot">=</span><span class="co"> </span><span class="st">"Income"</span><span class="ot">]</span></span>
<span id="cb59-5"><a href="#cb59-5" aria-hidden="true" tabindex="-1"></a><span class="co">  </span><span class="va">b</span><span class="co"> </span><span class="ot">[</span><span class="at">label</span><span class="co"> </span><span class="ot">=</span><span class="co"> </span><span class="st">"Happiness"</span><span class="ot">]</span></span>
<span id="cb59-6"><a href="#cb59-6" aria-hidden="true" tabindex="-1"></a><span class="co">  </span><span class="va">c</span><span class="co"> </span><span class="ot">[</span><span class="at">label</span><span class="co"> </span><span class="ot">=</span><span class="co"> </span><span class="st">"Education"</span><span class="ot">]</span></span>
<span id="cb59-7"><a href="#cb59-7" aria-hidden="true" tabindex="-1"></a><span class="co">  </span><span class="va">d</span><span class="co"> </span><span class="ot">[</span><span class="at">label</span><span class="co"> </span><span class="ot">=</span><span class="co"> </span><span class="st">"Tax rebate"</span><span class="ot">]</span></span>
<span id="cb59-8"><a href="#cb59-8" aria-hidden="true" tabindex="-1"></a><span class="co">  </span><span class="ot">{</span><span class="co"> </span><span class="at">rank</span><span class="ot">=</span><span class="va">same</span><span class="co"> </span><span class="va">a</span><span class="co"> </span><span class="va">b</span><span class="ot">};</span></span>
<span id="cb59-9"><a href="#cb59-9" aria-hidden="true" tabindex="-1"></a><span class="co">  </span></span>
<span id="cb59-10"><a href="#cb59-10" aria-hidden="true" tabindex="-1"></a><span class="co">  </span><span class="va">a</span><span class="ot">-&gt;</span><span class="va">b</span></span>
<span id="cb59-11"><a href="#cb59-11" aria-hidden="true" tabindex="-1"></a><span class="co">  </span><span class="va">c</span><span class="ot">-&gt;</span><span class="va">a</span></span>
<span id="cb59-12"><a href="#cb59-12" aria-hidden="true" tabindex="-1"></a><span class="co">  </span><span class="va">c</span><span class="ot">-&gt;</span><span class="va">b</span></span>
<span id="cb59-13"><a href="#cb59-13" aria-hidden="true" tabindex="-1"></a><span class="co">  </span><span class="va">d</span><span class="ot">-&gt;</span><span class="va">a</span></span>
<span id="cb59-14"><a href="#cb59-14" aria-hidden="true" tabindex="-1"></a><span class="ot">}</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">
<div id="fig-dot-taxrebateasiv-quarto" class="quarto-figure quarto-figure-center quarto-float anchored">
<figure class="quarto-float quarto-float-fig figure">
<div aria-describedby="fig-dot-taxrebateasiv-quarto-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
<div>
<svg width="384" height="480" viewbox="0.00 0.00 189.54 116.00" xmlns="http://www.w3.org/2000/svg" xlink="http://www.w3.org/1999/xlink" style="; max-width: none; max-height: none">
<g id="graph0" class="graph" transform="scale(1 1) rotate(0) translate(4 112)">
<title>D</title>
<polygon fill="white" stroke="transparent" points="-4,4 -4,-112 185.54,-112 185.54,4 -4,4"></polygon>
<!-- a -->
<g id="node1" class="node">
<title>a</title>
<text text-anchor="middle" x="50.46" y="-13.8" font-family="Helvetica,sans-Serif" font-size="14.00">Income</text>
</g>
<!-- b -->
<g id="node2" class="node">
<title>b</title>
<text text-anchor="middle" x="140.46" y="-13.8" font-family="Helvetica,sans-Serif" font-size="14.00">Happiness</text>
</g>
<!-- a&#45;&gt;b -->
<g id="edge1" class="edge">
<title>a-&gt;b</title>
<path fill="none" stroke="black" d="M81.4,-18C83.87,-18 86.33,-18 88.8,-18"></path>
<polygon fill="black" stroke="black" points="88.93,-21.5 98.93,-18 88.93,-14.5 88.93,-21.5"></polygon>
</g>
<!-- c -->
<g id="node3" class="node">
<title>c</title>
<text text-anchor="middle" x="140.46" y="-85.8" font-family="Helvetica,sans-Serif" font-size="14.00">Education</text>
</g>
<!-- c&#45;&gt;a -->
<g id="edge2" class="edge">
<title>c-&gt;a</title>
<path fill="none" stroke="black" d="M118.21,-71.7C106.88,-62.88 92.93,-52.03 80.64,-42.47"></path>
<polygon fill="black" stroke="black" points="82.5,-39.48 72.45,-36.1 78.2,-45.01 82.5,-39.48"></polygon>
</g>
<!-- c&#45;&gt;b -->
<g id="edge3" class="edge">
<title>c-&gt;b</title>
<path fill="none" stroke="black" d="M140.46,-71.7C140.46,-63.98 140.46,-54.71 140.46,-46.11"></path>
<polygon fill="black" stroke="black" points="143.96,-46.1 140.46,-36.1 136.96,-46.1 143.96,-46.1"></polygon>
</g>
<!-- d -->
<g id="node4" class="node">
<title>d</title>
<text text-anchor="middle" x="41.46" y="-85.8" font-family="Helvetica,sans-Serif" font-size="14.00">Tax rebate</text>
</g>
<!-- d&#45;&gt;a -->
<g id="edge4" class="edge">
<title>d-&gt;a</title>
<path fill="none" stroke="black" d="M43.69,-71.7C44.68,-63.98 45.87,-54.71 46.98,-46.11"></path>
<polygon fill="black" stroke="black" points="50.46,-46.47 48.26,-36.1 43.52,-45.58 50.46,-46.47"></polygon>
</g>
</g>
</svg>
</div>
</div>
<figcaption class="quarto-float-caption-bottom quarto-float-caption quarto-float-fig" id="fig-dot-taxrebateasiv-quarto-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
Figure&nbsp;15.9: Education as a confounder for the relationship between income and happiness with tax rebate as an instrumental variable
</figcaption>
</figure>
</div>
</div>
</div>
<p>As discussed earlier, there are a variety of assumptions that are made when using instrumental variables. The two most important are:</p>
<ol type="1">
<li>Exclusion Restriction. This assumption is that the instrumental variable only affects the outcome variable through the predictor variable of interest.</li>
<li>Relevance. There must actually be a relationship between the instrumental variable and the predictor variable.</li>
</ol>
<p>There is typically a trade-off between these two. There are plenty of variables that satisfy one, precisely because they do not satisfy the other. <span class="citation" data-cites="Cunningham2021">Cunningham (<a href="99-references.html#ref-Cunningham2021" role="doc-biblioref">2021, 211</a>)</span> describes how one test of a good instrument is if people are initially confused before you explain it to them, only to think it obvious in hindsight.</p>
<p>Relevance can be tested using regression and other tests for correlation. The exclusion restriction cannot be tested. We need to present evidence and convincing arguments. The difficult aspect is that the instrument needs to seem irrelevant because that is the implication of the exclusion restriction <span class="citation" data-cites="Cunningham2021">(<a href="99-references.html#ref-Cunningham2021" role="doc-biblioref">Cunningham 2021, 225</a>)</span>.</p>
<p>Instrumental variables is a useful approach because one can obtain causal estimates even without explicit randomization. Finding instrumental variables used to be a bit of a white whale, especially in academia. But there has been increased use of IV approaches downstream of A/B tests <span class="citation" data-cites="taddy2019">(<a href="99-references.html#ref-taddy2019" role="doc-biblioref">Taddy 2019, 162</a>)</span>.</p>
<p>For a long time, the canonical instrumental variable was rainfall, or more generally, the weather. However, the issue is that if the instrumental variable is correlated with other, potentially unobserved, variables, then they could be correlated with the variable of interest. This is a similar criticism to that above of propensity score matching. <span class="citation" data-cites="mellontakingourtoys">Mellon (<a href="99-references.html#ref-mellontakingourtoys" role="doc-biblioref">2023</a>)</span> found a large number of variables have been linked to weather in instrumental variable papers. It would seem that the likelihood of incorrectly estimated effects in some of them is quite high.</p>
<p>When considering an instrumental variable approach, you should spend considerable amounts of time on both of these assumptions. <span class="citation" data-cites="mellontakingourtoys">Mellon (<a href="99-references.html#ref-mellontakingourtoys" role="doc-biblioref">2023</a>)</span> shows that we are especially concerned that this particular tax rebate only affects income and no other variable, which could itself be linked with our variables of interest. Approaches based on instrumental variables provide extensive freedom for the researcher, and <span class="citation" data-cites="brodeurcookheyes">Brodeur, Cook, and Heyes (<a href="99-references.html#ref-brodeurcookheyes" role="doc-biblioref">2020</a>)</span> find they are more associated with p-hacking and selection reporting compared with RCTs and RDD. As with multiple-imputation, and propensity score matching, we recommend caution when using IV, and that it is never naively turned to. Indeed, <span class="citation" data-cites="betzcookhollenbach2018">Betz, Cook, and Hollenbach (<a href="99-references.html#ref-betzcookhollenbach2018" role="doc-biblioref">2018</a>)</span> go further and say that spatial instruments are rarely valid.</p>
</section>
</section>
<section id="exercises" class="level2" data-number="15.7">
<h2 data-number="15.7" class="anchored" data-anchor-id="exercises"><span class="header-section-number">15.7</span> Exercises</h2>
<section id="scales" class="level3 unnumbered">
<h3 class="unnumbered anchored" data-anchor-id="scales">Scales</h3>
<ol type="1">
<li><em>(Plan)</em> Consider the following scenario: <em>Two children will both look when an ambulance passes, but only the older one will look if a street car passes, and only the younger one will look when a bike passes.</em> Please sketch out what that dataset could look like and then sketch a graph that you could build to show all observations.</li>
<li><em>(Simulate)</em> Please further consider the scenario described and simulate the situation. Please include at least ten tests based on the simulated data.</li>
<li><em>(Acquire)</em> Please describe a possible source of such a dataset.</li>
<li><em>(Explore)</em> Please use <code>ggplot2</code> to build the graph that you sketched. Then use <code>rstanarm</code> to build a model.</li>
<li><em>(Communicate)</em> Please write two paragraphs about what you did.</li>
</ol>
</section>
<section id="questions" class="level3 unnumbered">
<h3 class="unnumbered anchored" data-anchor-id="questions">Questions</h3>
<ol type="1">
<li>What is the key assumption when using difference-in-differences?</li>
<li>Please read <span class="citation" data-cites="markupinsurance">Varner and Sankin (<a href="99-references.html#ref-markupinsurance" role="doc-biblioref">2020</a>)</span> and discuss: i) two statistical aspects; and ii) two ethical aspects.</li>
<li>Please go to the GitHub <a href="https://github.com/the-markup/investigation-allstates-algorithm">page</a> related to <span class="citation" data-cites="markupinsurance">Varner and Sankin (<a href="99-references.html#ref-markupinsurance" role="doc-biblioref">2020</a>)</span>. Please list two points about what is good, and another two points about what could be improved.</li>
<li>What are the fundamental features of regression discontinuity design and what are the conditions that are needed in order for regression discontinuity design to be able to be used?</li>
<li>What are some threats to the validity of regression discontinuity design estimates?</li>
<li>According to <span class="citation" data-cites="Meng2021What">Meng (<a href="99-references.html#ref-Meng2021What" role="doc-biblioref">2021</a>)</span> “Data science can persuade via<span class="math inline">\(\dots\)</span>” (pick all that apply):
<ol type="a">
<li>the careful establishment of evidence from fair-minded and high-quality data collection</li>
<li>processing and analysis</li>
<li>the honest interpretation and communication of findings</li>
<li>large sample sizes</li>
</ol></li>
<li>According to <span class="citation" data-cites="riedererdesignpatterns">Riederer (<a href="99-references.html#ref-riedererdesignpatterns" role="doc-biblioref">2021</a>)</span> if we have “disjoint treated and untreated groups partitioned by a sharp cut-off” then which method should we use to measure the local treatment effect at the juncture between groups (pick one)?
<ol type="a">
<li>regression discontinuity</li>
<li>matching</li>
<li>difference-in-differences</li>
<li>event study methods</li>
</ol></li>
<li>What does causal inference require according to <span class="citation" data-cites="riedererdesignpatterns">Riederer (<a href="99-references.html#ref-riedererdesignpatterns" role="doc-biblioref">2021</a>)</span> (pick all that apply)?
<ol type="a">
<li>data management</li>
<li>domain knowledge</li>
<li>probabilistic reasoning</li>
</ol></li>
<li>Consider an Australian 30-39 year old male living in Toronto with two children and a PhD. Which of the following do you think they would match most closely with and why (please explain in a paragraph or two)?
<ol type="a">
<li>An Australian 30-39 year old male living in Toronto with one child and a bachelors degree</li>
<li>A Canadian 30-39 year old male living in Toronto with one child and a PhD</li>
<li>An Australian 30-39 year old male living in Ottawa with one child and a PhD</li>
<li>A Canadian 18-29 year old male living in Toronto with one child and a PhD</li>
</ol></li>
<li>What is propensity score matching? If you were matching people, then what are some of the features that you would like to match on? What sort of ethical questions does collecting and storing such information raise for you? (Please write at least one paragraph for each question.)</li>
<li>Draw a DAG illustrating the collider bias described by <span class="citation" data-cites="bronnerftw">Bronner (<a href="99-references.html#ref-bronnerftw" role="doc-biblioref">2020</a>)</span>.</li>
<li><span class="citation" data-cites="NoiseKahneman">Kahneman, Sibony, and Sunstein (<a href="99-references.html#ref-NoiseKahneman" role="doc-biblioref">2021</a>)</span> say “<span class="math inline">\(\dots\)</span>while correlation does not imply causation, causation does imply correlation. Where there is a causal link, we should find a correlation”. With reference to <span class="citation" data-cites="Cunningham2021">Cunningham (<a href="99-references.html#ref-Cunningham2021" role="doc-biblioref">2021, chap. 1</a>)</span>, are they right or wrong, and why?</li>
</ol>
</section>
<section id="tutorial" class="level3 unnumbered">
<h3 class="unnumbered anchored" data-anchor-id="tutorial">Tutorial</h3>
<p>You are interested in the characteristics of people’s friendship groups and how those characteristics relate to individual-level outcomes, particularly economic measures.</p>
<p>You have access to individual-level data from a social media website, which contains information about social interactions (comments on posts, tags, etc) on the website, as well as a wide variety of individual-level characteristics.</p>
<ol type="1">
<li>While the social media website is very popular, not everyone in the population you are interested in has an account, and not everyone that has an account is active on the website. Given you are interested in economic measures, what are some possible issues with using these data to make inferences about the broader population?</li>
<li>The data do not contain information on individual-level income. But for around 20 per cent of the sample you have information on the “census block” of the individual. By way of background, a census block contains no more than 3,000 individuals. The median income of each census block is known. As such, you decide to estimate individual-level income as follows:
<ol type="a">
<li>Regress the median income of each census block on a series of individual level characteristics (such as age, education, marital status, gender, <span class="math inline">\(\dots\)</span>).</li>
<li>Use these estimates to predict the income of individuals that do not have location information. Briefly discuss the advantages and disadvantages of this approach, particularly in how it could affect the study of income characteristics of friendship groups. Ensure that you address the ecological fallacy.</li>
</ol></li>
<li>Understandably, the social media website will not allow the unfettered distribution of individual-level data. What are some ways in which you might nonetheless enhance the reproducibility of your work?</li>
</ol>
<p>This should take at least two pages.</p>


<div id="refs" class="references csl-bib-body hanging-indent" data-entry-spacing="0" role="list" style="display: none">
<div id="ref-alexander2018age" class="csl-entry" role="listitem">
Alexander, Rohan, and Zachary Ward. 2018. <span>“Age at Arrival and Assimilation During the Age of Mass Migration.”</span> <em>The Journal of Economic History</em> 78 (3): 904–37. <a href="https://doi.org/10.1017/S0022050718000335">https://doi.org/10.1017/S0022050718000335</a>.
</div>
<div id="ref-angelucci2019newspapers" class="csl-entry" role="listitem">
Angelucci, Charles, and Julia Cagé. 2019. <span>“Newspapers in Times of Low Advertising Revenues.”</span> <em>American Economic Journal: Microeconomics</em> 11 (3): 319–64. <a href="https://doi.org/10.1257/mic.20170306">https://doi.org/10.1257/mic.20170306</a>.
</div>
<div id="ref-angristkrueger" class="csl-entry" role="listitem">
Angrist, Joshua, and Alan Krueger. 2001. <span>“Instrumental Variables and the Search for Identification: From Supply and Demand to Natural Experiments.”</span> <em>Journal of Economic Perspectives</em> 15 (4): 69–85. <a href="https://doi.org/10.1257/jep.15.4.69">https://doi.org/10.1257/jep.15.4.69</a>.
</div>
<div id="ref-citemodelsummary" class="csl-entry" role="listitem">
Arel-Bundock, Vincent. 2022. <span>“<span class="nocase">modelsummary</span>: Data and Model Summaries in <span>R</span>.”</span> <em>Journal of Statistical Software</em> 103 (1): 1–23. <a href="https://doi.org/10.18637/jss.v103.i01">https://doi.org/10.18637/jss.v103.i01</a>.
</div>
<div id="ref-citeberkson" class="csl-entry" role="listitem">
Berkson, Joseph. 1946. <span>“Limitations of the Application of Fourfold Table Analysis to Hospital Data.”</span> <em>Biometrics Bulletin</em> 2 (3): 47–53. <a href="https://doi.org/10.2307/3002000">https://doi.org/10.2307/3002000</a>.
</div>
<div id="ref-betzcookhollenbach2018" class="csl-entry" role="listitem">
Betz, Timm, Scott Cook, and Florian Hollenbach. 2018. <span>“On the Use and Abuse of Spatial Instruments.”</span> <em>Political Analysis</em> 26 (4): 474–79. <a href="https://doi.org/10.1017/pan.2018.10">https://doi.org/10.1017/pan.2018.10</a>.
</div>
<div id="ref-bickel1975sex" class="csl-entry" role="listitem">
Bickel, Peter, Eugene Hammel, and William O’Connell. 1975. <span>“Sex Bias in Graduate Admissions: Data from Berkeley: Measuring Bias Is Harder Than Is Usually Assumed, and the Evidence Is Sometimes Contrary to Expectation.”</span> <em>Science</em> 187 (4175): 398–404. <a href="https://doi.org/10.1126/science.187.4175.398">https://doi.org/10.1126/science.187.4175.398</a>.
</div>
<div id="ref-estimatr" class="csl-entry" role="listitem">
Blair, Graeme, Jasper Cooper, Alexander Coppock, Macartan Humphreys, and Luke Sonnet. 2021. <em><span class="nocase">estimatr: Fast Estimators for Design-Based Inference</span></em>. <a href="https://CRAN.R-project.org/package=estimatr">https://CRAN.R-project.org/package=estimatr</a>.
</div>
<div id="ref-bloombellreiman2020" class="csl-entry" role="listitem">
Bloom, Howard, Andrew Bell, and Kayla Reiman. 2020. <span>“Using Data from Randomized Trials to Assess the Likely Generalizability of Educational Treatment-Effect Estimates from Regression Discontinuity Designs.”</span> <em>Journal of Research on Educational Effectiveness</em> 13 (3): 488–517. <a href="https://doi.org/10.1080/19345747.2019.1634169">https://doi.org/10.1080/19345747.2019.1634169</a>.
</div>
<div id="ref-mixedbroom" class="csl-entry" role="listitem">
Bolker, Ben, and David Robinson. 2022. <em><span class="nocase">broom.mixed: Tidying Methods for Mixed Models</span></em>. <a href="https://CRAN.R-project.org/package=broom.mixed">https://CRAN.R-project.org/package=broom.mixed</a>.
</div>
<div id="ref-brodeurcookheyes" class="csl-entry" role="listitem">
Brodeur, Abel, Nikolai Cook, and Anthony Heyes. 2020. <span>“<span class="nocase">Methods Matter: p-Hacking and Publication Bias in Causal Analysis in Economics</span>.”</span> <em>American Economic Review</em> 110 (11): 3634–60. <a href="https://doi.org/10.1257/aer.20190687">https://doi.org/10.1257/aer.20190687</a>.
</div>
<div id="ref-bronnerftw" class="csl-entry" role="listitem">
Bronner, Laura. 2020. <span>“Why Statistics Don’t Capture the Full Extent of the Systemic Bias in Policing.”</span> <em>FiveThirtyEight</em>, June. <a href="https://fivethirtyeight.com/features/why-statistics-dont-capture-the-full-extent-of-the-systemic-bias-in-policing/">https://fivethirtyeight.com/features/why-statistics-dont-capture-the-full-extent-of-the-systemic-bias-in-policing/</a>.
</div>
<div id="ref-rdrobust" class="csl-entry" role="listitem">
Calonico, Sebastian, Matias Cattaneo, Max Farrell, and Rocio Titiunik. 2021. <em><span class="nocase">rdrobust: Robust Data-Driven Statistical Inference in Regression-Discontinuity Designs</span></em>. <a href="https://CRAN.R-project.org/package=rdrobust">https://CRAN.R-project.org/package=rdrobust</a>.
</div>
<div id="ref-carpenterdobkinreplicationdata" class="csl-entry" role="listitem">
Carpenter, Christopher, and Carlos Dobkin. 2014. <span>“<span class="nocase">Replication data for: The Minimum Legal Drinking Age and Crime</span>.”</span> <a href="https://doi.org/10.7910/DVN/27070">https://doi.org/10.7910/DVN/27070</a>.
</div>
<div id="ref-carpenterdobkin" class="csl-entry" role="listitem">
———. 2015. <span>“<span class="nocase">The Minimum Legal Drinking Age and Crime</span>.”</span> <em>The Review of Economics and Statistics</em> 97 (2): 521–24. <a href="https://doi.org/10.1162/REST_a_00489">https://doi.org/10.1162/REST_a_00489</a>.
</div>
<div id="ref-caugheysekhon2011" class="csl-entry" role="listitem">
Caughey, Devin, and Jasjeet Sekhon. 2011. <span>“<span class="nocase">Elections and the Regression Discontinuity Design: Lessons from Close U.S. House Races, 1942–2008</span>.”</span> <em>Political Analysis</em> 19 (4): 385–408. <a href="https://doi.org/10.1093/pan/mpr032">https://doi.org/10.1093/pan/mpr032</a>.
</div>
<div id="ref-vomaxpaper" class="csl-entry" role="listitem">
Coyle, Edward, Andrew Coggan, Mari Hopper, and Thomas Walters. 1988. <span>“<span class="nocase">Determinants of Endurance in Well-Trained Cyclists</span>.”</span> <em>Journal of Applied Physiology</em> 64 (6): 2622–30. <a href="https://doi.org/10.1152/jappl.1988.64.6.2622">https://doi.org/10.1152/jappl.1988.64.6.2622</a>.
</div>
<div id="ref-Cunningham2021" class="csl-entry" role="listitem">
Cunningham, Scott. 2021. <em>Causal Inference: The Mixtape</em>. 1st ed. New Haven: Yale Press. <a href="https://mixtape.scunning.com">https://mixtape.scunning.com</a>.
</div>
<div id="ref-dagan2021bnt162b2" class="csl-entry" role="listitem">
Dagan, Noa, Noam Barda, Eldad Kepten, Oren Miron, Shay Perchik, Mark Katz, Miguel Hernán, Marc Lipsitch, Ben Reis, and Ran Balicer. 2021. <span>“BNT162b2 mRNA Covid-19 Vaccine in a Nationwide Mass Vaccination Setting.”</span> <em>New England Journal of Medicine</em> 384 (15): 1412–23. <a href="https://doi.org/10.1056/NEJMoa2101765">https://doi.org/10.1056/NEJMoa2101765</a>.
</div>
<div id="ref-gelmanonrdd" class="csl-entry" role="listitem">
Gelman, Andrew. 2019. <span>“Another Regression Discontinuity Disaster and What Can We Learn from It,”</span> June. <a href="https://statmodeling.stat.columbia.edu/2019/06/25/another-regression-discontinuity-disaster-and-what-can-we-learn-from-it/">https://statmodeling.stat.columbia.edu/2019/06/25/another-regression-discontinuity-disaster-and-what-can-we-learn-from-it/</a>.
</div>
<div id="ref-gelmanandhill" class="csl-entry" role="listitem">
Gelman, Andrew, and Jennifer Hill. 2007. <em>Data Analysis Using Regression and Multilevel/Hierarchical Models</em>. 1st ed. Cambridge University Press.
</div>
<div id="ref-gelmanimbensrdd" class="csl-entry" role="listitem">
Gelman, Andrew, and Guido Imbens. 2019. <span>“Why High-Order Polynomials Should Not Be Used in Regression Discontinuity Designs.”</span> <em>Journal of Business &amp; Economic Statistics</em> 37 (3): 447–56. <a href="https://doi.org/10.1080/07350015.2017.1366909">https://doi.org/10.1080/07350015.2017.1366909</a>.
</div>
<div id="ref-citerstanarm" class="csl-entry" role="listitem">
Goodrich, Ben, Jonah Gabry, Imad Ali, and Sam Brilleman. 2023. <span>“<span class="nocase">rstanarm: <span>Bayesian</span> applied regression modeling via <span>Stan</span></span>.”</span> <a href="https://mc-stan.org/rstanarm">https://mc-stan.org/rstanarm</a>.
</div>
<div id="ref-green2009testing" class="csl-entry" role="listitem">
Green, Donald, Terence Leong, Holger Kern, Alan Gerber, and Christopher Larimer. 2009. <span>“Testing the Accuracy of Regression Discontinuity Analysis Using Experimental Benchmarks.”</span> <em>Political Analysis</em> 17 (4): 400–417. <a href="https://doi.org/10.1093/pan/mpp018">https://doi.org/10.1093/pan/mpp018</a>.
</div>
<div id="ref-omggreifer" class="csl-entry" role="listitem">
Greifer, Noah. 2021. <span>“Why Do We Do Matching for Causal Inference Vs Regressing on Confounders?”</span> <em>Cross Validated</em>, September. <a href="https://stats.stackexchange.com/q/544958">https://stats.stackexchange.com/q/544958</a>.
</div>
<div id="ref-Hernn2011" class="csl-entry" role="listitem">
Hernán, Miguel, David Clayton, and Niels Keiding. 2011. <span>“The Simpson’s Paradox Unraveled.”</span> <em>International Journal of Epidemiology</em> 40 (3): 780–85. <a href="https://doi.org/10.1093/ije/dyr041">https://doi.org/10.1093/ije/dyr041</a>.
</div>
<div id="ref-MatchIt" class="csl-entry" role="listitem">
Ho, Daniel, Kosuke Imai, Gary King, and Elizabeth Stuart. 2011. <span>“<span>MatchIt</span>: Nonparametric Preprocessing for Parametric Causal Inference.”</span> <em>Journal of Statistical Software</em> 42 (8): 1–28. <a href="https://doi.org/10.18637/jss.v042.i08">https://doi.org/10.18637/jss.v042.i08</a>.
</div>
<div id="ref-palmerpenguins" class="csl-entry" role="listitem">
Horst, Allison Marie, Alison Presmanes Hill, and Kristen Gorman. 2020. <em><span class="nocase">palmerpenguins: Palmer Archipelago (Antarctica) penguin data</span></em>. <a href="https://doi.org/10.5281/zenodo.3960218">https://doi.org/10.5281/zenodo.3960218</a>.
</div>
<div id="ref-theeffect" class="csl-entry" role="listitem">
Huntington-Klein, Nick. 2021. <em>The Effect: An Introduction to Research Design and Causality</em>. 1st ed. Chapman &amp; Hall. <a href="https://theeffectbook.net">https://theeffectbook.net</a>.
</div>
<div id="ref-NoiseKahneman" class="csl-entry" role="listitem">
Kahneman, Daniel, Olivier Sibony, and Cass Sunstein. 2021. <em>Noise: A Flaw in Human Judgment</em>. William Collins.
</div>
<div id="ref-king2019propensity" class="csl-entry" role="listitem">
King, Gary, and Richard Nielsen. 2019. <span>“Why Propensity Scores Should Not Be Used for Matching.”</span> <em>Political Analysis</em> 27 (4): 435–54. <a href="https://doi.org/10.1017/pan.2019.11">https://doi.org/10.1017/pan.2019.11</a>.
</div>
<div id="ref-mckenzieforthedefence" class="csl-entry" role="listitem">
McKenzie, David. 2021. <span>“<span class="nocase">What Do You Need To Do To Make A Matching Estimator Convincing? Rhetorical vs Statistical Checks</span>.”</span> <em>World Bank Blogs—Development Impact</em>, February. <a href="https://blogs.worldbank.org/impactevaluations/what-do-you-need-do-make-matching-estimator-convincing-rhetorical-vs-statistical">https://blogs.worldbank.org/impactevaluations/what-do-you-need-do-make-matching-estimator-convincing-rhetorical-vs-statistical</a>.
</div>
<div id="ref-mellontakingourtoys" class="csl-entry" role="listitem">
Mellon, Jonathan. 2023. <span>“Rain, Rain, Go Away: 195 Potential Exclusion-Restriction Violations for Studies Using Weather as an Instrumental Variable.”</span> SocArXiv. <a href="https://doi.org/10.31235/osf.io/9qj4f">https://doi.org/10.31235/osf.io/9qj4f</a>.
</div>
<div id="ref-Meng2021What" class="csl-entry" role="listitem">
Meng, Xiao-Li. 2021. <span>“What Are the Values of Data, Data Science, or Data Scientists?”</span> <em>Harvard Data Science Review</em> 3 (1). <a href="https://doi.org/10.1162/99608f92.ee717cf7">https://doi.org/10.1162/99608f92.ee717cf7</a>.
</div>
<div id="ref-anothernicevomaxpaper" class="csl-entry" role="listitem">
Podlogar, Tim, Peter Leo, and James Spragg. 2022. <span>“<span class="nocase">Using VO2max as a marker of training status in athletes—Can we do better?</span>”</span> <em>Journal of Applied Physiology</em> 133 (6): 144–47. <a href="https://doi.org/10.1152/japplphysiol.00723.2021">https://doi.org/10.1152/japplphysiol.00723.2021</a>.
</div>
<div id="ref-citeR" class="csl-entry" role="listitem">
R Core Team. 2023. <em>R: A Language and Environment for Statistical Computing</em>. Vienna, Austria: R Foundation for Statistical Computing. <a href="https://www.R-project.org/">https://www.R-project.org/</a>.
</div>
<div id="ref-riedererdesignpatterns" class="csl-entry" role="listitem">
Riederer, Emily. 2021. <span>“Causal Design Patterns for Data Analysts,”</span> January. <a href="https://emilyriederer.netlify.app/post/causal-design-patterns/">https://emilyriederer.netlify.app/post/causal-design-patterns/</a>.
</div>
<div id="ref-broom" class="csl-entry" role="listitem">
Robinson, David, Alex Hayes, and Simon Couch. 2022. <em><span class="nocase">broom: Convert Statistical Objects into Tidy Tibbles</span></em>. <a href="https://CRAN.R-project.org/package=broom">https://CRAN.R-project.org/package=broom</a>.
</div>
<div id="ref-sekhon2017understanding" class="csl-entry" role="listitem">
Sekhon, Jasjeet, and Rocío Titiunik. 2017. <span>“Understanding Regression Discontinuity Designs as Observational Studies.”</span> <em>Observational Studies</em> 3 (2): 174–82. <a href="https://doi.org/10.1353/obs.2017.0005">https://doi.org/10.1353/obs.2017.0005</a>.
</div>
<div id="ref-simpson1951interpretation" class="csl-entry" role="listitem">
Simpson, Edward. 1951. <span>“The Interpretation of Interaction in Contingency Tables.”</span> <em>Journal of the Royal Statistical Society: Series B (Methodological)</em> 13 (2): 238–41. <a href="https://doi.org/10.1111/j.2517-6161.1951.tb00088.x">https://doi.org/10.1111/j.2517-6161.1951.tb00088.x</a>.
</div>
<div id="ref-stock2003retrospectives" class="csl-entry" role="listitem">
Stock, James, and Francesco Trebbi. 2003. <span>“Retrospectives: Who Invented Instrumental Variable Regression?”</span> <em>Journal of Economic Perspectives</em> 17 (3): 177–94. <a href="https://doi.org/10.1257/089533003769204416">https://doi.org/10.1257/089533003769204416</a>.
</div>
<div id="ref-stommessaysno" class="csl-entry" role="listitem">
Stommes, Drew, P. M. Aronow, and Fredrik Sävje. 2023. <span>“On the Reliability of Published Findings Using the Regression Discontinuity Design in Political Science.”</span> <em>Research &amp; Politics</em> 10 (2). https://doi.org/<a href="https://doi.org/10.1177/2053168023116645">https://doi.org/10.1177/2053168023116645</a>.
</div>
<div id="ref-taddy2019" class="csl-entry" role="listitem">
Taddy, Matt. 2019. <em>Business Data Science</em>. 1st ed. McGraw Hill.
</div>
<div id="ref-Tang2015" class="csl-entry" role="listitem">
Tang, John. 2015. <span>“<span class="nocase">Pollution havens and the trade in toxic chemicals: Evidence from U.S. trade flows</span>.”</span> <em>Ecological Economics</em> 112 (April): 150–60. <a href="https://doi.org/10.1016/j.ecolecon.2015.02.022">https://doi.org/10.1016/j.ecolecon.2015.02.022</a>.
</div>
<div id="ref-thistlethwaite1960regression" class="csl-entry" role="listitem">
Thistlethwaite, Donald, and Donald Campbell. 1960. <span>“Regression-Discontinuity Analysis: An Alternative to the Ex Post Facto Experiment.”</span> <em>Journal of Educational Psychology</em> 51 (6): 309–17. <a href="https://doi.org/10.1037/h0044319">https://doi.org/10.1037/h0044319</a>.
</div>
<div id="ref-markupinsurance" class="csl-entry" role="listitem">
Varner, Maddy, and Aaron Sankin. 2020. <span>“Suckers List: How Allstate’s Secret Auto Insurance Algorithm Squeezes Big Spenders.”</span> <em>The Markup</em>, February. <a href="https://themarkup.org/allstates-algorithm/2020/02/25/car-insurance-suckers-list">https://themarkup.org/allstates-algorithm/2020/02/25/car-insurance-suckers-list</a>.
</div>
<div id="ref-tidyverse" class="csl-entry" role="listitem">
Wickham, Hadley, Mara Averick, Jenny Bryan, Winston Chang, Lucy D’Agostino McGowan, Romain François, Garrett Grolemund, et al. 2019. <span>“<span class="nocase">Welcome to the Tidyverse</span>.”</span> <em>Journal of Open Source Software</em> 4 (43): 1686. <a href="https://doi.org/10.21105/joss.01686">https://doi.org/10.21105/joss.01686</a>.
</div>
<div id="ref-citehaven" class="csl-entry" role="listitem">
Wickham, Hadley, Evan Miller, and Danny Smith. 2023. <em><span class="nocase">haven: Import and Export <span>“SPSS”</span> <span>“Stata”</span> and <span>“SAS”</span> Files</span></em>. <a href="https://CRAN.R-project.org/package=haven">https://CRAN.R-project.org/package=haven</a>.
</div>
<div id="ref-scales" class="csl-entry" role="listitem">
Wickham, Hadley, and Dana Seidel. 2022. <em><span class="nocase">scales: Scale Functions for Visualization</span></em>. <a href="https://CRAN.R-project.org/package=scales">https://CRAN.R-project.org/package=scales</a>.
</div>
<div id="ref-wright1928tariff" class="csl-entry" role="listitem">
Wright, Philip. 1928. <em>The Tariff on Animal and Vegetable Oils</em>. New York: Macmillan Company.
</div>
<div id="ref-citeknitr" class="csl-entry" role="listitem">
Xie, Yihui. 2023. <em><span class="nocase">knitr: A General-Purpose Package for Dynamic Report Generation in R</span></em>. <a href="https://yihui.org/knitr/">https://yihui.org/knitr/</a>.
</div>
</div>
</section>
</section>

</main> <!-- /main -->
<script id="quarto-html-after-body" type="application/javascript">
window.document.addEventListener("DOMContentLoaded", function (event) {
  const toggleBodyColorMode = (bsSheetEl) => {
    const mode = bsSheetEl.getAttribute("data-mode");
    const bodyEl = window.document.querySelector("body");
    if (mode === "dark") {
      bodyEl.classList.add("quarto-dark");
      bodyEl.classList.remove("quarto-light");
    } else {
      bodyEl.classList.add("quarto-light");
      bodyEl.classList.remove("quarto-dark");
    }
  }
  const toggleBodyColorPrimary = () => {
    const bsSheetEl = window.document.querySelector("link#quarto-bootstrap");
    if (bsSheetEl) {
      toggleBodyColorMode(bsSheetEl);
    }
  }
  toggleBodyColorPrimary();  
  const icon = "";
  const anchorJS = new window.AnchorJS();
  anchorJS.options = {
    placement: 'right',
    icon: icon
  };
  anchorJS.add('.anchored');
  const isCodeAnnotation = (el) => {
    for (const clz of el.classList) {
      if (clz.startsWith('code-annotation-')) {                     
        return true;
      }
    }
    return false;
  }
  const clipboard = new window.ClipboardJS('.code-copy-button', {
    text: function(trigger) {
      const codeEl = trigger.previousElementSibling.cloneNode(true);
      for (const childEl of codeEl.children) {
        if (isCodeAnnotation(childEl)) {
          childEl.remove();
        }
      }
      return codeEl.innerText;
    }
  });
  clipboard.on('success', function(e) {
    // button target
    const button = e.trigger;
    // don't keep focus
    button.blur();
    // flash "checked"
    button.classList.add('code-copy-button-checked');
    var currentTitle = button.getAttribute("title");
    button.setAttribute("title", "Copied!");
    let tooltip;
    if (window.bootstrap) {
      button.setAttribute("data-bs-toggle", "tooltip");
      button.setAttribute("data-bs-placement", "left");
      button.setAttribute("data-bs-title", "Copied!");
      tooltip = new bootstrap.Tooltip(button, 
        { trigger: "manual", 
          customClass: "code-copy-button-tooltip",
          offset: [0, -8]});
      tooltip.show();    
    }
    setTimeout(function() {
      if (tooltip) {
        tooltip.hide();
        button.removeAttribute("data-bs-title");
        button.removeAttribute("data-bs-toggle");
        button.removeAttribute("data-bs-placement");
      }
      button.setAttribute("title", currentTitle);
      button.classList.remove('code-copy-button-checked');
    }, 1000);
    // clear code selection
    e.clearSelection();
  });
    var localhostRegex = new RegExp(/^(?:http|https):\/\/localhost\:?[0-9]*\//);
    var mailtoRegex = new RegExp(/^mailto:/);
      var filterRegex = new RegExp("https:\/\/tellingstorieswithdata\.com");
    var isInternal = (href) => {
        return filterRegex.test(href) || localhostRegex.test(href) || mailtoRegex.test(href);
    }
    // Inspect non-navigation links and adorn them if external
 	var links = window.document.querySelectorAll('a[href]:not(.nav-link):not(.navbar-brand):not(.toc-action):not(.sidebar-link):not(.sidebar-item-toggle):not(.pagination-link):not(.no-external):not([aria-hidden]):not(.dropdown-item):not(.quarto-navigation-tool)');
    for (var i=0; i<links.length; i++) {
      const link = links[i];
      if (!isInternal(link.href)) {
        // undo the damage that might have been done by quarto-nav.js in the case of
        // links that we want to consider external
        if (link.dataset.originalHref !== undefined) {
          link.href = link.dataset.originalHref;
        }
      }
    }
  function tippyHover(el, contentFn, onTriggerFn, onUntriggerFn) {
    const config = {
      allowHTML: true,
      maxWidth: 500,
      delay: 100,
      arrow: false,
      appendTo: function(el) {
          return el.parentElement;
      },
      interactive: true,
      interactiveBorder: 10,
      theme: 'quarto',
      placement: 'bottom-start',
    };
    if (contentFn) {
      config.content = contentFn;
    }
    if (onTriggerFn) {
      config.onTrigger = onTriggerFn;
    }
    if (onUntriggerFn) {
      config.onUntrigger = onUntriggerFn;
    }
    window.tippy(el, config); 
  }
  const noterefs = window.document.querySelectorAll('a[role="doc-noteref"]');
  for (var i=0; i<noterefs.length; i++) {
    const ref = noterefs[i];
    tippyHover(ref, function() {
      // use id or data attribute instead here
      let href = ref.getAttribute('data-footnote-href') || ref.getAttribute('href');
      try { href = new URL(href).hash; } catch {}
      const id = href.replace(/^#\/?/, "");
      const note = window.document.getElementById(id);
      if (note) {
        return note.innerHTML;
      } else {
        return "";
      }
    });
  }
  const xrefs = window.document.querySelectorAll('a.quarto-xref');
  const processXRef = (id, note) => {
    // Strip column container classes
    const stripColumnClz = (el) => {
      el.classList.remove("page-full", "page-columns");
      if (el.children) {
        for (const child of el.children) {
          stripColumnClz(child);
        }
      }
    }
    stripColumnClz(note)
    if (id === null || id.startsWith('sec-')) {
      // Special case sections, only their first couple elements
      const container = document.createElement("div");
      if (note.children && note.children.length > 2) {
        container.appendChild(note.children[0].cloneNode(true));
        for (let i = 1; i < note.children.length; i++) {
          const child = note.children[i];
          if (child.tagName === "P" && child.innerText === "") {
            continue;
          } else {
            container.appendChild(child.cloneNode(true));
            break;
          }
        }
        if (window.Quarto?.typesetMath) {
          window.Quarto.typesetMath(container);
        }
        return container.innerHTML
      } else {
        if (window.Quarto?.typesetMath) {
          window.Quarto.typesetMath(note);
        }
        return note.innerHTML;
      }
    } else {
      // Remove any anchor links if they are present
      const anchorLink = note.querySelector('a.anchorjs-link');
      if (anchorLink) {
        anchorLink.remove();
      }
      if (window.Quarto?.typesetMath) {
        window.Quarto.typesetMath(note);
      }
      // TODO in 1.5, we should make sure this works without a callout special case
      if (note.classList.contains("callout")) {
        return note.outerHTML;
      } else {
        return note.innerHTML;
      }
    }
  }
  for (var i=0; i<xrefs.length; i++) {
    const xref = xrefs[i];
    tippyHover(xref, undefined, function(instance) {
      instance.disable();
      let url = xref.getAttribute('href');
      let hash = undefined; 
      if (url.startsWith('#')) {
        hash = url;
      } else {
        try { hash = new URL(url).hash; } catch {}
      }
      if (hash) {
        const id = hash.replace(/^#\/?/, "");
        const note = window.document.getElementById(id);
        if (note !== null) {
          try {
            const html = processXRef(id, note.cloneNode(true));
            instance.setContent(html);
          } finally {
            instance.enable();
            instance.show();
          }
        } else {
          // See if we can fetch this
          fetch(url.split('#')[0])
          .then(res => res.text())
          .then(html => {
            const parser = new DOMParser();
            const htmlDoc = parser.parseFromString(html, "text/html");
            const note = htmlDoc.getElementById(id);
            if (note !== null) {
              const html = processXRef(id, note);
              instance.setContent(html);
            } 
          }).finally(() => {
            instance.enable();
            instance.show();
          });
        }
      } else {
        // See if we can fetch a full url (with no hash to target)
        // This is a special case and we should probably do some content thinning / targeting
        fetch(url)
        .then(res => res.text())
        .then(html => {
          const parser = new DOMParser();
          const htmlDoc = parser.parseFromString(html, "text/html");
          const note = htmlDoc.querySelector('main.content');
          if (note !== null) {
            // This should only happen for chapter cross references
            // (since there is no id in the URL)
            // remove the first header
            if (note.children.length > 0 && note.children[0].tagName === "HEADER") {
              note.children[0].remove();
            }
            const html = processXRef(null, note);
            instance.setContent(html);
          } 
        }).finally(() => {
          instance.enable();
          instance.show();
        });
      }
    }, function(instance) {
    });
  }
      let selectedAnnoteEl;
      const selectorForAnnotation = ( cell, annotation) => {
        let cellAttr = 'data-code-cell="' + cell + '"';
        let lineAttr = 'data-code-annotation="' +  annotation + '"';
        const selector = 'span[' + cellAttr + '][' + lineAttr + ']';
        return selector;
      }
      const selectCodeLines = (annoteEl) => {
        const doc = window.document;
        const targetCell = annoteEl.getAttribute("data-target-cell");
        const targetAnnotation = annoteEl.getAttribute("data-target-annotation");
        const annoteSpan = window.document.querySelector(selectorForAnnotation(targetCell, targetAnnotation));
        const lines = annoteSpan.getAttribute("data-code-lines").split(",");
        const lineIds = lines.map((line) => {
          return targetCell + "-" + line;
        })
        let top = null;
        let height = null;
        let parent = null;
        if (lineIds.length > 0) {
            //compute the position of the single el (top and bottom and make a div)
            const el = window.document.getElementById(lineIds[0]);
            top = el.offsetTop;
            height = el.offsetHeight;
            parent = el.parentElement.parentElement;
          if (lineIds.length > 1) {
            const lastEl = window.document.getElementById(lineIds[lineIds.length - 1]);
            const bottom = lastEl.offsetTop + lastEl.offsetHeight;
            height = bottom - top;
          }
          if (top !== null && height !== null && parent !== null) {
            // cook up a div (if necessary) and position it 
            let div = window.document.getElementById("code-annotation-line-highlight");
            if (div === null) {
              div = window.document.createElement("div");
              div.setAttribute("id", "code-annotation-line-highlight");
              div.style.position = 'absolute';
              parent.appendChild(div);
            }
            div.style.top = top - 2 + "px";
            div.style.height = height + 4 + "px";
            div.style.left = 0;
            let gutterDiv = window.document.getElementById("code-annotation-line-highlight-gutter");
            if (gutterDiv === null) {
              gutterDiv = window.document.createElement("div");
              gutterDiv.setAttribute("id", "code-annotation-line-highlight-gutter");
              gutterDiv.style.position = 'absolute';
              const codeCell = window.document.getElementById(targetCell);
              const gutter = codeCell.querySelector('.code-annotation-gutter');
              gutter.appendChild(gutterDiv);
            }
            gutterDiv.style.top = top - 2 + "px";
            gutterDiv.style.height = height + 4 + "px";
          }
          selectedAnnoteEl = annoteEl;
        }
      };
      const unselectCodeLines = () => {
        const elementsIds = ["code-annotation-line-highlight", "code-annotation-line-highlight-gutter"];
        elementsIds.forEach((elId) => {
          const div = window.document.getElementById(elId);
          if (div) {
            div.remove();
          }
        });
        selectedAnnoteEl = undefined;
      };
        // Handle positioning of the toggle
    window.addEventListener(
      "resize",
      throttle(() => {
        elRect = undefined;
        if (selectedAnnoteEl) {
          selectCodeLines(selectedAnnoteEl);
        }
      }, 10)
    );
    function throttle(fn, ms) {
    let throttle = false;
    let timer;
      return (...args) => {
        if(!throttle) { // first call gets through
            fn.apply(this, args);
            throttle = true;
        } else { // all the others get throttled
            if(timer) clearTimeout(timer); // cancel #2
            timer = setTimeout(() => {
              fn.apply(this, args);
              timer = throttle = false;
            }, ms);
        }
      };
    }
      // Attach click handler to the DT
      const annoteDls = window.document.querySelectorAll('dt[data-target-cell]');
      for (const annoteDlNode of annoteDls) {
        annoteDlNode.addEventListener('click', (event) => {
          const clickedEl = event.target;
          if (clickedEl !== selectedAnnoteEl) {
            unselectCodeLines();
            const activeEl = window.document.querySelector('dt[data-target-cell].code-annotation-active');
            if (activeEl) {
              activeEl.classList.remove('code-annotation-active');
            }
            selectCodeLines(clickedEl);
            clickedEl.classList.add('code-annotation-active');
          } else {
            // Unselect the line
            unselectCodeLines();
            clickedEl.classList.remove('code-annotation-active');
          }
        });
      }
  const findCites = (el) => {
    const parentEl = el.parentElement;
    if (parentEl) {
      const cites = parentEl.dataset.cites;
      if (cites) {
        return {
          el,
          cites: cites.split(' ')
        };
      } else {
        return findCites(el.parentElement)
      }
    } else {
      return undefined;
    }
  };
  var bibliorefs = window.document.querySelectorAll('a[role="doc-biblioref"]');
  for (var i=0; i<bibliorefs.length; i++) {
    const ref = bibliorefs[i];
    const citeInfo = findCites(ref);
    if (citeInfo) {
      tippyHover(citeInfo.el, function() {
        var popup = window.document.createElement('div');
        citeInfo.cites.forEach(function(cite) {
          var citeDiv = window.document.createElement('div');
          citeDiv.classList.add('hanging-indent');
          citeDiv.classList.add('csl-entry');
          var biblioDiv = window.document.getElementById('ref-' + cite);
          if (biblioDiv) {
            citeDiv.innerHTML = biblioDiv.innerHTML;
          }
          popup.appendChild(citeDiv);
        });
        return popup.innerHTML;
      });
    }
  }
});
</script>
<nav class="page-navigation">
  <div class="nav-page nav-page-previous">
      <a href="./13-prediction.html" class="pagination-link" aria-label="Prediction">
        <i class="bi bi-arrow-left-short"></i> <span class="nav-page-text"><span class="chapter-number">14</span>&nbsp; <span class="chapter-title">Prediction</span></span>
      </a>          
  </div>
  <div class="nav-page nav-page-next">
      <a href="./15-mrp.html" class="pagination-link" aria-label="Multilevel regression with post-stratification">
        <span class="nav-page-text"><span class="chapter-number">16</span>&nbsp; <span class="chapter-title">Multilevel regression with post-stratification</span></span> <i class="bi bi-arrow-right-short"></i>
      </a>
  </div>
</nav>
</div> <!-- /content -->




<footer class="footer"><div class="nav-footer"><div class="nav-footer-center"><div class="toc-actions d-sm-block d-md-none"><ul><li><a href="https://github.com/RohanAlexander/telling_stories/edit/main/14-causality_from_obs.qmd" class="toc-action"><i class="bi bi-github"></i>Edit this page</a></li></ul></div></div></div></footer></body></html>